/**
 * Embed markdown files into a generated TypeScript module.
 * The roadmap API imports this module — no filesystem reads at runtime.
 *
 * On Railway, the repo root files (docs/, 02-requirements/) are not available
 * because Root Directory = app/. So we commit the generated file to git.
 * Locally, this script regenerates it from the source markdown files.
 */
import { readFileSync, writeFileSync, mkdirSync, existsSync } from 'fs'
import { resolve, join } from 'path'

const appDir = process.cwd()
const outDir = join(appDir, 'src', 'generated')
const outFile = join(outDir, 'roadmap-data.ts')

mkdirSync(outDir, { recursive: true })

const candidates = [
  join(appDir, '..', 'docs', 'VERSIONING.md'),
  join(appDir, 'docs', 'VERSIONING.md'),
]

const backlogCandidates = [
  join(appDir, '..', '02-requirements', 'backlog.md'),
  join(appDir, '02-requirements', 'backlog.md'),
]

function findAndRead(paths, label) {
  for (const p of paths) {
    if (existsSync(p)) {
      console.log(`[roadmap] Found ${label}: ${p}`)
      return readFileSync(p, 'utf-8')
    }
  }
  console.warn(`[roadmap] ${label} not found — using existing generated file if available`)
  return null
}

const versioningContent = findAndRead(candidates, 'VERSIONING.md')
const backlogContent = findAndRead(backlogCandidates, 'backlog.md')

// Only regenerate if we found at least the versioning file
if (versioningContent !== null) {
  const output = `// AUTO-GENERATED by scripts/copy-roadmap-data.mjs — do not edit
export const VERSIONING_MD = ${JSON.stringify(versioningContent)}
export const BACKLOG_MD = ${JSON.stringify(backlogContent || '')}
`
  writeFileSync(outFile, output, 'utf-8')
  console.log(`[roadmap] Generated ${outFile}`)
} else {
  console.log(`[roadmap] Skipping generation — using committed version`)
}
