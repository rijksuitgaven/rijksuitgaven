/**
 * Embed markdown files into a generated TypeScript module.
 * The roadmap API imports this module — no filesystem reads at runtime.
 */
import { readFileSync, writeFileSync, mkdirSync, existsSync, readdirSync } from 'fs'
import { resolve, join } from 'path'

const appDir = process.cwd()
const outDir = join(appDir, 'src', 'generated')
const outFile = join(outDir, 'roadmap-data.ts')

mkdirSync(outDir, { recursive: true })

// Debug: show directory structure to diagnose Railway paths
console.log(`[roadmap] cwd: ${appDir}`)
console.log(`[roadmap] parent: ${resolve(appDir, '..')}`)
try {
  console.log(`[roadmap] cwd contents: ${readdirSync(appDir).join(', ')}`)
  console.log(`[roadmap] parent contents: ${readdirSync(resolve(appDir, '..')).join(', ')}`)
  const grandparent = resolve(appDir, '..', '..')
  console.log(`[roadmap] grandparent (${grandparent}) contents: ${readdirSync(grandparent).join(', ')}`)
} catch (e) {
  console.log(`[roadmap] dir listing error: ${e.message}`)
}

// Search for VERSIONING.md in multiple locations
const candidates = [
  join(appDir, '..', 'docs', 'VERSIONING.md'),           // dev: app/../docs/
  join(appDir, 'docs', 'VERSIONING.md'),                   // if docs is inside app/
  join(appDir, '..', '..', 'docs', 'VERSIONING.md'),       // Railway might nest deeper
  '/docs/VERSIONING.md',                                     // absolute fallback
]

const backlogCandidates = [
  join(appDir, '..', '02-requirements', 'backlog.md'),
  join(appDir, '02-requirements', 'backlog.md'),
  join(appDir, '..', '..', '02-requirements', 'backlog.md'),
  '/02-requirements/backlog.md',
]

function findFile(candidates, label) {
  for (const candidate of candidates) {
    console.log(`[roadmap] Checking ${label}: ${candidate} → ${existsSync(candidate) ? 'FOUND' : 'not found'}`)
    if (existsSync(candidate)) {
      return readFileSync(candidate, 'utf-8')
    }
  }
  return ''
}

const versioningContent = findFile(candidates, 'VERSIONING.md')
const backlogContent = findFile(backlogCandidates, 'backlog.md')

const output = `// AUTO-GENERATED by scripts/copy-roadmap-data.mjs — do not edit
export const VERSIONING_MD = ${JSON.stringify(versioningContent)}
export const BACKLOG_MD = ${JSON.stringify(backlogContent)}
`

writeFileSync(outFile, output, 'utf-8')
console.log(`[roadmap] Generated ${outFile} (versioning: ${versioningContent.length}, backlog: ${backlogContent.length} chars)`)
