# Daily Log — 2026-02-28

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 9+ — Pre-Launch Polish & Beta Feedback
**Session Duration:** [to be filled]

---

## Summary

[To be completed at /closeday]

---

## Work Completed

1. **Bug Fix: Autocomplete click returns 0 results (V2.3.1)** — Two bugs found and fixed:
   - `is_word_boundary_match()` failed on terms with special chars (parentheses, hyphens) — adaptive `\b` boundaries
   - `has_primary_query` gate was False in regex fallback path — added `using_regex_fallback` flag
2. **Test Framework: curl-based API integration tests** — Built `scripts/tests/` with:
   - `lib.sh` — shared helpers (colors, assertions, fetch with BFF auth)
   - `smoke.sh` — post-deploy health verification (~15s)
   - `regression.sh` — 6 regression tests for known bugs (REG-001 through REG-006)
   - `run.sh` — entry point (`./run.sh smoke|regression|all`)
   - `README.md` — strategy, decision tree for when to run what
3. **Bug Fix: sort_by=primary desc fails on NULL rows** — PostgreSQL puts NULLs first with DESC ordering; Pydantic `primary_value: str` rejected None → 400 error. Fixed by adding `NULLS LAST` to all 3 sort clause locations in modules.py. Verified across all 6 modules.
4. **Version Renumbering: V2.0.1–V2.0.3 → V2.1–V2.3** — These were features/improvements, not patches. Updated VERSIONING.md (full renumber cascade), release-notes.ts (banner data), versiegeschiedenis page (changelog). Downstream V2.x versions renumbered accordingly.
5. **Bug Fix: Browser back button broken** — `router.replace()` in module-page.tsx overwrote browser history on every filter change. Fixed with debounced `router.push()` (500ms) + duplicate URL skip. Staging merge conflict resolved (combined with UX-039/UX-041 features).
6. **Copy: Login email session duration info** — Added "Na inloggen blijft u ingelogd zolang u het platform minstens één keer per 7 dagen bezoekt." to magic link login email (both HTML and plain-text versions). Matches text already present in invitation email.
7. **Bug Fix: UX-039 Row Pinning — 10 staging commits** — Comprehensive fix session for pin/unpin/expand on staging:
   - **Unpin during search:** `row.pin(false)` → direct `setRowPinning` state update
   - **Phantom rows:** `dataIdSet` filter on `getCenterRows()` removes rows kept by `keepPinnedRows`
   - **Stale closure:** `pinnedCount` missing from `columns` useMemo dependency array
   - **Expand broken (parseInt):** `onExpandedChange` used `parseInt(k, 10)` on string primary_value IDs → NaN → silent fail
   - **Auto-expand key:** Used numeric index instead of `primary_value` string as expanded state key
   - **Data-change wipe:** `setExpanded({})` on data change destroyed pinned row expanded state. Now preserves pinned rows.
   - **Pinned rows disappear during search:** Server-side pagination means TanStack loses pinned rows not in search results. Added `pinnedRowsCache` (Map<string, RecipientRow>) that stores row data when pinned.
   - **Expand click area:** Chevron button was only 4px padding, rest of cell was dead space
   - **Chevron hidden behind primary column:** Expand column 32px but two buttons need ~48px. Primary column (sticky, z-10, left:32px) overlapped the chevron. Added `STICKY_PRIMARY_OFFSET_PINNED_PX = 56` for pinned rows.
   - **Chevron hover invisible:** Changed to always-pink chevron on pinned rows + `blue-100` hover bg
   - **Pink border on expanded content:** Added `isPinned` prop through renderExpandedRow → ExpandedRow, applied `border-l-2 border-l-[var(--pink)]` to all 5 `<tr>` elements
   - **Max pinned rows:** Increased from 4 to 5

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/tests/lib.sh` | Shared test library (colors, assertions, fetch with auth) |
| `scripts/tests/smoke.sh` | Post-deploy smoke test |
| `scripts/tests/regression.sh` | Known-bug regression tests (REG-001–REG-006) |
| `scripts/tests/run.sh` | Test runner entry point |
| `scripts/tests/README.md` | Test strategy documentation |

## Files Modified

| File | Changes |
|------|---------|
| `backend/app/services/modules.py` | Fixed `is_word_boundary_match` + `has_primary_query` gate; added `NULLS LAST` to 3 sort clauses |
| `docs/VERSIONING.md` | Renumbered V2.0.1–V2.0.3 → V2.1–V2.3; added V2.3.1 patch; cascaded V2.x renumbering |
| `app/src/lib/release-notes.ts` | Renumbered banner versions V2.1–V2.3; added V2.3 entry |
| `app/src/app/versiegeschiedenis/page.tsx` | Renumbered V2.0.1→V2.1, V2.0.2→V2.2; added V2.3 section |
| `app/src/components/module-page/module-page.tsx` | `router.replace` → debounced `router.push` (500ms) for back button |
| `app/src/app/api/v1/auth/magic-link/route.ts` | Added session duration info to login email (HTML + plain text) |
| `scripts/tests/regression.sh` | Added BFF_SECRET guard; REG-002 tests both asc and desc |
| `scripts/tests/README.md` | Added BFF_SECRET auth documentation |
| `app/src/components/data-table/data-table.tsx` | 10 fixes: pinnedRowsCache, tableData merge, parseInt→string, preserved pinned expanded, getTopRows filter, isPinned prop, STICKY_PRIMARY_OFFSET_PINNED_PX, always-pink chevron, MAX_PINNED_ROWS 4→5 |
| `app/src/components/data-table/expanded-row.tsx` | isPinned prop + pink border on all 5 `<tr>` elements |
| `app/src/components/module-page/module-page.tsx` | isPinned parameter passthrough to ExpandedRow |
| `CLAUDE.md` | Virtual Senior Team protocol added |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Autocomplete click on special-char names → 0 results | Adaptive `\b` boundaries + `using_regex_fallback` flag |
| No test infrastructure beyond `test-all-modules.sh` | Built curl-based test framework (smoke + regression) |
| `sort_by=primary` with `desc` returns 400 on 4/6 modules | `NULLS LAST` on all 3 sort clause locations in modules.py |
| Version numbering: features labeled as patches (V2.0.x) | Renumbered V2.0.1–V2.0.3 → V2.1–V2.3 across 3 files |
| Browser back button broken (doesn't return to previous settings) | `router.replace` → debounced `router.push` (500ms) |
| Login email missing session duration info | Added "Na inloggen blijft u ingelogd..." to magic-link template |
| UX-039: Unpin fails during search | Direct `setRowPinning` + `dataIdSet` filter on center rows |
| UX-039: Stale closure in columns useMemo | Added `pinnedCount` to dependency array |
| UX-039: Expand silently fails (parseInt on string IDs) | Removed `parseInt(k, 10)`, use string keys directly |
| UX-039: Pinned rows disappear during search | `pinnedRowsCache` + `tableData` merge for server-side pagination |
| UX-039: Chevron unclickable (overlapped by primary column) | `STICKY_PRIMARY_OFFSET_PINNED_PX = 56` for pinned rows |
| UX-039: Expanded pinned rows lack pink border | `isPinned` prop through 3 files, `border-l-2 border-l-[var(--pink)]` on all `<tr>` |

---

## Commits

| Hash | Message |
|------|---------|
| `c91eecd` | Fix: word boundary matching fails on special chars |
| `3923e16` | Tests: curl-based API test framework (smoke + regression) |
| `24fb2b1` | Tests: fix REG-002 sort_by=primary to use sort_order=asc |
| `3d85b42` | Fix: sort_by=primary desc fails on NULL rows (NULLS LAST) |
| `941dc31` | Docs: renumber V2.0.1–V2.0.3 → V2.1–V2.3 |
| `c4ca6ca` | Fix: browser back button broken by router.replace |
| `c83152e` | Copy: add session duration info to magic link login email |
| `2c10d51` | Docs: document session |
| `295e1d5` | Process: Virtual Senior Team in CLAUDE.md |
| `16410aa` | Fix: unpin button fails when pinned row not in search results (staging) |
| `c544b33` | Fix: phantom rows linger after unpin during search (staging) |
| `848fd34` | Fix: unpin button unresponsive + pinned rows not expandable (staging) |
| `5943a41` | Fix: pinnedCount missing from columns useMemo deps (staging) |
| `9e6a3d0` | Fix: UX-039 pin/expand — 7 root-cause fixes (staging) |
| `4bf48fc` | Fix: expand button click area too small on pinned rows (staging) |
| `975571b` | Fix: pinned rows disappear during search + chevron alignment (staging) |
| `2511d0a` | UX: increase max pinned rows from 4 to 5 (staging) |
| `aea31e1` | Fix: pinned row chevron always pink + visible hover state (staging) |
| `8037399` | Fix: pinned row chevron hidden behind sticky primary column (staging) |

---

## Test Results (2026-02-28)

**Final suite: 32/32 PASSED** (after NULLS LAST fix)

### Smoke Test — 12/12
| Test | Result |
|------|--------|
| Health check | healthy |
| Public search 'prorail' | 2 results |
| instrumenten data | 3 results |
| apparaat data | 3 results |
| inkoop data | 3 results |
| provincie data | 3 results |
| gemeente data | 3 results |
| publiek data | 3 results |
| integraal data | 3 results |
| Autocomplete | 3 results |
| Search instrumenten | 2 results |
| Search integraal | 2 results |

### Regression Tests — 19/19
| Test | Result |
|------|--------|
| REG-001a: parentheses search | 3 results |
| REG-001b: hyphen search | 3 results |
| REG-001c: full name with special chars | 2 results |
| REG-002: sort_by=totaal | 3 results |
| REG-002: sort_by=y2024 | 3 results |
| REG-002: sort_by=primary (asc) | 3 results |
| REG-002: invalid sort_by → 400 | HTTP 400 |
| REG-003: publiek has data | 3 results |
| REG-003: publiek provincie column | 3 results |
| REG-004: year sum == totaal | sum=12,272,597,000 |
| REG-005: deltares search | 5 results |
| REG-005: secondary matches flagged | 1 secondary |
| REG-006: all 7 modules default browse | 3 results each |

### Post-Fix: 32/32 ALL PASSED (including bonus fix)
After deploying `NULLS LAST` fix, `sort_by=primary desc` now passes on all modules.

| Additional Test | Result |
|----------------|--------|
| REG-002: sort_by=primary desc | 3 results |

---

## Next Steps

[To be completed at /closeday]

---

**Session Status:** In Progress
