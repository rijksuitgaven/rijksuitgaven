# Daily Log — 2026-02-27

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 9+ — Pre-Launch Polish & Beta Feedback
**Session Duration:** ~6h (4 sessions)

---

## Summary

Session 1: UI copy improvements across 6 files (homepage, column headers, menu, search placeholders, number formatting, pluralization). Deployed to both environments.

Session 2: Major data accuracy bug fix — search-scoped results. When searching "deltares", RVO appeared with full €1.8B total instead of just the Deltares-related portion (~€122M). Implemented hybrid query routing: primary name matches use fast aggregated view, secondary field matches use filtered source table. Also scoped expanded rows to respect search terms and active filters.

Session 3: Two critical hotfixes for the search-scoped results deploy. (1) Pydantic model missing `is_secondary_match` field — silently stripped from API response, frontend never received the flag, expanded rows never scoped. (2) `primary_only_keys` not initialized at top scope — only defined inside `if search:` block, caused NameError on every default browse (no search), breaking all 6 module pages. Both fixed and deployed. Full verification: 17/17 test suite passed, key design doc scenarios confirmed.

Session 4: Feedback button dynamically positions above cookie banner. Users who don't dismiss the cookie bar couldn't see the Feedback button (both fixed to bottom of viewport). Feedback button now checks localStorage for banner state and adjusts offset. Smooth slide-down animation when banner is dismissed via custom event.

---

## Work Completed

### UI Text Changes (Session 1)
- "rijksoverheidsuitgaven" → "overheidsbestedingen" on homepage
- "Ook in" → "Komt ook voor in" column header (4 files)
- "biljoen" → always "miljard" in amount formatting
- "Zoek in alle" → "Doorzoek ontvangers" menu item
- "Zoek in" → "Doorzoek" for integraal search placeholder
- "+X meer" → "+X resultaat/resultaten" (singular/plural)

### Search-Scoped Results Bug Fix (Session 2)
- **Change 1 (Backend):** Split `_get_from_aggregated_view()` into primary/secondary query paths. Secondary matches query source table with search filter. Parallel execution via `asyncio.gather`. Python-side merge with relevance sorting and pagination.
- **Change 2 (Backend):** Added `search` + `filter_fields` params to `get_row_details()` and API endpoint. Extracts filter params from `Request.query_params`.
- **Change 3 (Frontend):** Thread `searchQuery` to `ExpandedRow` for secondary match scoping.
- **Change 4 (Frontend):** Thread `activeFilters` to `ExpandedRow` for filter-scoped expansion.
- **Edge case fix:** Added `is_secondary_match` flag to distinguish secondary matches from enriched primary matches (both can have `matchedField` after enrichment).
- **Edge case fix:** `has_primary_query` correctly skips aggregated view when all matches are secondary.
- **Edge case fix:** Year/amount filters applied to secondary results in Python.
- Design document: `docs/plans/2026-02-27-search-scoped-results.md`

### Hotfixes (Session 3)
- **Hotfix 1:** Added `is_secondary_match: Optional[bool] = None` to Pydantic `AggregatedRow` model in `backend/app/api/v1/modules.py`. Without this, Pydantic silently stripped the field from API responses — frontend condition `row.isSecondaryMatch && searchQuery` always evaluated false.
- **Hotfix 2:** Initialized `primary_only_keys: list[str] = []` at function scope in `backend/app/services/modules.py`. Variable was only defined inside `if search:` block but referenced unconditionally at `has_primary_query` check — caused NameError on every non-search page load, breaking all 6 modules.
- **Verification:** 17/17 cross-module tests passed (autocomplete, browse, search). Key scenarios confirmed: deltares→RVO shows €2.4M (not €1.8B), expanded rows scoped correctly, all modules browse normally, totals match row sums.

### Feedback Button + Cookie Banner (Session 4)
- Cookie banner dispatches `cookie-banner-change` custom event on dismiss
- Feedback button checks `localStorage('cookie-banner-dismissed')` on mount + listens for event
- Dynamic bottom offset: `bottom-16` (banner visible) → `bottom-5` (dismissed), with `transition-all duration-300`
- Form/success panels also adjust: `bottom-[7.5rem]` → `bottom-20`

---

## Files Created

| File | Description |
|------|-------------|
| `docs/plans/2026-02-27-search-scoped-results.md` | Design doc: hybrid query routing for accurate search amounts |

## Files Modified

| File | Changes |
|------|---------|
| `backend/app/services/modules.py` | Change 1: Split primary/secondary in `_get_from_aggregated_view`. Change 2: `search`+`filter_fields` in `get_row_details` |
| `backend/app/api/v1/modules.py` | Accept `q` + filter params on details endpoint |
| `app/src/components/data-table/expanded-row.tsx` | `searchQuery` + `activeFilters` props, scoped detail URL |
| `app/src/components/module-page/module-page.tsx` | Extract `activeMultiselectFilters`, pass to `renderExpandedRow` |
| `app/src/types/api.ts` | `is_secondary_match` / `isSecondaryMatch` type |
| `app/src/lib/api.ts` | Map `is_secondary_match` in `transformRow()` |
| `app/src/app/page.tsx` | Homepage subtitle text |
| `app/src/components/data-table/data-table.tsx` | Column header, pluralization |
| `app/src/components/header/header.tsx` | Menu item text |
| `app/src/components/filter-panel/filter-panel.tsx` | Search placeholder text |
| `app/src/app/support/page.tsx` | Column name reference |
| `app/src/app/versiegeschiedenis/page.tsx` | Column name reference |
| `app/src/components/cookie-banner/cookie-banner.tsx` | Dispatch `cookie-banner-change` event on dismiss |
| `app/src/components/feedback/feedback-button.tsx` | Dynamic bottom offset based on cookie banner state |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| RVO shows €1.8B when searching "deltares" instead of ~€122M | Hybrid query routing: secondary matches use source table with search filter |
| Expanded rows show ALL detail rows ignoring search/filter scope | Pass `?q=` and filter params to detail API endpoint |
| Primary matches with enriched matchedField incorrectly treated as secondary | Added `is_secondary_match` boolean flag to API response |
| All-secondary search (no primary name matches) runs unnecessary aggregated view query | Fixed `has_primary_query = bool(primary_only_keys) or not search` |
| Pydantic silently stripping `is_secondary_match` from API response | Added field to `AggregatedRow` Pydantic model |
| Default browse (no search) returns NameError on all modules | Initialized `primary_only_keys = []` at function scope |
| Feedback button hidden behind cookie banner for users who don't dismiss it | Dynamic positioning: feedback button detects banner state via localStorage + custom event |

---

## Next Steps

- Continue with remaining beta polish items
- Test remaining edge case scenarios from design doc (combined search + filter, cross-module counts)

---

**Session Status:** Complete
