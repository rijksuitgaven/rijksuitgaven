# Daily Log — 2026-02-15

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 7 — Pre-Launch Tasks
**Session Duration:** [to be filled]

---

## Summary

Massive bug-fix and polish day across 16 sessions. Rebuilt the entire transactional email system to bypass Supabase URLs (sessions 1-5): invite emails, magic link login, and callback page all now use own domain with Resend. Debugged and hardened the statistics dashboard across 6 rounds (sessions 6-11): fixed member counts, analytics tracking (debounce, privacy browsers, endpoint rename), search success metrics, and NaN bugs. Fixed autocomplete dropdown staying open (session 12). Suppressed false-positive network errors from the error dashboard (session 13). Reset usage_events for clean production start (session 14). Fixed module nav bar overflow with condensed font (session 15). Fixed intermediate search tracking during autocomplete browsing (session 16). 4 SQL migrations executed on production (048-051). 26 issues resolved. ~27 commits.

---

## Work Completed

### Session 1: Invite Email Bug Fixes
- Full architecture review of invite/magic link email system (3 entry points, 2 template types)
- Fixed 3 bugs + 1 hardcoded URL across 5 files

### Session 2: UX-033 Fouten as Separate Tab + Error Email Notifications
- Moved Fouten out of Statistieken into dedicated `/team/fouten` page
- Added Fouten tab to TeamNav with red error count badge (only when > 0)
- Updated dashboard error alert to link to `/team/fouten`
- Cleaned up Statistieken page (removed ErrorsSection, formatErrorPrompt, error PulseCard, clear callbacks)
- Added Resend email notification to `contact@rijksuitgaven.nl` when error events are received

### Session 3: Invite "Opnieuw" Bug Fix
- Root cause: invite route checked `last_sign_in_at` from Supabase auth, which gets set even on failed PKCE exchanges
- Frontend showed "Uitgenodigd" (based on `last_active_at` being null), but invite route saw `last_sign_in_at` set → early return without sending email
- Fix: check `last_active_at` from subscription table instead of `last_sign_in_at` from auth

### Session 4: Invite Link Uses Own Domain
- Problem: invite emails contained `supabase.co` verify URL — looks suspicious + PKCE incompatible (no code_verifier cookie for server-side generateLink)
- Fix: extract `hashed_token` from `generateLink` response, build link on own domain (`/auth/callback?token_hash=...&type=magiclink`)
- Updated callback page to handle dual flow: Flow A (PKCE code from regular login) and Flow B (token_hash from admin invite via `verifyOtp()`)
- Added `invalid_link` error message to login form

### Session 5: Magic Link Login Via Own Domain
- Problem: regular login via `signInWithOtp` still went through Supabase URL
- Created `POST /api/v1/auth/magic-link` — uses `generateLink` + Resend for branded email on own domain
- In-memory rate limit (60s per email), body size limit, always returns 200 (email enumeration prevention)
- Updated login form to call our endpoint instead of Supabase's `signInWithOtp`
- All transactional emails now bypass Supabase completely — sent via Resend with branded templates

### Session 6: Statistics Dashboard Bug Fixes (Round 1)
- **4 bugs reported:** wrong member count (5→3), search events not logged, "1 unieke gebruiker" everywhere, retention stale
- Fix 1: `total_members` query — added `cancelled_at IS NULL` filter (was counting cancelled subscriptions)
- Fix 2: `sendBeacon` — checked return value, added fetch fallback (sendBeacon returns true but uBlock Origin blocks at network layer)
- Fix 3: Invite flow — link `user_id` when user "already registered" (subscription had NULL user_id)
- Fix 4: Retention SQL — removed `first_week >= since_date` filter that excluded historical cohorts (migration 048)
- Commit: `994d1d6`

### Session 7: Analytics Endpoint Rename
- Problem: Mullvad Browser (Tor-based + uBlock Origin) blocks URLs containing "analytics"
- Renamed `/api/v1/analytics` → `/api/v1/events` across BFF route, analytics hook, error boundary, not-found page
- Commit: `d2edefd`

### Session 8: Security + Analytics + Auth Flash — 6-Fix Audit
- Expert debugging team (5 members: Security, Frontend, Browser Compat, Data, QA)
- Fix 1: Middleware denies access when no subscription found (was allowing — security hole)
- Fix 2: `useAuth` adds `isLoading` flag → prevents login flash (header showing "Inloggen" briefly)
- Fix 3: Analytics fetch-first strategy + `text/plain` sendBeacon for page unload only
- Fix 4: Migration 049 — link unlinked subscriptions (NULL user_id → auth.users.email match)
- Fix 5: Migration 049 — truncate `usage_events` (test data from broken tracking)
- Fix 6: BFF auth guard checks subscription status (role, cancelled_at, grace_ends_at)
- Migration 049 required 2 error fixes: unique constraint violation (NOT EXISTS clause), cannot change return type (DROP FUNCTION first)
- Commits: `bf0a8b4`, `6454bbf`, `c96503c`

### Session 9: Statistics Dashboard Bug Fixes (Round 2)
- Second expert team with Adversarial + Supabase expert
- Fix 1: "null%" in Zoeksucces — null guard on `success_rate` in template literal
- Fix 2: "4 leden" instead of 3 — added `deleted_at IS NULL` filter to member count
- Fix 3: Search events never tracked — removed 2s `setTimeout` debounce, fire immediately with deduplication
- Commit: `958db40`

### Session 10: Search Tracking Debounce + NaN Fix
- Every keystroke tracked as separate search ("ge", "gee", "geme", etc.) — immediate tracking too aggressive
- Restored 1s debounce with flush-on-unmount pattern (pending search fires on navigation/module switch)
- NaN in "Resultaten" column — migration 049 recreated `get_usage_searches` without `avg_results`
- Frontend null guard + migration 050 adds `avg_results` back to function
- Truncated `usage_events` again (keystroke test data)
- Commit: `11ec369`

### Session 11: Search Success + UI Cleanup
- `autocomplete_click` added to search success criteria (was only row_expand, export, cross_module_nav, external_link)
- Migration 051 executed — Zoeksucces now 85.7% (was 0%)
- Removed redundant "Team" heading from 5 team pages (dashboard, leden, contacten, feedback, fouten) — consistent with Statistieken
- Commits: `efedf08`, `2a8052b`

### Session 12: Autocomplete Dropdown Stays Open After Enter
- Bug: type "Gemeente Rotterdam", arrow down to highlight, press Enter → selection works but dropdown stays open
- Root cause: `handleSelectCurrentModule` set `isDropdownOpen(false)` + `blur()`, but changing the search value triggered the autocomplete effect which checked `hasUserTypedRef.current` (still `true`) and reopened dropdown
- Fix: set `hasUserTypedRef.current = false` before changing search value, preventing autocomplete from reopening
- Commits: `cdd8fa3`, `f149af2`

### Session 13: Error Dashboard False Positives
- Analyzed 9 reported errors in `/team/fouten` — all false positives from transient network/navigation
- Cluster 1 (7 errors): `NetworkError` from rapid module switching — Firefox cancels in-flight requests
- Cluster 2 (2 errors): `Failed to fetch` on instrumenten — Chrome equivalent, request cancelled by sort/search change
- Fix: expanded `AbortError` guard in `module-page.tsx` catch block to also suppress `NetworkError`, `Failed to fetch`, and truncated `"data: "` messages
- Cleared 9 false positives from production `usage_events` table
- Commit: `075236b`

### Session 14: Usage Events Reset
- Truncated `usage_events` table (55 test events from today's debugging sessions)
- Clean slate for production tracking starting tomorrow

### Session 15: Module Nav Bar Overflow Fix
- Backlog item: "Module Navigation Bar Overflow (Pre-Launch)" — IBM Plex Sans wider than Condensed, "Apparaatskosten" cut off
- Expert panel review (5 specialists: Creative Strategist, Brand Designer, Frontend UI, UX Researcher, QA Lead)
- Consensus: Option 1 — apply `var(--font-condensed)` to `<nav>` element only (~15% narrower, same typeface family)
- Also tightened padding `px-3` → `px-2.5` and matched accent bar positions
- Category badges ("Ontvangers", "Kosten") inherit condensed via nav parent
- Scroll fallback (`overflow-x-auto`) preserved as safety net
- Commit: `1d220f4`

### Session 16: Search Tracking — Suppress Intermediate Queries During Autocomplete
- Problem: typing "gemeente deventer" and selecting from autocomplete tracked intermediate keystrokes ("geeente", "gemeente dev") as separate searches
- Root cause 1: 1s debounce too short — user pauses >1s while browsing autocomplete suggestions
- Root cause 2: autocomplete selection didn't cancel pending search timer — resulted in duplicate tracking (search + autocomplete_click)
- Fix 1: Added `onAutocompleteSelect` callback from module-page → filter-panel. All 3 autocomplete handlers (current module, other module, field match) call it to cancel pending search timer + set skip flag
- Fix 2: Increased debounce from 1s to 2s — flush-on-unmount handles navigation, 2s better filters "looking at autocomplete" pauses
- Fix 3: `skipNextSearchTrack` ref prevents the data-load after autocomplete selection from re-starting the debounce timer
- Truncated usage_events again (test data)
- Commit: `686d970`

---

## Files Created

| File | Description |
|------|-------------|
| `logs/daily/2026-02-15.md` | Daily log |
| `app/src/app/team/fouten/page.tsx` | Dedicated errors page with date range picker, error cards, copy-prompt, clear buttons |
| `app/src/app/api/v1/auth/magic-link/route.ts` | Magic link login via generateLink + Resend (replaces Supabase signInWithOtp) |
| `scripts/sql/048-fix-retention-date-filter.sql` | Remove first_week >= since_date filter from retention function |
| `scripts/sql/049-fix-unlinked-subscriptions-and-anon-filtering.sql` | Link unlinked subscriptions, truncate events, recreate 4 functions with anon filtering |
| `scripts/sql/050-fix-searches-avg-results.sql` | Add avg_results column back to get_usage_searches |
| `scripts/sql/051-search-success-include-autocomplete.sql` | Add autocomplete_click to search success criteria |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | Added `redirectTo`, dynamic site URL, `last_active_at` check (not `last_sign_in_at`), token_hash link instead of action_link, link user_id for "already registered" users |
| `app/src/app/api/v1/team/leden/route.ts` | Paginated `listUsers()` (perPage: 50) instead of fetching all users |
| `app/src/app/api/v1/team/contacten/[id]/convert/route.ts` | Same paginated `listUsers()` fix |
| `docs/email-templates/magic-link.html` | Logo URL: hardcoded beta → `{{ .SiteURL }}` |
| `docs/email-templates/invite-user.html` | Logo URL: hardcoded beta → `{{ .SiteURL }}` |
| `app/src/components/team-nav/team-nav.tsx` | Added Fouten tab with red badge, error count fetch |
| `app/src/app/team/page.tsx` | Dashboard error alert → `/team/fouten`, removed "Team" heading |
| `app/src/app/team/statistieken/page.tsx` | Removed ErrorsSection, null guards on success_rate and avg_results |
| `app/src/app/api/v1/events/route.ts` | Renamed from analytics, error email notification via Resend |
| `app/src/app/auth/callback/page.tsx` | Dual flow: PKCE code exchange (Flow A) + token_hash verifyOtp (Flow B) |
| `app/src/components/auth/login-form.tsx` | Fetch our magic-link endpoint instead of signInWithOtp, added `invalid_link` error |
| `app/src/hooks/use-analytics.ts` | Fetch-first strategy, text/plain sendBeacon for page unload, endpoint → /api/v1/events |
| `app/src/hooks/use-auth.ts` | Added `isLoading` flag to prevent login flash |
| `app/src/components/auth/auth-button.tsx` | `if (isLoading) return null` prevents flash |
| `app/src/components/app-shell/app-shell.tsx` | `isLoading` check — renders only children while loading |
| `app/src/lib/supabase/middleware.ts` | No subscription → redirect to `/verlopen` (was allowing access) |
| `app/src/app/api/_lib/auth.ts` | BFF auth guard checks subscription status (role, cancelled_at, grace_ends_at) |
| `app/src/components/error-boundary/error-boundary.tsx` | sendBeacon text/plain + fetch fallback, endpoint → /api/v1/events |
| `app/src/components/module-page/module-page.tsx` | Search tracking: 1s debounce + flush-on-unmount (was 2s no-flush / then immediate) |
| `app/src/app/api/v1/team/statistieken/route.ts` | Member count: added cancelled_at IS NULL + deleted_at IS NULL filters |
| `app/src/app/team/leden/page.tsx` | Removed "Team" heading |
| `app/src/app/team/contacten/page.tsx` | Removed "Team" heading |
| `app/src/app/team/feedback/page.tsx` | Removed "Team" heading |
| `app/src/app/team/fouten/page.tsx` | Removed "Team" heading |
| `app/src/components/filter-panel/filter-panel.tsx` | Blur input + reset hasUserTypedRef on autocomplete selection (prevents dropdown reopen) |
| `app/src/components/module-page/module-page.tsx` | Suppress transient NetworkError/Failed to fetch from error tracking; autocomplete cancel callback + skipNextSearchTrack + debounce 1s→2s |
| `app/src/components/header/header.tsx` | Condensed font on nav bar, padding px-3→px-2.5, accent bar positions adjusted |
| `app/src/components/filter-panel/filter-panel.tsx` | Added `onAutocompleteSelect` prop, called from all 3 autocomplete handlers |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Invite `generateLink` missing `redirectTo` | Added `redirectTo: origin/auth/callback` derived from request headers |
| `listUsers()` fetches all auth users (2 places) | Paginated with `perPage: 50`, break on match |
| Hardcoded URLs in email templates | Dynamic `siteUrl` param + `{{ .SiteURL }}` in Supabase templates |
| Fouten buried inside Statistieken page | Dedicated `/team/fouten` page with own tab and badge indicator |
| No error notification | Resend email to `contact@rijksuitgaven.nl` on every error event |
| Invite "Opnieuw" doesn't send email | Check `last_active_at` from subscription instead of `last_sign_in_at` |
| Invite link goes through `supabase.co` URL | Extract `hashed_token`, build link on own domain, `verifyOtp()` client-side |
| Regular magic link via Supabase URL | New `POST /api/v1/auth/magic-link` using `generateLink` + Resend |
| Wrong member count (5→3) | `cancelled_at IS NULL` filter on subscriptions count |
| sendBeacon blocked by Mullvad/uBlock Origin | Fetch-first strategy + text/plain sendBeacon for page unload only |
| Subscription NULL user_id → anon tracking | Migration 049 links subscriptions via people.email → auth.users.email |
| Stale test data in usage_events | Truncated twice (migration 049 + manual after keystroke noise) |
| `/api/v1/analytics` URL blocked by privacy browsers | Renamed to `/api/v1/events` |
| Terminated account still browsing | Middleware denies when no subscription found |
| Login flash (header shows "Inloggen" briefly) | `isLoading` flag in useAuth + AuthButton/AppShell guards |
| BFF routes bypass middleware auth | `getAuthenticatedUser()` checks subscription status |
| "null%" in Zoeksucces card | Null guard on `success_rate` in template literal |
| "4 leden" instead of 3 | Added `deleted_at IS NULL` to member count query |
| Search events lost on navigation (2s setTimeout) | 1s debounce + flush-on-unmount pattern |
| Every keystroke tracked as separate search | Restored debounce (was removed in attempt to fix lost events) |
| NaN in Resultaten column | Migration 049 dropped avg_results; migration 050 adds it back |
| Zoeksucces 0% (too strict criteria) | Migration 051 adds autocomplete_click to success criteria |
| Redundant "Team" heading on 5 pages | Removed — tab bar is sufficient navigation |
| Autocomplete dropdown stays open after Enter selection | Reset `hasUserTypedRef` + blur input in `handleSelectCurrentModule` |
| 9 false-positive errors on dashboard (NetworkError/Failed to fetch) | Expanded AbortError guard to suppress transient network errors from navigation; cleared from DB |
| Module nav bar overflow — "Apparaatskosten" cut off | Condensed font on nav bar only + tighter padding (px-2.5). Full labels preserved |
| Intermediate keystrokes tracked as separate searches during autocomplete | `onAutocompleteSelect` callback cancels timer + skip flag; debounce 1s→2s |

---

## Next Steps

- Verify nav bar on production (all labels visible, no overflow at common widths)
- Rate limiting via Cloudflare (pre-launch backlog)
- User migration (~50 WordPress users)
- Homepage integration (De Geldstroom + Ontdekking widget)
- Search enhancements (multi-word AND, exact phrase, prefix)
- Interactive search demo on homepage (backlog)

---

**Session Status:** Complete — 16 sessions, ~27 commits
