# Daily Log - 2026-02-07

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 6 - User Authentication
**Session Duration:** ~8 hours (5 sessions)

---

## Summary

Implemented Data Availability Indicators feature end-to-end: database table, backend API, frontend rendering. Fixed "Amsersfoort" typo (1,168 rows), updated data update runbook, deployed and verified in production. All curated year ranges now live. Session 2: Fixed totals row em-dash, changed ontvanger click to expand row (detail panel deferred to V5), fixed slash encoding bug in expanded row details. Session 3: Staffelbedrag explanation popover (UX-013) on Inkoop/Publiek footer - completes all V1.0 backlog items. Session 4: Trend anomaly threshold raised to 50%, instant tooltips on year cells, integraal module click navigates with ontvanger pre-searched. Session 5: Major encoding corruption cleanup across all 6 tables - fixed double-encoded UTF-8 (~4,400 rows), triple-encoded inkoop (~400 rows), question mark corruption (~500 rows), Phase 1c collateral damage (~350 rows), plus miscellaneous encoding issues (÷→ö, √ç→ä, ‚Çè→€). All 7 materialized views refreshed.

---

## Work Completed

### Session 1: Data Availability Indicators Implementation
- **Database:** Created `data_availability` table (022) with RLS, indexes, 29 curated entries
- **Database:** Fixed "Amsersfoort" typo in gemeente table (023) - 1,168 rows corrected
- **Backend:** Added `data_available_from`/`data_available_to` to AggregatedRow model
- **Backend:** Module-level availability for instrumenten/inkoop/apparaat (cached)
- **Backend:** Entity-level availability for gemeente/provincie/publiek with filter-aware lookup
- **Backend:** Integraal computes combined range from all modules entity appears in
- **Backend:** When filtered to single entity (e.g., `?gemeente=Amersfoort`), uses entity-specific range
- **Backend:** When unfiltered, uses full range (2016-2024) as fallback per design doc
- **Frontend:** Updated TypeScript interfaces (ApiRecipientRow, RecipientRow)
- **Frontend:** Updated transform function to pass through availability fields
- **Frontend:** Year cells show em-dash (—) with tooltip for unavailable years
- **Frontend:** CollapsedYearsCell only sums available years
- **Frontend:** Expanded row inherits availability from parent row
- **Frontend:** Removed "* Data nog niet compleet" footer and * indicator on latest year header

### Session 1: Data Quality Fix
- Fixed "Amsersfoort" → "Amersfoort" typo in gemeente source table
- Refreshed gemeente_aggregated and universal_search materialized views
- Re-synced Typesense gemeente collection (126,376 docs, audit passed)

### Session 1: Documentation
- Rewrote DATA-UPDATE-RUNBOOK.md with comprehensive 8-step process
- Added data_availability step, cache clear step, Python fallback, Typesense key guidance
- Added troubleshooting section for common issues
- Updated DATABASE-DOCUMENTATION.md with data_availability table
- Updated backlog: data availability + typo fix marked complete

### Session 2: Total Row Em-dash Fix
- Fixed total row showing "€0" instead of "—" for years where all rows have no data
- Both individual year columns and collapsed years (2016-2020) now respect availability

### Session 2: Click Ontvanger → Expand Row
- Changed ontvanger/kostensoort click behavior: now expands row (was opening detail panel)
- Removed detail panel from module-page (deferred to V5 per earlier decision)
- "+X meer" click also now expands the row
- Removed `onRowClick` prop from DataTable (cleaned up unused code)

### Session 3: Staffelbedrag Explanation Popover (UX-013)
- Added info icon (ⓘ) next to footer text on Inkoop and Publiek modules
- Click opens navy popover with staffel range table and explanation (Dutch)
- Word "staffelbedrag(en)" in footer text is clickable (dotted underline, opens same popover)
- Matches search tips popover pattern (navy dark + pink accent bar)
- Content: explanation of midpoint calculation, staffel 1-13 ranges, source reference
- Completes V1.0 backlog item "Staffelbedrag Explanation"

### Session 4: Trend Anomaly Threshold + Tooltip Fix
- Changed anomaly threshold from 10% to 50% (was too noisy — normal budget adjustments triggered it)
- Switched year cell tooltips from native `title` (slow ~500ms delay) to CSS-only `data-tooltip-center` (instant)
- Tooltip shows "+X% vs vorig jaar" on hover

### Session 4: Integraal Module Navigation
- Clicking module name (e.g., "instrumenten") in integraal expanded row now navigates to `/{module}?q={ontvanger}`
- Previously applied a filter on the integraal page itself — now opens the actual module with the ontvanger searched

### Session 2: Slash Encoding Bug Fix
- Fixed "Fout bij laden details" for Apparaat values containing slashes (e.g., "Vaklit/abonn/overig")
- Root cause: Next.js App Router decodes `%2F` back to `/` before route matching
- Fix: Double-encode values so slashes survive Next.js routing layer

### Session 5: Encoding Corruption Cleanup (All 6 Tables)

**Problem:** Legacy WordPress/MySQL data had encoding corruption from CSV export:
- **Double-encoded UTF-8** (~4,400 rows): `Café` stored as `CafÃ©`
- **Triple-encoded UTF-8** (~400 rows, mainly inkoop): `ë` stored as `ÃƒÂ«`
- **Lost characters (?)** (~500 rows): `Café` stored as `Caf??`
- **Division sign corruption** (~77 rows): `ö` stored as `÷`
- **Mac Roman encoding** (~6 rows): `ä` stored as `√§`/`√ç`
- **Euro sign corruption** (~24 rows): `€` stored as `‚Çè`
- **Section sign damage** (~160 rows): `§1` stored as `ç1` (from Phase 1c collateral)

**Execution approach:** Python scripts with asyncpg parameterized queries (avoids SQL string escaping issues). SQL file for question mark fixes via psql.

**Scripts executed (in order):**
1. `fix-encoding-phase1.py` - Main double-encoded patterns (Ã©→é, Ã«→ë, etc.)
2. `fix-encoding-phase1b.py` - Triple-encoded + uppercase + Â-prefix patterns
3. `fix-encoding-phase1c-correct-triple.py` - Fix Phase 1b's wrong character mapping
4. `fix-encoding-phase1d-reverse-damage.py` - REVERTED (caused 23,911 row catastrophe)
5. `fix-encoding-phase1e-undo-1d.py` - Undo Phase 1d completely
6. `fix-encoding-phase1f-fix-apostrophes.py` - Targeted regex apostrophe fix (240 rows)
7. `025-fix-encoding-question-marks.sql` via psql - 431 explicit UPDATE statements
8. Manual fixes: remaining 4 question marks, ÷→ö, √ç→ä, ‚Çè→€, §ç→§ digits

**Final verification:** ALL corruption patterns CLEAN across all 6 tables.

**Materialized views refreshed:** All 7 views (instrumenten_aggregated through universal_search).

**Typesense sync:** All 7 collections re-synced with corrected data. Audit passed (exact match all collections).

### Production Deployment & Verification
- Ran 022-data-availability.sql migration on Supabase (29 rows inserted)
- Fixed entity-level availability lookup (was returning null for entity-level modules)
- Deployed all commits to Railway
- Verified all 4 API scenarios return correct availability ranges:
  - `/gemeente` (unfiltered): 2016-2024
  - `/gemeente?gemeente=Amersfoort`: 2020-2024
  - `/instrumenten`: 2016-2024
  - `/publiek?source=COA`: 2018-2024

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/022-data-availability.sql` | Data availability table, RLS, indexes, 29 curated entries |
| `scripts/sql/023-fix-amsersfoort-typo.sql` | Fix Amsersfoort→Amersfoort typo (1,168 rows) |
| `scripts/sql/024-fix-encoding-double-utf8.sql` | PL/pgSQL function for double-encoded UTF-8 (superseded by Python) |
| `scripts/sql/025-fix-encoding-question-marks.sql` | 431 explicit UPDATE statements for ? corruption |
| `scripts/data/fix-encoding-phase1.py` | Main double-encoded fix (Ã©→é, etc.) |
| `scripts/data/fix-encoding-phase1b.py` | Triple-encoded + uppercase + Â-prefix fixes |
| `scripts/data/fix-encoding-phase1c-correct-triple.py` | Correct Phase 1b wrong character mapping |
| `scripts/data/fix-encoding-phase1d-reverse-damage.py` | FAILED: Reversed too much, caused 23,911 row damage |
| `scripts/data/fix-encoding-phase1e-undo-1d.py` | Undo Phase 1d completely |
| `scripts/data/fix-encoding-phase1f-fix-apostrophes.py` | Targeted regex apostrophe fix (240 rows) |
| `scripts/data/check-remaining.py` | Diagnostic: find remaining encoding corruption |

## Files Modified

| File | Changes |
|------|---------|
| `backend/app/api/v1/modules.py` | Added `data_available_from`/`data_available_to` to AggregatedRow model |
| `backend/app/services/modules.py` | Availability lookup with filter-aware entity-level, caching, integraal fallback |
| `app/src/types/api.ts` | Added availability fields to ApiRecipientRow and RecipientRow |
| `app/src/lib/api.ts` | Pass through availability fields in transformRow() |
| `app/src/components/data-table/data-table.tsx` | NoDataCell, availability checks, removed * footer, totals row em-dash, click ontvanger expands row, staffelbedrag popover, instant tooltip on year cells |
| `app/src/components/data-table/expanded-row.tsx` | Availability-aware year cells and collapsed years, double-encode for slash values, module click navigates with ontvanger |
| `app/src/lib/format.ts` | Anomaly threshold 10% → 50% |
| `app/src/components/module-page/module-page.tsx` | Removed detail panel, removed onRowClick handler |
| `app/src/lib/api.ts` | Double-encode for detail API calls (slash values) |
| `scripts/data/DATA-UPDATE-RUNBOOK.md` | Comprehensive rewrite with 8-step process |
| `scripts/sql/DATABASE-DOCUMENTATION.md` | Added data_availability table documentation |
| `02-requirements/backlog.md` | Marked data availability + typo fix as completed |
| `logs/SESSION-CONTEXT.md` | Updated recent work section |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Ambiguous `-` for zero vs no-data | Em-dash `—` with tooltip for years outside availability range |
| "* Data nog niet compleet" was vague | Replaced with per-cell availability indicators |
| "Amsersfoort" typo (1,168 rows) | SQL UPDATE + view refresh + Typesense re-sync |
| Entity-level availability returning null | Fixed: pass filter_fields to lookup; use full range fallback for unfiltered views |
| Integraal missing entity-level modules | Fixed: added YEARS fallback for gemeente/provincie/publiek in integraal |
| Total row showing €0 for unavailable years | Fixed: show em-dash when ALL rows have no data for a year |
| Click ontvanger opened dead detail panel | Changed to expand row; detail panel removed (deferred to V5) |
| "Fout bij laden details" for slash values | Double-encode values with slashes for Next.js routing |
| Users don't understand staffelbedragen | Info popover on Inkoop/Publiek footer with staffel range table |
| Too much red in year cells (10% threshold) | Raised anomaly threshold to 50% — only highlights when amounts change by half+ |
| Year cell tooltip slow (~500ms native) | Switched to CSS-only `data-tooltip-center` (instant, matches all other tooltips) |
| Integraal module click filtered instead of navigating | Module click now navigates to `/{module}?q={ontvanger}` |
| Double-encoded UTF-8 in all tables (~4,400 rows) | Python asyncpg scripts with parameterized queries |
| Triple-encoded UTF-8 in inkoop (~400 rows) | Phase 1b+1c targeted fix |
| Question mark corruption (~500 rows) | 431 explicit SQL UPDATE statements |
| Phase 1c collateral damage (§→ç, ÷→ö, √ç→ä) | Targeted regex and direct replacements |
| Euro sign corruption ‚Çè→€ (24 rows) | Direct REPLACE in gemeente.omschrijving |

---

## Commits

| Hash | Message |
|------|---------|
| `3eb4c07` | Feat: Data availability indicators + Amersfoort typo fix |
| `bca2fba` | Fix: Data availability lookup for entity-level modules |
| `cd53811` | Docs: Complete session documentation for 2026-02-07 |
| `4f8e634` | Docs: Fix 8 documentation gaps from audit |
| `3fe1029` | Fix: Total row shows em-dash when all rows have no data for a year |
| `4983dd9` | Docs: Update 6 gaps from audit (totals em-dash, missing files, stale counts) |
| `a618b57` | UX: Click ontvanger expands row instead of opening detail panel (deferred to V5) |
| `1d03557` | Fix: Double-encode values with slashes for Next.js routing (Vaklit/abonn/overig) |
| `fae104b` | Docs: Session 2 documentation (expand row, slash fix, detail panel deferred) |
| `817d638` | Docs: Remove em-dash background from open items (not needed) |
| `486d0b1` | Feat: Staffelbedrag explanation popover (UX-013) + docs update |
| `b7dc590` | UX: Trend anomaly threshold 10% → 50%, instant tooltip |
| `b7e4a83` | UX: Click module in integraal expanded row navigates to module with ontvanger searched |
| `644a1b4` | Docs: Session 4 documentation (anomaly threshold, instant tooltips, integraal nav) |
| `3823aea` | Data: Fix encoding corruption across all 6 tables (~6,000 rows) |

---

## SQL Migrations Executed on Supabase

| Script | Date | Result |
|--------|------|--------|
| `023-fix-amsersfoort-typo.sql` | 2026-02-07 | 1,168 rows updated |
| `022-data-availability.sql` | 2026-02-07 | 29 rows inserted |
| `REFRESH MATERIALIZED VIEW gemeente_aggregated` | 2026-02-07 | Success |
| `REFRESH MATERIALIZED VIEW CONCURRENTLY universal_search` | 2026-02-07 | Success (5 min timeout) |
| `fix-encoding-phase1.py` through `phase1f` | 2026-02-07 | ~5,200 rows fixed (encoding) |
| `025-fix-encoding-question-marks.sql` (via psql) | 2026-02-07 | ~500 rows fixed (? corruption) |
| Additional targeted fixes (÷→ö, √ç→ä, ‚Çè→€, ç→§) | 2026-02-07 | ~312 rows fixed |
| `REFRESH MATERIALIZED VIEW` (all 7 views) | 2026-02-07 | Success |
| `ANALYZE` (all 7 views) | 2026-02-07 | Success |
| Typesense full re-sync (`--recreate`) | 2026-02-07 | All 7 collections, audit passed |

---

## Next Steps

1. Week 6: User Authentication (Magic Link)

---

**Session Status:** Complete
