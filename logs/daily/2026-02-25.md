# Daily Log — 2026-02-25

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 9 — Pre-Launch Polish & Beta Feedback
**Session Duration:** [to be filled]

---

## Summary

[To be completed at /closeday]

---

## Work Completed

### 1. V5.0 Inzichten Lab — 3 New Visualization Concepts (h6)
- Brainstormed 3 new concepts via /brainstorm-mode, all approved
- Built 3 BFF routes + 3 frontend components + registered in h6 index
- **Concept 7: Concentration Index** — Gini coefficient, Lorenz curve, top-N shares per module
- **Concept 8: Anomaly Detector** — YoY dramatic changes across all modules
- **Concept 9: Money Flow (Sankey)** — Ministry → Regeling → Recipient flow
- Tab count: 6 → 9 concepts in h6 dashboard

### 2. V5.0 Comprehensive Design — 7-Domain Framework
- Designed full V5.0 visualization suite across 7 analytical domains via /brainstorm-mode
- Domain-by-domain Q&A with user, each domain approved individually
- 12 new concepts designed (10-21), comprehensive design doc written (665 lines)
- Design doc committed to `docs/plans/2026-02-25-v5-comprehensive-design.md`

### 3. V5.0 Lab Build — 12 New Concepts (Phase 1-3)
- **Phase 1 (Concepts 10, 12, 15, 20):**
  - Share Shift: ministry share proportions over time (stacked bar, absolute/proportional toggle)
  - Growth Comparator: indexed multi-entity growth comparison (multi-line, base year selector)
  - Spending Spectrum: log-scale distribution + box plots (histogram, entity highlight)
  - Leaderboard: ranked recipients per module/year (horizontal bar, entity highlight, detail panel)
- **Phase 2 (Concepts 11, 13, 14, 16):**
  - Sunburst: hierarchical ministry→regeling→ontvanger (SVG concentric rings, hover detail)
  - Spending Velocity: YoY% change heatmap (color-coded table, volatility metric)
  - Pattern Deviation: rolling 3yr avg variance proxy (bar chart, deviation history heatmap)
  - Reverse Flow: recipient-centric source breakdown (all 6 modules, detail drill-down)
- **Phase 3 (Concepts 17-21):**
  - Ministry Cost Structure: instrumenten vs apparaat allocation (stacked bar, detail table)
  - Spending per Capita: province spending per inhabitant with CBS 2024 data
  - Regeling Profile: distribution analysis per regeling + Gini + top-5 share + histogram
  - Head-to-Head: 6-dimension radar entity comparison (radar chart, comparison table, sparklines)
- 12 BFF routes + 12 frontend components + index.tsx registration (8 new tabs)
- Total lab: 21 concepts across 21 tabs
- TypeScript clean build, pushed to both environments (Scenario A)
- 25 files, 5,016 lines of new code

### 4. Top Tabellen — Concept 22
- Classic ranked tables inspired by old platform (Op Begroting, Op Ontvanger, Op Instrument, Op Regeling)
- BFF: `/api/v1/inzichten/top-tabellen` — aggregates instrumenten_aggregated by dimension, computes ranks + position changes
- Component: top-tabellen.tsx — 4 dimension tabs, per-jaar/alle-jaren toggle, top 25/50/100, mini sparklines, proportional bars, share-of-total %, position change indicators (▲▼/nieuw)
- Total lab concepts: 22

### 5. Bug Fixes — Ministry Cost Structure, Spending Velocity, Sunburst Zoom
- **Ministry Cost Structure**: BFF selected only single year column instead of all year columns → empty chart. Fixed select pattern + added error state to frontend.
- **Spending Velocity**: BFF response didn't match frontend interface. Added `avg_change`, `volatility` per entity, `summary` object, renamed `abs_change`→`absolute_change`, `pct_change: null`→`0`. Added error state to frontend.
- **Sunburst zoom**: "Klik op een ring om in te zoomen" promised but no click handler existed. Added full zoom navigation: click arcs to zoom in, center circle "‹ Terug" to zoom out, breadcrumb trail, legend items clickable, year change resets zoom.

### 6. Security — RLS on 3 Admin Tables (Migration 073)
- Enabled RLS on `campaigns`, `campaign_events`, `email_media` — all admin-only, service role access
- Fixes 3 Supabase linter SECURITY errors

### 7. V5.0 Lab — 6 Novel Visualization Concepts (#23-28)
- Researched novel graph types (chord, bump, alluvial, network, beeswarm, marimekko)
- Built all 6 with custom SVG — zero new dependencies
- **Concept 23: Chord Diagram** — bilateral ministry ↔ recipient ribbons, hover to isolate
- **Concept 24: Bump Chart** — ranking changes 2016→2024, per module/level, hover detail
- **Concept 25: Alluvial (Het Pad van het Geld)** — 4-stage flow: Ministerie → Instrument → Regeling → Ontvanger
- **Concept 26: Network Graph (Bestedingsnetwerk)** — force-directed ministry + recipient nodes, edges = flows
- **Concept 27: Beeswarm** — every recipient as dot on log scale, distribution brackets, stats
- **Concept 28: Marimekko** — width = ministry size, height = recipient composition
- 6 BFF routes + 6 frontend components + index.tsx registration
- Total lab concepts: 28 across 28 tabs, 2,212 lines of new code

### 8. Documentation Updates
- Updated SESSION-CONTEXT.md, VERSIONING.md, daily log with all bug fixes + features + novel concepts

---

## Files Created

| File | Description |
|------|-------------|
| `logs/daily/2026-02-25.md` | Today's daily log |
| `docs/plans/2026-02-25-v5-comprehensive-design.md` | Comprehensive V5.0 design doc (665 lines, 7 domains, 21 concepts) |
| `app/src/app/api/v1/inzichten/concentration/route.ts` | BFF: Gini, Lorenz, top-N shares |
| `app/src/app/api/v1/inzichten/anomalies/route.ts` | BFF: YoY anomaly detection (4 types) |
| `app/src/app/api/v1/inzichten/money-flow/route.ts` | BFF: Sankey nodes + links |
| `app/src/app/api/v1/inzichten/share-shift/route.ts` | BFF: Ministry share proportions over time |
| `app/src/app/api/v1/inzichten/sunburst/route.ts` | BFF: Hierarchical ministry→regeling→ontvanger tree |
| `app/src/app/api/v1/inzichten/growth-comparator/route.ts` | BFF: Indexed multi-entity growth comparison |
| `app/src/app/api/v1/inzichten/spending-velocity/route.ts` | BFF: YoY% change heatmap data |
| `app/src/app/api/v1/inzichten/pattern-deviation/route.ts` | BFF: Rolling 3yr avg variance proxy |
| `app/src/app/api/v1/inzichten/spending-spectrum/route.ts` | BFF: Log-scale distribution + box plots |
| `app/src/app/api/v1/inzichten/reverse-flow/route.ts` | BFF: Recipient-centric source breakdown |
| `app/src/app/api/v1/inzichten/ministry-structure/route.ts` | BFF: Cross-module allocation per ministry |
| `app/src/app/api/v1/inzichten/per-capita/route.ts` | BFF: Spending per capita (CBS population data) |
| `app/src/app/api/v1/inzichten/regeling-profile/route.ts` | BFF: Regeling-centric distribution + Gini |
| `app/src/app/api/v1/inzichten/leaderboard/route.ts` | BFF: Ranked recipients per module/year |
| `app/src/app/api/v1/inzichten/head-to-head/route.ts` | BFF: 6-dimension entity comparison radar |
| `app/src/components/lab/h6/concentration.tsx` | Concept 7: Concentration Index |
| `app/src/components/lab/h6/anomalies.tsx` | Concept 8: Anomaly Detector |
| `app/src/components/lab/h6/money-flow.tsx` | Concept 9: Money Flow (Sankey) |
| `app/src/components/lab/h6/share-shift.tsx` | Concept 10: Share Shift |
| `app/src/components/lab/h6/sunburst.tsx` | Concept 11: Sunburst |
| `app/src/components/lab/h6/growth-comparator.tsx` | Concept 12: Growth Comparator |
| `app/src/components/lab/h6/spending-velocity.tsx` | Concept 13: Spending Velocity |
| `app/src/components/lab/h6/pattern-deviation.tsx` | Concept 14: Pattern Deviation |
| `app/src/components/lab/h6/spending-spectrum.tsx` | Concept 15: Spending Spectrum |
| `app/src/components/lab/h6/reverse-flow.tsx` | Concept 16: Reverse Flow |
| `app/src/components/lab/h6/ministry-structure.tsx` | Concept 17: Ministry Cost Structure |
| `app/src/components/lab/h6/spending-per-capita.tsx` | Concept 18: Spending per Capita |
| `app/src/components/lab/h6/regeling-profile.tsx` | Concept 19: Regeling Profile |
| `app/src/components/lab/h6/leaderboard.tsx` | Concept 20: Leaderboard |
| `app/src/components/lab/h6/head-to-head.tsx` | Concept 21: Head-to-Head |
| `app/src/app/api/v1/inzichten/top-tabellen/route.ts` | BFF: Ranked tables by dimension |
| `app/src/components/lab/h6/top-tabellen.tsx` | Concept 22: Top Tabellen |
| `app/src/app/api/v1/inzichten/chord/route.ts` | BFF: Ministry ↔ recipient bilateral matrix |
| `app/src/app/api/v1/inzichten/bump-chart/route.ts` | BFF: Ranking positions per year |
| `app/src/app/api/v1/inzichten/alluvial/route.ts` | BFF: 4-stage categorical flow |
| `app/src/app/api/v1/inzichten/network/route.ts` | BFF: Nodes + edges for force-directed |
| `app/src/app/api/v1/inzichten/beeswarm/route.ts` | BFF: All entities with amounts + distribution |
| `app/src/app/api/v1/inzichten/marimekko/route.ts` | BFF: Ministry size × recipient segments |
| `app/src/components/lab/h6/chord-diagram.tsx` | Concept 23: Chord Diagram |
| `app/src/components/lab/h6/bump-chart.tsx` | Concept 24: Bump Chart |
| `app/src/components/lab/h6/alluvial.tsx` | Concept 25: Alluvial (Het Pad van het Geld) |
| `app/src/components/lab/h6/network-graph.tsx` | Concept 26: Network Graph |
| `app/src/components/lab/h6/beeswarm.tsx` | Concept 27: Beeswarm |
| `app/src/components/lab/h6/marimekko.tsx` | Concept 28: Marimekko |
| `scripts/sql/073-rls-campaigns-media.sql` | RLS on campaigns, campaign_events, email_media |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/lab/h6/index.tsx` | 18 new lazy imports, 18 new tabs (9→28), 18 concept cards, 18 tab content sections |
| `logs/SESSION-CONTEXT.md` | V5.0 lab 9→28 concepts, bug fixes, novel graphs |
| `docs/VERSIONING.md` | V5.0 section: 28 lab prototypes, novel graph types |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Recharts Tooltip formatter type errors | Removed explicit type annotations, use inferred types with `Number(value \|\| 0)` |
| Sankey custom node type mismatch | Used `any` type with eslint-disable for Recharts internal prop shape |
| Ministry Cost Structure empty chart | BFF selected single year column instead of all year columns. Fixed select + added error state |
| Spending Velocity crash on click | BFF/frontend mismatch: missing `avg_change`, `volatility`, `summary`. Field name mismatches. All aligned |
| Sunburst no zoom | Click handler missing despite "klik om in te zoomen" description. Added full zoom navigation with breadcrumb |

---

## Next Steps

[To be completed at /closeday]

---

**Session Status:** In Progress
