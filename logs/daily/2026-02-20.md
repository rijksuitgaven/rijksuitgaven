# Daily Log — 2026-02-20

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 8 — Marketing Pages & Final Polish (Day 4)
**Session Duration:** 7 sessions

---

## Summary

Session 1: UX-037 Concept E-mails — draft save/edit/delete for `/team/mail`. Session 2: Legal entity name update — all references changed from Het Maven Collectief to Rijksuitgaven.nl (new handelsnaam, same KVK). Session 3: Database column naming audit — expert panel confirmed all inconsistencies (begrotingsjaar vs jaar, bedrag vs totaal_avg, etc.) are safely abstracted by MODULE_CONFIG. No changes needed. Session 4: Typesense autocomplete fix — "wolfwerend" bug investigation revealed non-primary fields missing `facet:true` in Typesense schema (required for `group_by`). Fixed 4 fields, added 4 missing fields, re-synced all 7 collections on production (2.09M documents verified). Session 5: UX-038 "Ook in" column — renamed "Gevonden in" → "Ook in", added SQL enrichment query so rows matching on primary field (name) also show secondary field context (e.g., Regeling). Empty cell instead of confusing "-" dash. Session 6: Beta welcome email — rewritten for existing contacts who know the product. "Welkom bij Rijksuitgaven 2.0", beta URL callout with "Bewaar dit adres", no pitch copy. Session 7: Welcome email polish — removed beta URL callout block, combined expiry notice with renewal instructions above divider.

---

## Work Completed

### Session 1: UX-037 Concept E-mails (1 commit)
1. **SQL migration 063** — `status TEXT NOT NULL DEFAULT 'sent'` on campaigns table, `sent_at` made nullable (NULL for drafts), `updated_at TIMESTAMPTZ` for edit tracking, index on `(status, updated_at DESC)`
2. **Drafts API** — `POST /api/v1/team/mail/drafts` (save new draft), `PUT /api/v1/team/mail/drafts/[id]` (update existing, only drafts), `DELETE /api/v1/team/mail/drafts/[id]` (delete draft only). All admin-only with CSRF checks.
3. **Send route updated** — accepts optional `draftId` param. If provided, converts draft to sent campaign (update status+sent_at) instead of creating new row.
4. **Campaigns list updated** — returns `status` and `updated_at` fields, orders drafts before sent.
5. **Frontend rewrite** — "Opslaan als concept" button (changes to "Concept bijwerken" when editing). Draft indicator bar with "Nieuw bericht starten" link. Compose tab label changes to "Concept bewerken". Campaigns tab split into Concepten (amber badge, "Bewerken" button, "Laatst bewerkt" timestamp) and Verzonden (existing behavior with "Sjabloon" button). Segment badges on all items. Save success flash (green checkmark, 3s). Sending a draft clears editingDraftId. Deleting a draft in campaigns tab clears editor if that draft was loaded.
6. **Requirement entry** — UX-037 added to search-requirements.md

### Session 2: Legal Entity Name Update (1 commit)
1. **Handelsnaam change** — "Het Maven Collectief" → "Rijksuitgaven.nl" across all user-facing files (same KVK: 96257008)
2. **Voorwaarden** (3 changes) — Dienstverlener definition simplified, invoice text, contact footer
3. **Privacybeleid** (2 changes) — verwerkingsverantwoordelijke text simplified, contact footer
4. **Email templates** (2 changes) — campaign-template.ts and campaign-template.html footers
5. **Supabase templates** — magic-link.html and invite-user.html checked, already clean (no Maven references)

### Session 3: Database Column Naming Audit (no changes)
1. **Expert panel** — 4-person team (Database Architect, Data Model Consistency Engineer, Backend Integration Lead, Adversarial Strategist)
2. **6 inconsistencies audited** — `begrotingsjaar` vs `jaar`, `ontvanger` vs `kostensoort` vs `leverancier`, `bedrag` vs `totaal_avg`, amount units (×1000 vs absolute), staffel type (INT vs VARCHAR), key column naming
3. **Verdict: no changes needed** — MODULE_CONFIG abstracts all differences via `year_field`, `amount_field`, `primary_field`, `amount_multiplier`. Frontend never sees raw column names. Zero hardcoded assumptions in query paths.
4. **Risk assessment** — renaming would require ALTER TABLE on 3.1M rows + 7 materialized view rebuilds for zero user-facing benefit

### Session 4: Typesense Autocomplete Fix (1 commit)
1. **Bug report** — searching "wolfwerend" in Provincie autocomplete showed "Geen resultaten" despite table showing matches in Omschrijving field
2. **Root cause** — Typesense `group_by` requires `facet: true` on fields. Four fields (`omschrijving` in provincie/gemeente/publiek, `detail` in apparaat) lacked this flag, causing silent errors caught as exceptions → empty field_matches → false "Geen resultaten"
3. **Additional gap** — instrumenten missing `artikelonderdeel` and `detail` from Typesense index; publiek missing `trefwoorden` and `sectoren`
4. **Fix — collections.json** — added `facet: true` to 4 existing fields, added 4 new field definitions
5. **Fix — sync_to_typesense.py** — added missing columns to instrumenten and publiek SQL queries + document builders
6. **Fix — modules.py** — updated `TYPESENSE_SEARCHABLE_FIELDS` and `TYPESENSE_SEARCH_FIELDS` dicts with new fields
7. **Production re-sync** — all 7 collections re-synced with `--recreate` (2,092,889 total documents, all audit-verified)
8. **Verification** — `group_by=omschrijving` query on provincie for "wolfwerend" now returns 450 hits (was erroring)
9. **Docs** — added V7.2 TenderNed Procurement Integration to VERSIONING.md

### Session 5: UX-038 "Ook in" Column Enrichment (1 commit)
1. **Problem** — "Gevonden in" column showed "-" for rows where search matched the primary field (ontvanger name), even when secondary fields (regeling, omschrijving) also contained the search term. Users read "-" as "not found" — broken UX promise.
2. **Expert panel brainstorm** — 5-person team (Data Table UX Lead, Search Relevance Engineer, Information Architecture Lead, Frontend Performance Engineer, Adversarial Strategist). Evaluated 4 approaches. Unanimous: SQL enrichment + rename.
3. **Backend — `_enrich_matched_info()`** — new function in modules.py. After Typesense finds primary keys, runs one SQL query with LATERAL JOIN + CASE WHEN chain to check all secondary fields for the search term. Only for rows without existing matched_info. ~20-50ms, graceful degradation on failure.
4. **Frontend — column rename** — "Gevonden in" → "Ook in". Empty cell (`null`) instead of "-" dash when no secondary match. Info tooltip and support page text updated.
5. **Requirement** — UX-038 added to search-requirements.md, UX-002d updated to reflect rename.

### Session 6: Beta Welcome Email (1 commit)
1. **Context** — beta testers are existing contacts who know Rijksuitgaven. No pitch needed, just access info.
2. **Subject** — "Welkom bij Rijksuitgaven — log direct in" → "Rijksuitgaven 2.0 Beta — uw toegang"
3. **Heading** — "Welkom bij Rijksuitgaven" → "Welkom bij Rijksuitgaven 2.0"
4. **Intro** — removed pitch copy, replaced with "De beta van Rijksuitgaven 2.0 is klaar om te testen."
5. **Beta URL callout** — new section: "Uw toegang: beta.rijksuitgaven.nl / Bewaar dit adres — de beta is alleen hier beschikbaar."
6. **Dutch copywriter review** — formal u/uw, no jargon, warm but concise

### Session 7: Welcome Email Polish (1 commit)
1. **Removed "Uw toegang" block** — beta URL callout ("Bewaar dit adres — de beta is alleen hier beschikbaar") removed per user feedback
2. **Combined expiry + renewal** — "Deze link is een uur geldig" merged with "Link verlopen? Ga naar..." into single paragraph
3. **Moved above divider** — combined text placed above the divider, between CTA button and desktop note

---

## Files Created

| File | Description |
|------|-------------|
| `app/src/app/api/v1/team/mail/drafts/route.ts` | Save new email draft |
| `app/src/app/api/v1/team/mail/drafts/[id]/route.ts` | Update/delete existing draft |
| `scripts/sql/063-campaign-drafts.sql` | Draft support: status, nullable sent_at, updated_at |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/app/team/mail/page.tsx` | Full rewrite: draft save/edit/delete, Concepten/Verzonden split, segment badges, draft indicator bar |
| `app/src/app/api/v1/team/mail/send/route.ts` | Optional `draftId` param, draft-to-sent conversion |
| `app/src/app/api/v1/team/mail/campaigns/route.ts` | Returns status + updated_at, orders drafts first |
| `02-requirements/search-requirements.md` | UX-037 requirement entry added |
| `app/src/app/voorwaarden/page.tsx` | Het Maven Collectief → Rijksuitgaven.nl (3 locations) |
| `app/src/app/privacybeleid/page.tsx` | Het Maven Collectief → Rijksuitgaven.nl (2 locations) |
| `app/src/app/api/_lib/campaign-template.ts` | Email footer: Het Maven Collectief → Rijksuitgaven.nl |
| `assets/email-templates/campaign-template.html` | Email template footer updated |
| `CLAUDE.md` | UX counter updated to UX-038 |
| `scripts/typesense/collections.json` | Added `facet: true` to 4 fields, added 4 new field definitions (artikelonderdeel, detail, trefwoorden, sectoren) |
| `scripts/typesense/sync_to_typesense.py` | Added missing columns to instrumenten + publiek SQL queries and document builders |
| `backend/app/services/modules.py` | Updated TYPESENSE_SEARCHABLE_FIELDS and TYPESENSE_SEARCH_FIELDS with new fields |
| `docs/VERSIONING.md` | Added V7.2 TenderNed Procurement Integration |
| `backend/app/services/modules.py` | Added `_enrich_matched_info()` SQL enrichment, wired into `_get_from_aggregated_view()`, updated comments |
| `app/src/components/data-table/data-table.tsx` | "Gevonden in" → "Ook in", empty cell instead of "-", info tooltip updated |
| `app/src/components/data-table/expanded-row.tsx` | Comment update (Gevonden in → Ook in) |
| `app/src/app/support/page.tsx` | Support page text updated to reference "Ook in" |
| `02-requirements/search-requirements.md` | UX-038 added, UX-002d updated |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | Beta 2.0 welcome email copy rewrite + polish (removed URL callout, combined expiry+renewal) |

---

## SQL Migrations

| Migration | Description | Executed |
|-----------|-------------|----------|
| `063-campaign-drafts.sql` | status column, nullable sent_at, updated_at on campaigns | Yes |

---

## Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| Database column names left as-is | MODULE_CONFIG abstracts all differences; renaming = high risk, zero benefit |
| Legal entity = Rijksuitgaven.nl | New handelsnaam under same KVK 96257008 |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Provincie/gemeente/publiek autocomplete "Geen resultaten" for non-primary field matches | Added `facet: true` to omschrijving fields in Typesense schema (required for `group_by`) |
| Apparaat autocomplete missing detail field matches | Added `facet: true` to detail field in Typesense schema |
| Instrumenten autocomplete missing artikelonderdeel + detail | Added fields to collections.json, sync script, and backend search field dicts |
| Publiek autocomplete missing trefwoorden + sectoren | Added fields to collections.json, sync script, and backend search field dicts |
| "Gevonden in" column showing "-" for primary+secondary matches | Renamed to "Ook in", added SQL enrichment to show secondary field context |

---

## Next Steps

- Update Supabase Dashboard email templates (magic-link, invite-user) if they reference Het Maven Collectief
- Continue V1.0 pre-launch prep
- Test draft save/edit/delete flow on production

---

**Commits:** 10 (`0dd5e5f`, `634ac74`, `b6e6c0e`, `fc52cb7`, `baf6c51`, `3533b36`, `61079d5`, `1f8cf96`, `4c52862`, `178d83e`)
**Session Status:** Complete
