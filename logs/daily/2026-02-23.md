# Daily Log — 2026-02-23

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 8+ — Pre-Launch Polish & Beta Feedback
**Session Duration:** [to be filled at /closeday]

---

## Summary

Critical production bug-fix + email deliverability session. Found and fixed 6 production issues spanning frontend, backend, and configuration. Reverted UX-039 (Vergelijk/Pin) from production, fixed broken Totaal sort across all modules, fixed source table year inflation, restored Kolommen functionality with cascade filters, and fixed missing Publiek data caused by non-existent column reference. Added systemic prevention mechanisms (staging-only feature registry, SORT_FIELD_MAP, Sort Field Contract). Then full email deliverability overhaul: changed all From addresses from noreply@ to contact@, added plain-text multipart to all emails, added Reply-To headers, and DNS changes (DMARC rua, SPF -all).

---

## Work Completed

### 1. Email Template Polish
- Width 480px → 600px, body font 15px → 16px
- Auto-link prevention with zero-width spaces in URLs within copy text

### 2. UX-039 Reverted from Production
- **Issue:** UX-039 (Vergelijk/Pin) was on production despite being staging-only
- **Root cause:** Commit `d2e61dd` was on main branch, never reverted
- **Fix:** `git revert d2e61dd` (commit `8739ed1`), merged into staging preserving UX-039 there

### 3. Staging-Only Feature Registry (CLAUDE.md)
- Added registry table with code markers for staging-only features
- Added pre-push checklist (grep for staging-only markers)
- Added post-push verification steps
- General mechanism: not just UX-039, any future staging-only feature

### 4. Totaal Sort Fix (ALL modules affected)
- **Issue:** Clicking "Totaal" column to sort returned stale/random data with misleading pink sort indicator
- **Root cause:** Frontend column ID `'total'` sent as `sort_by=total`, backend only accepts `'totaal'` — silent 400 error
- **Fix:** Added `SORT_FIELD_MAP` in `handleSortChange` mapping `total` → `totaal`
- **Prevention:** Centralized sort mapping, `console.warn` in dev for unmapped columns, Sort Field Contract documented in CLAUDE.md and FRONTEND-DOCUMENTATION.md

### 5. Source Table Year Inflation Fix
- **Issue:** Source table path `SUM(bedrag)` included 2025+ data (e.g., AKWA GGZ: 28M vs 22M in view)
- **Fix:** 4 places in `_get_from_source_table` now use `SUM(CASE WHEN year BETWEEN 2016 AND 2024 ...)`

### 6. Kolommen + Cascade Filters Fix (UX-006 revised)
- **Issue 1:** Kolommen button hidden when cascade filters active (`!hasActiveFilters` gate)
- **Fix 1:** Removed the gate — Kolommen always visible (commit `ee8f6d6`)
- **Issue 2:** Column selector opens but selections have no effect when filters active
- **Root cause:** `effectiveColumns` completely replaced `selectedColumns` with `activeFilterColumns`
- **Fix 2:** `effectiveColumns` now uses `selectedColumns` directly — user controls columns via Kolommen (commit `31a7d2a`)
- **Cleanup:** Removed unused `hasActiveFilters` prop from DataTable

### 7. Publiek Zero Results Fix
- **Issue:** Publiek module showed "Geen resultaten gevonden" when Regio (RVO) column selected
- **Root cause:** `extra_columns` config and column-selector used `regio`, but actual DB column is `provincie`
- **Fix:** Changed `regio` → `provincie` in backend config + frontend column-selector (commit `0705168`)
- Cleaned up stale `regio` from `ALLOWED_COLUMNS`

### 8. Email Deliverability Overhaul
- **Issue:** Transactional emails hitting spam on Hotmail, Outlook, and Gmail
- **Team diagnosis:** 5 issues identified (DMARC blind, SPF contradiction, no plain-text, noreply@ sender, no Reply-To)
- **Fix 1 (DNS):** DMARC `rua=mailto:dmarc@rijksuitgaven.nl` for reporting visibility
- **Fix 2 (DNS):** SPF `~all` → `-all` to align with DMARC `p=reject`
- **Fix 3 (Code):** Changed all From addresses from `noreply@` to `contact@rijksuitgaven.nl` (8 routes + events)
- **Fix 4 (Code):** Added plain-text multipart to all emails (`renderCampaignEmailText()` utility + manual text for transactional)
- **Fix 5 (Code):** Added `replyTo: 'contact@rijksuitgaven.nl'` to campaigns, sequences, test emails
- Commit `f2da739`, deployed to both environments

---

## Files Created

| File | Description |
|------|-------------|

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/data-table/data-table.tsx` | UX-039 revert, removed `hasActiveFilters` prop |
| `app/src/components/module-page/module-page.tsx` | `SORT_FIELD_MAP`, `effectiveColumns` fix, removed `hasActiveFilters` prop |
| `app/src/components/column-selector/column-selector.tsx` | `regio` → `provincie` |
| `backend/app/services/modules.py` | Year range fix (4 places), `regio` → `provincie` in config + ALLOWED_COLUMNS |
| `CLAUDE.md` | Staging-only feature registry, Sort Field Contract |
| `docs/FRONTEND-DOCUMENTATION.md` | Sort Field Contract documentation |
| `app/src/app/api/_lib/campaign-template.ts` | Added `renderCampaignEmailText()` plain-text utility |
| `app/src/app/api/v1/auth/magic-link/route.ts` | `contact@`, plain-text part |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | `contact@`, plain-text part |
| `app/src/app/api/v1/team/mail/send/route.ts` | `contact@`, plain-text, Reply-To |
| `app/src/app/api/v1/cron/sequences/route.ts` | `contact@`, plain-text, Reply-To |
| `app/src/app/api/v1/team/mail/test/route.ts` | `contact@`, plain-text, Reply-To |
| `app/src/app/api/v1/feedback/route.ts` | `contact@`, plain-text part |
| `app/src/app/api/v1/contact/route.ts` | `contact@` (already had plain-text) |
| `app/src/app/api/v1/events/route.ts` | `contact@` (already had plain-text) |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| UX-039 on production | Reverted commit, added staging-only registry to CLAUDE.md |
| Totaal sort broken (all modules) | `SORT_FIELD_MAP` mapping `total` → `totaal` |
| Source table 2025+ year inflation | `CASE WHEN year BETWEEN 2016 AND 2024` in 4 places |
| Kolommen hidden with filters | Removed `!hasActiveFilters` gate |
| Kolommen selections ignored with filters | `effectiveColumns` uses `selectedColumns` directly |
| Publiek zero results with Regio column | Column name `regio` → `provincie` (matches actual DB) |
| Emails hitting spam (Hotmail/Outlook/Gmail) | noreply→contact@, plain-text multipart, Reply-To, DNS fixes |

---

## Next Steps

- Verify email deliverability after DNS changes propagate (send test to Hotmail/Outlook/Gmail)
- Onboarding email sequence implementation (5 emails ready)
- Homepage copy optimization (remaining value props)
- User migration (~50 WordPress users)

---

**Session Status:** Paused
