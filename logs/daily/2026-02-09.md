# Daily Log - 2026-02-09

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** V1 Feature Close Review + Week 6 Preparation
**Session Duration:** [to be filled]

---

## Summary

Three improvements: (1) UX-023 — Custom GroupingSelect dropdown with counts in expanded row, replacing native `<select>` with styled dropdown matching filter panel design. Full-stack: backend endpoint + BFF + frontend component. (2) Autocomplete performance — reduced debounce 150ms→50ms, parallelized all Typesense calls via asyncio.gather (5 sequential calls → 1 parallel batch). Perceived latency ~330ms→~110ms. (3) Typesense data enrichment (moved from V1.1 to V1.0) — enriched recipients collection with year amounts (y2016-y2024), years_with_data, record_count. Integraal search now uses Typesense hybrid pattern (~100-150ms warm, was ~200ms regex).

---

## Work Completed

### Session 1: UX-023 — GroupingSelect Dropdown with Counts

**Full-stack implementation:**

1. **Backend service** (`services/modules.py`): Added `GROUPABLE_FIELDS` dict and `get_grouping_counts()` async function — single SQL query with `COUNT(DISTINCT field)` per groupable field
2. **Backend API** (`api/v1/modules.py`): New `GET /{module}/{primary_value}/grouping-counts` endpoint, returns `dict[str, int]`
3. **BFF proxy** (`grouping-counts/route.ts`): New Next.js API route proxying to backend
4. **Frontend** (`expanded-row.tsx`): `GroupingSelect` component replacing native `<select>` — custom single-select dropdown with counts, checkmark on selected, chevron rotation, click-outside/escape-to-close

**Styling iterations:**
- Initial: `border-[var(--border)]` (too invisible on gray background)
- v2: `border-[var(--navy-medium)]/40` (too prominent when open)
- v3: `border-[var(--muted-foreground)]/30` (still not visible enough in closed state)
- v4: `border-[var(--border)]` exact match (still invisible)
- **Final: `border-[var(--muted-foreground)]`** — same `#436FA3` color as tree connectors (`├` `└`), creating visual cohesion

**Deployed to production** via Railway auto-deploy.

### Session 2: Autocomplete Performance Optimization

**Analysis:** Expert team investigation identified two bottlenecks:
1. **Debounce too high** — 150ms delay before any request fires (half the perceived latency)
2. **Sequential Typesense calls** — 5 serial network round-trips (~220ms) when all are independent

**Changes:**
1. **Debounce 150ms → 50ms** — saves ~100ms perceived latency. AbortController prevents request pile-up.
2. **Module autocomplete parallelized** — primary search + 3 field searches + recipients search all fire via `asyncio.gather()`, results processed sequentially after
3. **Global autocomplete parallelized** — `search_recipients()` + `search_keywords()` run via `asyncio.gather()`. Inside `search_keywords()`, 4 collection searches also parallelized.

**Results:** ~55% faster perceived autocomplete (330ms → ~110ms estimated).

**Deployed to production** via Railway auto-deploy.

### Session 3: Typesense Data Enrichment (Moved V1.1 → V1.0)

**Analysis:** Adversarial strategist team evaluated two Typesense improvements:
1. **Typesense data enrichment** — Store year amounts in recipients collection so integraal uses Typesense hybrid search instead of regex → **FEASIBLE, implemented**
2. **Typesense facets for cascading filters** — Use Typesense faceting for filter dropdowns → **NOT FEASIBLE** (Typesense collections are per-module with different schemas, facets can't replace PostgreSQL DISTINCT on source tables)

**Changes:**

1. **Typesense schema** (`collections.json`): Added 11 fields to recipients collection — y2016-y2024 (int64, optional), years_with_data (int32, facet), record_count (int32)
2. **Sync script** (`sync_to_typesense.py`): Updated SQL to include COALESCE year columns from universal_search view, updated document mapping
3. **Backend** (`services/modules.py`): New `_typesense_search_recipient_keys()` helper — searches recipients collection, returns ontvanger_key IDs with word-boundary filtering. Modified `get_integraal_data()` to use Typesense hybrid search (WHERE ontvanger_key = ANY($1)) with regex fallback.

**Re-sync:** Recipients collection re-synced on production — 463,731 documents with enriched data. All 7 collections pass audit (exact match with PostgreSQL).

**Production timing (warm):**

| Query | `elapsed_ms` |
|-------|-------------|
| prorail | 115ms |
| amsterdam | 152ms |
| shell | 99ms |
| klm | 97ms |

Improvement: ~50-100ms faster than regex baseline (~200ms).

**Deployed to production** via Railway auto-deploy.

---

## Files Created

| File | Description |
|------|-------------|
| `app/src/app/api/v1/modules/[module]/[value]/grouping-counts/route.ts` | BFF proxy route for grouping counts endpoint |

## Files Modified

| File | Changes |
|------|---------|
| `backend/app/services/modules.py` | Added `GROUPABLE_FIELDS` dict + `get_grouping_counts()` function |
| `backend/app/api/v1/modules.py` | Added `get_grouping_counts` import + new endpoint |
| `app/src/components/data-table/expanded-row.tsx` | Replaced native `<select>` with `GroupingSelect` component, added counts fetch |
| `app/src/components/filter-panel/filter-panel.tsx` | Debounce 150ms → 50ms |
| `backend/app/services/modules.py` | Parallelized all Typesense calls in `get_module_autocomplete()` via `asyncio.gather` |
| `backend/app/api/v1/search.py` | Parallelized `search_recipients` + `search_keywords`, parallelized 4 keyword searches internally |
| `scripts/typesense/collections.json` | Added y2016-y2024, years_with_data, record_count to recipients schema |
| `scripts/typesense/sync_to_typesense.py` | Updated SQL + doc mapping for year amounts from universal_search |
| `backend/app/services/modules.py` | Added `_typesense_search_recipient_keys()` + integraal hybrid search |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Native `<select>` inconsistent with filter panel styling | Custom `GroupingSelect` matching MultiSelect design |
| No counts shown per grouping option | New backend endpoint with `COUNT(DISTINCT)` per field |
| BFF import path wrong (6 levels instead of 5) | Fixed to `../../../../../_lib/proxy` |
| Dropdown border invisible on gray background | Matched border color to tree connector color (`--muted-foreground`) |
| Autocomplete feels slow on first keystrokes | Debounce 150ms→50ms + parallel Typesense calls |
| 5 sequential Typesense calls in module autocomplete | `asyncio.gather()` fires all in parallel |
| 4 sequential keyword searches in global autocomplete | `asyncio.gather()` fires all in parallel |
| Integraal search uses slow regex (~200ms) | Typesense hybrid: keys lookup (~25ms) + WHERE IN (~75ms) |
| Recipients Typesense collection missing year data | Added y2016-y2024, years_with_data, record_count (463,731 docs) |
| Typesense facets for cascading filters not feasible | Per-module schemas incompatible with faceting; kept PostgreSQL DISTINCT |
| Railway deployment "Failed to snapshot repository" | Transient Railway infra issue; resolved by next push |

---

## Next Steps

- V1 Feature Close Review (check backlog and sprints)
- Week 6: User Authentication (Magic Link)
- Pre-launch: rate limiting + backend auth/network isolation
- V1.1: Type-ahead prefetch on focus (deferred from today)

---

**Session Status:** In Progress
