# Daily Log â€” 2026-02-22

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 8+ â€” Pre-Launch Polish & Beta Feedback

---

## Summary

Massive 13-session day spanning the full email/campaign stack. Sessions 1-3: Email Media Library, deployment protocol fix (UX-039 revert), SPF deliverability fix. Session 4: 13 professional campaign features across 6 phases (webhook, pre-send, analytics, engagement, sequences, preferences) â€” 6 SQL migrations (066-071), 23 new route/page files. Session 5: Help popovers + sequence step full compose experience. Sessions 6-8: Cron debugging, UX-039 tooltip fix (Radix Portal), staging protocol + "doel door doen" copywriting principle. Session 9: Homepage copy + onboarding email sequence design (5 emails). Session 10: Team nav fix, conditional segment builder (AND/OR targeting, migration 072). Session 11: Campaign detail view upgrade (KPI bar, header card, recipient filters/sort). Session 12: Email system polish (template fixes, editor autolink/unlink, test email input, segment counting bug, Mail 1 copy, CLAUDE.md Rule 0). Session 13: VERSIONING.md per-feature status tracking + UTM builder, Railway cron-sequences 401 fix (Docker exec-form doesn't expand env vars â€” hardcoded secret), CRON_SECRET rotation.

---

## Work Completed

### Session 1: Email Media Library (Admin Feature)

1. **SQL migration 065-email-media.sql** â€” `email_media` table with soft delete, 3 indexes (created_at, uploaded_by, filename)
2. **Sharp image processing pipeline** â€” installed `sharp` dependency, upload route now:
   - Reads metadata (width, height, format)
   - Generates optimized version (max 960px wide, JPEG quality 85, strips EXIF)
   - Generates 200Ã—200 thumbnail for grid display
   - Inserts row in `email_media` with dimensions, size, mime_type
   - Returns enriched response (id, url, thumbnailUrl, dimensions)
3. **Soft delete** â€” DELETE endpoint now sets `deleted_at` instead of removing from storage
4. **GET /api/v1/team/mail/media** â€” new endpoint listing all active media, supports `?filenames=` for draft image restoration
5. **Media picker popover** â€” image toolbar button opens picker with "Upload nieuw" + thumbnail grid of existing media
6. **Media tab** â€” third tab on mail page (compose | campaigns | media) with upload zone + grid
7. **Draft image restoration** â€” when editing a draft, parses HTML for image URLs, fetches metadata from DB, restores thumbnail strip
8. **MAX_WIDTH adjusted** â€” 1200px â†’ 960px (2Ã— retina for 480px email content area)

### Session 2: Deployment Protocol Fix

1. **Identified UX-039 (PIN/vergelijk) on production** â€” was supposed to be staging-only
2. **Reverted UX-039 from main** â€” 4 code commits reverted, docs kept (harmless)
3. **Cherry-picked UX-039 back to staging** â€” feature remains testable on staging
4. **Updated CLAUDE.md** â€” new "Staging & Deployment Protocol" section with:
   - Deployment Decision Gate (mandatory before every push)
   - Three-tier routing: admin features â†’ both, small fixes â†’ ask, new user features â†’ staging only
   - Batch release workflow for user-facing features

### Session 3: Email Deliverability (DNS)

1. **Diagnosed SPF failure** â€” root record had `include:rijksuitgaven.nl` (self-reference = no-op)
2. **Identified correct SPF** â€” `v=spf1 mx a include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev ~all`
3. **Verified Resend DNS** â€” DKIM, send MX, send SPF all verified in Resend dashboard
4. **Guided DNS cleanup** â€” removed old SPF, stray root DKIM key, verified via authoritative nameserver
5. **Confirmed DMARC** â€” `p=reject; sp=reject;` already strict and correct

### Session 4: Professional Campaign Features (13 Features, 6 Phases)

Research plan: `docs/plans/2026-02-22-campaign-features-research.md`

**Phase 1: Webhook Enhancement (Foundation)**
1. SQL migration `066-bounce-suppress.sql` â€” added `bounced_at`, `bounce_type` to `people` + index
2. SQL migration `067-campaign-event-ua.sql` â€” added `user_agent`, `ua_client`, `ua_device`, `ua_os` to `campaign_events` + index
3. Webhook route: hard bounce â†’ sets `people.bounced_at` + `bounce_type`; complaint â†’ sets `people.unsubscribed_at`
4. Send route: filters out bounced people from recipients
5. Installed `ua-parser-js` (v2) â€” used `require()` with type cast (v2 API is function, not constructor)

**Phase 2: Pre-Send Quality**
6. New route `team/mail/test` â€” sends test email to admin with `[TEST]` prefix
7. New route `team/mail/precheck` â€” 5-area pre-send checklist (Inhoud, Links, Afbeeldingen, Authenticatie, Ontvangers)
8. Device preview â€” 3 toggle buttons (Desktop/Tablet/Mobile) on compose preview

**Phase 3: Campaign Analytics Enhancement**
9. Modified `campaigns/[id]` route â€” added `link_stats` (per-link click counts) and `device_stats` (client/device/OS breakdown)
10. New route `campaigns/compare` â€” side-by-side comparison of 2-4 campaigns with computed rates

**Phase 4: Subscriber Intelligence**
11. SQL migration `068-engagement-scoring.sql` â€” 2 SQL functions for engagement scoring
12. New route `team/leden/[id]/timeline` â€” per-person email timeline with engagement data
13. New route `team/leden/engagement` â€” bulk engagement scores for all persons
14. New page `team/leden/[id]/page.tsx` â€” member detail with timeline, engagement badge, subscription info
15. Modified `team/leden/page.tsx` â€” clickable member names, engagement badge column

**Phase 5: Sequence Engine**
16. SQL migration `069-email-sequences.sql` â€” 4 new tables (sequences, steps, enrollments, sends) + indexes + RLS
17. SQL migration `070-campaign-events-sequence-cols.sql` â€” sequence_id/step_id on campaign_events, campaign_id nullable
18. CRUD routes for sequences, steps, manual enrollment (5 new route files)
19. Cron route `cron/sequences` â€” hourly processor, CET-aware, weekday-only, rate-limited
20. `sequence-enrollment.ts` helper â€” auto-enrolls on invite
21. Modified invite route for auto-enrollment
22. Sequences tab on mail page â€” list, create, expand detail, manage steps, enrollment table

**Phase 5b: Infrastructure**
23. Guided Railway cron service setup: `curlimages/curl` Docker image, `CRON_SECRET` env var, schedule `0 7-16 * * 1-5`

**Phase 6: Preference Center**
24. SQL migration `071-email-preferences.sql` â€” `email_topics` + `email_preferences` tables, topic_id FK on campaigns/sequences, seed data
25. Topic CRUD routes (GET/POST + PATCH/DELETE)
26. Public preference API `preferences` (GET/POST) â€” secured by unsubscribe_token, rate limited
27. Public page `/voorkeuren` â€” toggle switches per topic, unsubscribe all, re-subscribe
28. Modified campaign template â€” "Voorkeuren beheren" link in email footer
29. Modified send route â€” topic preference filtering (respects opt-out per topic)

**Staging Recovery**
30. Force-push to staging destroyed UX-039 â€” recovered via cherry-pick from old staging ref
31. Updated CLAUDE.md staging protocol: never force-push, always merge

### Session 5: Email Module UX Polish

**Help Popovers**
32. **Compose help popover** â€” HelpCircle icon next to "E-mail" heading, click to show Dutch help text explaining 4 tabs, compose fields, and recommended workflow
33. **Sequences help popover** â€” HelpCircle icon next to "Sequenties" heading, explains what sequences are, setup steps, how they work, with concrete example (Welkom-sequentie)
34. **Click-outside handler** â€” `data-help-popover` attribute pattern for clean popover dismissal

**Sequence Step Upgrade (Full Compose Experience)**
35. **Rich text editor** â€” replaced basic HTML textarea with EmailEditor (Tiptap) component, reusing media library from compose tab
36. **Preheader field** â€” added preheader input for sequence steps (was missing)
37. **Preview panel** â€” device toggle buttons (Desktop/Tablet/Mobile) with responsive iframe preview, reusing renderCampaignEmail template
38. **Pre-send checklist** â€” "Controleer" button runs 5-area precheck (Inhoud, Links, Afbeeldingen, Authenticatie, Ontvangers) on step content
39. **Test email** â€” "Verstuur test" button sends step content as test email to admin with [TEST] prefix
40. **Edit existing steps** â€” clicking a step in the list loads it into the editor form for modification (highlight + Pencil icon)
41. **Save/update flow** â€” "Opslaan" (editing) or "Toevoegen" (new) buttons with loading state

### Session 6: Cron Service Debugging

42. **Diagnosed cron crash** â€” Railway `curlimages/curl` container crashed on startup; deploy log showed only "Starting Container" with no curl output â†’ missing/incorrect start command
43. **Verified start command** â€” `curl -X POST https://beta.rijksuitgaven.nl/api/v1/cron/sequences -H "Authorization: Bearer $CRON_SECRET" -f`
44. **Restarted service** â€” container now ACTIVE
45. **Manual endpoint test** â€” curl returned `{"skipped":true,"reason":"weekend"}` (correct for Saturday)

### Session 7: UX-039 Vergelijk Tooltip Fix (Staging Only)

46. **CSS tooltip attempts** â€” tried `data-tooltip-center` (clipped by `overflow-x:auto` scroll container), `data-tooltip-right` (behind adjacent content), `hover:z-20` on rows (stacking context conflicts)
47. **Root cause identified** â€” CSS `::after` pseudo-element tooltips cannot escape parent `overflow-x:auto` or `z-index` stacking contexts in a complex table layout
48. **Radix Tooltip with Portal** â€” installed `@radix-ui/react-tooltip`, replaced pin/unpin button tooltips with `<Tooltip.Portal>` (renders in `document.body`). Instant (`delayDuration={0}`), same dark navy styling as all other tooltips
49. **Matched tooltip styling** â€” `data-tooltip-center` CSS updated to match `data-tooltip`: padding 6px 10px, font-size 13px, font-weight 400, line-height 1.4

### Session 9: Homepage Copy + Onboarding Email Sequence Design

**Homepage Copy Updates**
52. **Headline restored to V1** â€” "Overheidsbestedingen snel tot in detail doorzoeken en vergelijken" (was "Waar gaat â‚¬1.700 miljard naartoe?")
53. **Subheadline restored to V1** â€” "Rijksuitgaven is hÃ©t onafhankelijke platform voor inzicht in overheidsuitgaven."
54. **Value prop #1 rewritten** â€” "Doel door doen" applied: "Direct zien wie wat ontvangt, doorzoek overheidsuitgaven in seconden."
55. **Subheadline maxWidth** â€” 800px â†’ 900px for single-line fit

**Onboarding Email Sequence Design (5 emails)**
56. **Brainstorm with specialist team** â€” Email Marketing, B2G, B2B Growth, Dutch Copywriter, Adversarial Strategist
57. **Sequence architecture** â€” 5 emails over 11 days (day 0, 2, 4, 7, 11), job-based not feature-based
58. **Mail 1: Welkom** â€” login uitleg (magic link, 4 stappen), 7-dag sessie uitleg, absolute bedragen (1 regel), beta feedback ask
59. **Mail 2: Zoeken** â€” autocomplete, Nederlands (politie voorbeeld), drie zoekmethoden, "Ook in" kolom, integraal
60. **Mail 3: Filteren** â€” cascading filters, klik-to-filter (generiek voorbeeld), kolommen kiezen
61. **Mail 4: Ontdekking** â€” 9 jaar + expand/collapse hint, anomalieÃ«n (50%+ rood), data beschikbaarheid
62. **Mail 5: Details + Export** â€” inline uitklappen, groepering, Google zoeken, Excel/CSV export
63. **Design doc created** â€” `docs/plans/2026-02-22-onboarding-email-sequence.md`

### Session 8: Process & Copywriting Standards

50. **Staging deploy protocol clarified** â€” all pushes to both (admin, hotfix, approved release) use same flow: push main â†’ checkout staging â†’ merge main â†’ push staging. Only staging-only features go directly to staging branch. Saved to persistent memory.
51. **"Doel door doen" writing principle** â€” all external copy must lead with the goal (why), then the means (how). Format: "[Doel] â€” door [doen]". Example: "Sneller vinden wie geld ontvangt â€” door te zoeken in alle databronnen". Saved to persistent memory.

### Session 10: Team Nav Fix + Building Philosophy + Conditional Segment Builder

**Process**
64. **Team nav reorder** â€” moved "Fouten" tab to last position in `team-nav.tsx` (was before "E-mail")
65. **Building philosophy established** â€” "We are building for 500+ users. The guiding principle is perfection and 100% accuracy." Added to CLAUDE.md as mandatory section. NEVER use current user count to deprioritize features.

**Conditional Segment Builder (4 deliverables)**
66. **SQL migration `072-campaign-conditions.sql`** â€” `conditions JSONB` column on campaigns table (nullable), composite index `idx_ce_condition_eval` on campaign_events(campaign_id, event_type, person_id)
67. **Evaluate API route** `POST /api/v1/team/mail/conditions/evaluate` â€” admin-only, evaluates AND/OR conditions against campaign_events + engagement scoring. 4 condition types: campaign_delivered, campaign_opened, campaign_clicked, engagement_level. Supports negation. Returns `{ count, person_ids }`
68. **Modified send route** â€” accepts `conditions` in request, applies conditions filter between segment filter and topic preference filter. Saves conditions to campaign record. Fixed topic filter to use conditioned recipients (not raw segment recipients)
69. **Condition builder UI** â€” toggle button "Condities toevoegen" with Filter icon in compose tab between segments and subject. AND/OR visual indicators, negation toggle (WEL/NIET), condition type selector, campaign/engagement dropdowns. Live debounced evaluation (500ms) showing matching count. Conditions saved in drafts and sent campaigns.

### Session 11: Campaign Detail View Upgrade (P0 + P1)

**Team brainstorm** â€” analyzed 5 screenshots from old email system (campaign header, KPI circles, recipients table, link stats, device breakdown, geo/clickmap). Specialist team (Marco/Email Architect, Daan/Frontend UX, Sara/Marketing Analyst, Lieke/Adversarial) prioritized features. Skipped: geo location (GDPR, 63% unknown), clickmap (no position data from Resend), donut charts (text % faster), author section (single admin).

**P0: KPI Summary Bar + Campaign Header**
70. **KPI summary bar** â€” 5 metric cards (Verzonden, Geopend, Geklikt, Afgemeld, Bounced) with counts and percentages. Blue-50 background, compact grid layout
71. **Campaign header card** â€” subject, sent date (formatted Dutch), preheader, segments in grid layout with labels

**P1: Recipient Filters, Sort, Format**
72. **Recipient filter toggles** â€” filter by status (Bezorgd/Geopend/Geklikt/Bounced/Afgemeld) with live counts per category, `classifyRecipient()` function
73. **Recipient sort controls** â€” dropdown (Naam/Bezorgd/Geopend) + ascending/descending toggle button. Name sort uses `localeCompare('nl')`
74. **Single-line recipient format** â€” full name (first + last) with email on same line, row numbering
75. **API: last_name in response** â€” added `last_name` to people select and recipient mapping in campaign detail route

### Session 13: VERSIONING.md + Cron Fix

**VERSIONING.md Updates**
91. **Per-feature status tracking** â€” all A-track releases (A1.0, A1.1, A1.2, A2.0) now have individual feature status tables with âœ…/ðŸ“‹ indicators
92. **UTM builder added to A1.0** â€” "UTM builder â€” compose UI for UTM parameters, auto-append to CTA + body links" (ðŸ“‹ Planned)

**Cron Sequences Fix (Expert Team Diagnostic)**
93. **Root cause identified** â€” `curlimages/curl` Docker image + Railway exec-form start command = `$CRON_SECRET` passed as literal string `$CRON_SECRET` (never expanded). Route received `Authorization: Bearer $CRON_SECRET` (literal) â†’ 401
94. **Shell wrapper attempt failed** â€” `/bin/sh -c 'curl ...'` crashed instantly because Railway's start command tokenizer breaks on nested single/double quotes
95. **Schedule fixed** â€” cron schedule was `0 * * * *` (every hour, 24/7), changed to `0 7-16 * * 1-5` (weekday work hours only)
96. **Solution: hardcoded secret** â€” replaced `$CRON_SECRET` with actual value in start command. Eliminates all shell expansion issues. Verified: COMPLETED status, green checkmark
97. **CRON_SECRET rotation** â€” secret exposed in chat session, user rotating both services (frontend + cron) with new `openssl rand -hex 32` value

### Session 12: Email System Polish + Process Rules

**Email Template Fixes**
76. **List item spacing** â€” `<p>` inside `<li>` gets `margin: 0` (was inheriting 16px, causing excessive gaps between numbered list items)
77. **Duplicate footer removed** â€” "Rijksuitgaven.nl" appeared twice in email footer (bold link + plain text), removed plain text duplicate
78. **Heading left-aligned** â€” campaign email heading changed from `text-align: center` to `left`
79. **Auto-greeting removed** â€” template no longer inserts "Beste {naam}," automatically; body handles it via `{{voornaam}}` variable for full control
80. **Heading spacing increased** â€” padding-bottom 16px â†’ 28px for better visual separation between heading and body

**Editor Improvements**
81. **Autolink disabled** â€” Tiptap no longer auto-links URLs like "Rijksuitgaven.nl"; links must be added manually
82. **Unlink button added** â€” new toolbar button (enabled when cursor is on a link) to remove hyperlinks

**Test Email Enhancement**
83. **Editable recipient address** â€” "Verstuur test" button now opens inline email input (prefilled, editable) + send button. API accepts optional `email` field, validated, falls back to admin session email

**Segment Counting Bug Fix**
84. **Active subscription determines leden segments** â€” previously required `pipeline_stage = 'gewonnen'` which was never set on invited members. Now any person with active monthly/yearly subscription counts as leden, regardless of pipeline stage. Fixed in both mail route (counts) and send route (recipient filtering)

**Onboarding Email Copy Updates**
85. **Mail 1 preheader updated** â€” "Uw persoonlijke toegang..." â†’ "Uw beta-toegang is actief. Sneller zoeken en preciezer filteren."
86. **Mail 1 body restructured** â€” session persistence line moved under login steps (shorter), "Alle bedragen tot op de euro" as own bold section
87. **Mail 1 series teaser added** â€” "De komende weken ontvangt u 5 korte e-mails... In de volgende e-mail: de nieuwe zoekbalk, resultaten terwijl u typt."

**Sequence Label Fix**
88. **Delay labels** â€” "na inschrijving" â†’ "na uitnodiging" in all 3 occurrences (help popovers + delay input label)

**Process Rules Enforced**
89. **CLAUDE.md Rule 0** â€” "NEVER ACT WITHOUT APPROVAL" added as absolute first golden rule. Approval row added to Quick Check table. Model selection strengthened to every response.
90. **MEMORY.md updated** â€” critical rules strengthened: discussing a direction is NOT approval, model selection every response

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/065-email-media.sql` | Migration: email_media table with soft delete + indexes |
| `app/src/app/api/v1/team/mail/media/route.ts` | GET endpoint: list all active media |
| `scripts/sql/066-bounce-suppress.sql` | Migration: bounced_at + bounce_type on people |
| `scripts/sql/067-campaign-event-ua.sql` | Migration: UA columns on campaign_events |
| `scripts/sql/068-engagement-scoring.sql` | Migration: 2 engagement scoring SQL functions |
| `scripts/sql/069-email-sequences.sql` | Migration: 4 sequence tables + indexes + RLS |
| `scripts/sql/070-campaign-events-sequence-cols.sql` | Migration: sequence_id/step_id on campaign_events |
| `scripts/sql/071-email-preferences.sql` | Migration: email_topics + email_preferences + seed data |
| `app/src/app/api/v1/team/mail/test/route.ts` | Test email to admin |
| `app/src/app/api/v1/team/mail/precheck/route.ts` | Pre-send checklist (5 areas) |
| `app/src/app/api/v1/team/mail/campaigns/compare/route.ts` | Campaign comparison |
| `app/src/app/api/v1/team/leden/[id]/timeline/route.ts` | Per-person email timeline |
| `app/src/app/api/v1/team/leden/engagement/route.ts` | Bulk engagement scores |
| `app/src/app/team/leden/[id]/page.tsx` | Member detail page |
| `app/src/app/api/v1/team/mail/sequences/route.ts` | Sequence CRUD (GET/POST) |
| `app/src/app/api/v1/team/mail/sequences/[id]/route.ts` | Sequence detail (GET/PATCH/DELETE) |
| `app/src/app/api/v1/team/mail/sequences/[id]/steps/route.ts` | Add step (POST) |
| `app/src/app/api/v1/team/mail/sequences/[id]/steps/[stepId]/route.ts` | Step CRUD (PATCH/DELETE) |
| `app/src/app/api/v1/team/mail/sequences/[id]/enroll/route.ts` | Manual enrollment (POST) |
| `app/src/app/api/v1/cron/sequences/route.ts` | Cron handler for sequence processing |
| `app/src/app/api/_lib/sequence-enrollment.ts` | Auto-enrollment helper |
| `app/src/app/api/v1/team/mail/topics/route.ts` | Topic CRUD (GET/POST) |
| `app/src/app/api/v1/team/mail/topics/[id]/route.ts` | Topic detail (PATCH/DELETE) |
| `app/src/app/api/v1/preferences/route.ts` | Public preference API (GET/POST) |
| `app/src/app/voorkeuren/page.tsx` | Public preference center page |
| `docs/plans/2026-02-22-onboarding-email-sequence.md` | Onboarding email sequence design (5 emails) |
| `scripts/sql/072-campaign-conditions.sql` | Migration: conditions JSONB on campaigns + composite index |
| `app/src/app/api/v1/team/mail/conditions/evaluate/route.ts` | Evaluate campaign conditions (AND/OR logic) |

## Files Modified

| File | Changes |
|------|---------|
| `app/package.json` | Added `sharp` + `@types/sharp`, added `ua-parser-js` |
| `app/src/app/api/v1/team/mail/upload/route.ts` | Sharp processing pipeline, DB insert, soft delete, MAX_WIDTH 960px |
| `app/src/components/email-editor/email-editor.tsx` | Enhanced UploadedImage interface, MediaItem type, media picker popover, thumbnailUrl in strip |
| `app/src/app/team/mail/page.tsx` | Media tab, media library state/fetch, draft image restoration, upload zone text, test button, precheck, device preview, sequences tab, topic selector, help popovers, sequence step full compose experience (rich editor, preview, precheck, test, edit) |
| `app/src/components/data-table/data-table.tsx` | UX-039 reverted from main (kept on staging) |
| `CLAUDE.md` | Deployment protocol: decision gate, three-tier routing rules, updated staging protocol (merge, never force-push) |
| `app/src/app/api/v1/webhooks/resend/route.ts` | Bounce/complaint handling + UA parsing |
| `app/src/app/api/v1/team/mail/send/route.ts` | Bounce filter + topic preference filter |
| `app/src/app/api/v1/team/mail/route.ts` | Exclude bounced from segment counts |
| `app/src/app/api/v1/team/mail/campaigns/[id]/route.ts` | Link stats + device breakdown |
| `app/src/app/team/leden/page.tsx` | Clickable names, engagement badges |
| `app/src/app/api/_lib/campaign-template.ts` | Preference center link in footer |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | Auto-enrollment on invite |
| `app/src/components/homepage/homepage.tsx` | Restored V1 headline/subheadline, "doel door doen" value prop |
| `app/src/components/team-nav/team-nav.tsx` | Moved Fouten tab to last position |
| `app/src/app/api/v1/team/mail/send/route.ts` | Added conditions filter (AND/OR targeting) between segment and topic filters |
| `app/src/app/team/mail/page.tsx` | Condition builder UI (toggle, groups, negation, live evaluation); Campaign detail: KPI bar, header card, filter toggles, sort, single-line recipients |
| `app/src/app/api/v1/team/mail/campaigns/[id]/route.ts` | Added last_name to people select + recipient mapping |
| `app/src/app/api/_lib/campaign-template.ts` | List spacing fix, duplicate footer, heading left+spacing, auto-greeting removed |
| `app/src/components/email-editor/email-editor.tsx` | Disabled autolink, added Unlink toolbar button |
| `app/src/app/api/v1/team/mail/test/route.ts` | Accept optional email field for custom test recipient |
| `app/src/app/api/v1/team/mail/route.ts` | Segment counting: active sub determines leden (not pipeline_stage) |
| `app/src/app/api/v1/team/mail/send/route.ts` | Same fix: active sub for leden recipient filtering |
| `app/src/app/team/mail/page.tsx` | Test email inline input, delay labels "na uitnodiging" |
| `docs/plans/2026-02-22-onboarding-email-sequence.md` | Mail 1: preheader, body restructure, series teaser |
| `CLAUDE.md` | Rule 0: never act without approval, model selection every response |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Uploaded images lost on page reload / draft edit | `email_media` table + draft image restoration via URL parsing |
| No way to browse/reuse previously uploaded images | Media tab + media picker popover in editor |
| Orphan files in storage with no tracking | DB tracking on upload, soft delete on removal |
| UX-039 accidentally on production | Reverted from main, cherry-picked to staging |
| Deployment protocol too ambiguous | New CLAUDE.md rules: adminâ†’both, fixesâ†’ask, featuresâ†’staging |
| Magic link emails going to junk | Broken SPF record (self-referencing include) â†’ replaced with correct Resend + ZXCS includes |
| Images too large for email (1200px) | Reduced MAX_WIDTH to 960px (2Ã— retina for 480px email content) |
| ua-parser-js v2 TypeScript error | Used require() with type cast (v2 API is function, not constructor) |
| Force-push destroyed UX-039 on staging | Recovered via cherry-pick, updated protocol to merge-only |
| No guidance for email module usage | Help popovers with Dutch text for compose workflow + sequence setup |
| Sequence steps had basic textarea only | Upgraded to full compose: rich editor, preview, precheck, test email, edit existing |
| TypeScript TS2448: handleSaveStep used before declaration | Moved handleSaveStep after handleExpandSequence in callback ordering |
| Railway cron service crashed on startup | Container had no output â€” restarted, verified endpoint returns correct weekend skip response |
| UX-039 Vergelijk tooltip clipped/hidden by table rows | CSS tooltips can't escape overflow-x:auto â€” switched to Radix Tooltip.Portal (renders in document.body) |
| UX-039 tooltip styling mismatch (smaller padding/font) | Matched `data-tooltip-center` CSS to `data-tooltip` (6px padding, 13px font) |
| Fouten tab not last in team nav | Swapped E-mail and Fouten tab order in team-nav.tsx |
| No way to target campaigns by engagement/past behavior | Conditional segment builder: AND/OR conditions, 4 types, negation, live evaluation |
| Topic filter in send route used wrong recipient list | Fixed to use conditionedRecipients instead of raw segment recipients |
| Excessive spacing between list items in emails | `<p>` inside `<li>` inheriting 16px margin â†’ set to 0 |
| "Rijksuitgaven.nl" duplicated in email footer | Removed plain text duplicate, kept bold link |
| "Beste {naam}," appeared twice in emails | Removed auto-greeting from template; body handles via `{{voornaam}}` |
| Tiptap auto-linking URLs like Rijksuitgaven.nl | Disabled autolink in Link extension config |
| No way to remove a hyperlink in email editor | Added Unlink toolbar button |
| Test email locked to admin's own address | Added editable email input with optional `email` field in API |
| "Leden (jaarlijks)" only showing 3 members | Segment counting required `pipeline_stage='gewonnen'` which was never set; now uses active subscription |
| Sequence delay label said "inschrijving" (ambiguous) | Changed to "uitnodiging" in all 3 occurrences |
| Railway cron-sequences returning 401 on every run | `$CRON_SECRET` not expanded in Docker exec-form start command; hardcoded value directly |
| Cron schedule running 24/7 instead of weekday work hours | Changed `0 * * * *` to `0 7-16 * * 1-5` |
| CRON_SECRET exposed in chat | User rotating with new `openssl rand -hex 32` value on both services |

---

## DNS Changes Made

| Record | Change |
|--------|--------|
| `rijksuitgaven.nl` TXT (SPF) | Replaced `include:rijksuitgaven.nl` with `include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev` |
| `rijksuitgaven.nl` TXT (stray DKIM) | Deleted `k=rsa; p=MIGf...` from root (doesn't belong there) |

---

## Commits

| Hash | Description |
|------|-------------|
| `a77c7cf` | Email Media Library: Sharp processing, DB tracking, media picker + tab |
| `f22fc4c` | Revert media library (mistaken â€” restored immediately) |
| `b075f67` | Reapply media library |
| `f856bd2` | Revert UX-039: Style Wis selectie |
| `e19a826` | Revert UX-039: Move Wis selectie to toolbar |
| `1246ef1` | Revert UX-039: Fix tooltip readability |
| `b7a977b` | Revert UX-039 data-table code from main |
| `df6e1ef` | CLAUDE.md: Deployment protocol |
| `d38cec2` | Email media: MAX_WIDTH 1200â†’960px |
| `c968f8b` | Fix: Betalingen column renders as plain text, not a clickable link |
| `0825746` | Campaign features: 6 phases, 13 features, 6 migrations |
| `ce53267` | Docs: daily log session 4 + database docs + session context |
| `052678c` | Add help popovers to email module (compose + sequences) |
| `443fe11` | Upgrade sequence steps to full compose experience |
| `3059d20` | Docs: daily log session 5 + session context |
| `ea05682` | Docs: comprehensive audit â€” database docs, versioning, daily log |
| `3f6ce7f` | Fix UX-039: Radix Tooltip with portal for pin buttons (staging) |
| `8484cdc` | Docs: daily log sessions 6-7 (cron debugging, UX-039 tooltip fix) |
| `30cf5c0` | Docs: daily log session 8 (deploy protocol, copywriting) |
| `f1a00a6` | Homepage copy: restore V1 headline + "doel door doen" value prop text |
| `1db7c6d` | Docs: onboarding email sequence design (5 emails) |
| `3f92d89` | Docs: daily log session 9 + session context |
| `cfc1ba8` | Move Fouten tab to last position in team nav |
| `31be96c` | Feat: conditional segment builder for campaign targeting (AND/OR logic) |
| `33fdf0a` | Docs: daily log session 10 + session context |
| `dc429b4` | Feat: Campaign detail view upgrade â€” KPI bar, header card, recipient filters/sort |
| `b8211c2` | Docs: daily log session 11 + session context |
| `13bd16d` | Fix: Sequence delay label â€” "na inschrijving" â†’ "na uitnodiging" |
| `aa0226c` | Fix: Email template â€” list spacing, duplicate footer, heading left-align, remove auto-greeting |
| `d14c540` | Fix: Email template heading padding 16px â†’ 28px |
| `09fc89f` | Feat: Test email â€” editable recipient address with inline input |
| `b6567e3` | Fix: Email editor â€” disable autolink, add unlink button |
| `c9363a4` | Fix: Email segments â€” active subscription determines leden, not pipeline_stage |
| `5ba3644` | CLAUDE.md: Rule 0 â€” NEVER act without explicit approval |
| `a7796d4` | Docs: A-track per-feature status tracking + UTM builder in A1.0 |
| `7aee004` | Docs: session 13 â€” cron fix diagnostic + VERSIONING status tracking |

---

## Next Steps

- [ ] Verify DNS propagation (stray DKIM key removal)
- [ ] Test magic link delivery after SPF fix
- [ ] Test media library upload flow on production
- [ ] Test draft image restoration
- [ ] UX-039 (vergelijk) testing on staging
- [x] Run migrations 066-071 on Supabase (executed in session)
- [x] Deploy Railway cron service for sequences (deployed, verified with manual curl)
- [x] Fix Railway cron 401 (Docker exec-form env var expansion â€” hardcoded secret)
- [x] Fix cron schedule (`0 * * * *` â†’ `0 7-16 * * 1-5`)
- [x] CRON_SECRET rotation (exposed in chat session)
- [ ] Verify DNS propagation complete (stray DKIM key removal)
- [ ] Test magic link delivery after SPF fix
- [ ] Test media library upload flow on production
- [ ] Test draft image restoration
- [ ] UX-039 (vergelijk) testing on staging
- [ ] Test bounce webhook with hard bounce
- [ ] Test preference center at /voorkeuren
- [ ] Test sequence enrollment + cron firing (Monday â€” first real weekday run)
- [ ] Test pre-send checklist with broken links
- [ ] Verify engagement badges on /team/leden
- [ ] Implement onboarding email sequence (5 emails, copy final)
- [ ] Build UTM builder feature (A1.0)

---

**Session Status:** Complete (13 sessions)
