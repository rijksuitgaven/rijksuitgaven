# Daily Log — 2026-02-22

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 8+ — Pre-Launch Polish & Beta Feedback

---

## Summary

Email Media Library (admin feature) implemented end-to-end: Sharp image processing pipeline, database tracking, media picker in editor, browsable media tab. Fixed deployment protocol after accidentally pushing UX-039 to production — reverted from main, cherry-picked back to staging. Fixed email deliverability: broken SPF record (self-referencing include) replaced with correct Resend + ZXCS includes. CLAUDE.md updated with mandatory deployment decision gate.

---

## Work Completed

### Session 1: Email Media Library (Admin Feature)

1. **SQL migration 065-email-media.sql** — `email_media` table with soft delete, 3 indexes (created_at, uploaded_by, filename)
2. **Sharp image processing pipeline** — installed `sharp` dependency, upload route now:
   - Reads metadata (width, height, format)
   - Generates optimized version (max 960px wide, JPEG quality 85, strips EXIF)
   - Generates 200×200 thumbnail for grid display
   - Inserts row in `email_media` with dimensions, size, mime_type
   - Returns enriched response (id, url, thumbnailUrl, dimensions)
3. **Soft delete** — DELETE endpoint now sets `deleted_at` instead of removing from storage
4. **GET /api/v1/team/mail/media** — new endpoint listing all active media, supports `?filenames=` for draft image restoration
5. **Media picker popover** — image toolbar button opens picker with "Upload nieuw" + thumbnail grid of existing media
6. **Media tab** — third tab on mail page (compose | campaigns | media) with upload zone + grid
7. **Draft image restoration** — when editing a draft, parses HTML for image URLs, fetches metadata from DB, restores thumbnail strip
8. **MAX_WIDTH adjusted** — 1200px → 960px (2× retina for 480px email content area)

### Session 2: Deployment Protocol Fix

1. **Identified UX-039 (PIN/vergelijk) on production** — was supposed to be staging-only
2. **Reverted UX-039 from main** — 4 code commits reverted, docs kept (harmless)
3. **Cherry-picked UX-039 back to staging** — feature remains testable on staging
4. **Updated CLAUDE.md** — new "Staging & Deployment Protocol" section with:
   - Deployment Decision Gate (mandatory before every push)
   - Three-tier routing: admin features → both, small fixes → ask, new user features → staging only
   - Batch release workflow for user-facing features

### Session 3: Email Deliverability (DNS)

1. **Diagnosed SPF failure** — root record had `include:rijksuitgaven.nl` (self-reference = no-op)
2. **Identified correct SPF** — `v=spf1 mx a include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev ~all`
3. **Verified Resend DNS** — DKIM, send MX, send SPF all verified in Resend dashboard
4. **Guided DNS cleanup** — removed old SPF, stray root DKIM key, verified via authoritative nameserver
5. **Confirmed DMARC** — `p=reject; sp=reject;` already strict and correct

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/065-email-media.sql` | Migration: email_media table with soft delete + indexes |
| `app/src/app/api/v1/team/mail/media/route.ts` | GET endpoint: list all active media |

## Files Modified

| File | Changes |
|------|---------|
| `app/package.json` | Added `sharp` + `@types/sharp` |
| `app/src/app/api/v1/team/mail/upload/route.ts` | Sharp processing pipeline, DB insert, soft delete, MAX_WIDTH 960px |
| `app/src/components/email-editor/email-editor.tsx` | Enhanced UploadedImage interface, MediaItem type, media picker popover, thumbnailUrl in strip |
| `app/src/app/team/mail/page.tsx` | Media tab, media library state/fetch, draft image restoration, upload zone text |
| `app/src/components/data-table/data-table.tsx` | UX-039 reverted from main (kept on staging) |
| `CLAUDE.md` | Deployment protocol: decision gate, three-tier routing rules |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Uploaded images lost on page reload / draft edit | `email_media` table + draft image restoration via URL parsing |
| No way to browse/reuse previously uploaded images | Media tab + media picker popover in editor |
| Orphan files in storage with no tracking | DB tracking on upload, soft delete on removal |
| UX-039 accidentally on production | Reverted from main, cherry-picked to staging |
| Deployment protocol too ambiguous | New CLAUDE.md rules: admin→both, fixes→ask, features→staging |
| Magic link emails going to junk | Broken SPF record (self-referencing include) → replaced with correct Resend + ZXCS includes |
| Images too large for email (1200px) | Reduced MAX_WIDTH to 960px (2× retina for 480px email content) |

---

## DNS Changes Made

| Record | Change |
|--------|--------|
| `rijksuitgaven.nl` TXT (SPF) | Replaced `include:rijksuitgaven.nl` with `include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev` |
| `rijksuitgaven.nl` TXT (stray DKIM) | Deleted `k=rsa; p=MIGf...` from root (doesn't belong there) |

---

## Commits

| Hash | Description |
|------|-------------|
| `a77c7cf` | Email Media Library: Sharp processing, DB tracking, media picker + tab |
| `f22fc4c` | Revert media library (mistaken — restored immediately) |
| `b075f67` | Reapply media library |
| `f856bd2` | Revert UX-039: Style Wis selectie |
| `e19a826` | Revert UX-039: Move Wis selectie to toolbar |
| `1246ef1` | Revert UX-039: Fix tooltip readability |
| `b7a977b` | Revert UX-039 data-table code from main |
| `df6e1ef` | CLAUDE.md: Deployment protocol |
| `d38cec2` | Email media: MAX_WIDTH 1200→960px |

---

## Next Steps

- [ ] Verify DNS propagation (stray DKIM key removal)
- [ ] Test magic link delivery after SPF fix
- [ ] Test media library upload flow on production
- [ ] Test draft image restoration
- [ ] UX-039 (vergelijk) testing on staging

---

**Session Status:** Complete
