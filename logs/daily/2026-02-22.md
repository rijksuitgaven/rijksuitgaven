# Daily Log — 2026-02-22

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V2.0 Development
**Sprint:** Week 8+ — Pre-Launch Polish & Beta Feedback

---

## Summary

Email Media Library (admin feature) implemented end-to-end: Sharp image processing pipeline, database tracking, media picker in editor, browsable media tab. Fixed deployment protocol after accidentally pushing UX-039 to production — reverted from main, cherry-picked back to staging. Fixed email deliverability: broken SPF record (self-referencing include) replaced with correct Resend + ZXCS includes. CLAUDE.md updated with mandatory deployment decision gate. Session 4: Professional campaign features — 13 features across 6 phases (webhook bounce/complaint handling, pre-send quality checks, campaign analytics with link/device stats, subscriber engagement scoring with member detail pages, email sequence engine with cron processor, and preference center with public opt-out page). 6 SQL migrations (066-071), 23 new route/page files, ua-parser-js installed. Staging recovery after force-push destroyed UX-039 — protocol updated to merge-only. Session 5: Help popovers added to email module (compose workflow + sequence setup, in Dutch). Sequence steps upgraded from basic textarea to full compose experience — rich text editor, preheader, preview with device toggles, pre-send checklist, test email, edit existing steps. Session 6: Cron service debugging — diagnosed crash, verified endpoint. Session 7: UX-039 Vergelijk tooltip — CSS tooltips couldn't escape table overflow, solved with Radix Tooltip.Portal. Session 8: Staging deploy protocol clarified and saved to memory. "Doel door doen" copywriting principle established.

---

## Work Completed

### Session 1: Email Media Library (Admin Feature)

1. **SQL migration 065-email-media.sql** — `email_media` table with soft delete, 3 indexes (created_at, uploaded_by, filename)
2. **Sharp image processing pipeline** — installed `sharp` dependency, upload route now:
   - Reads metadata (width, height, format)
   - Generates optimized version (max 960px wide, JPEG quality 85, strips EXIF)
   - Generates 200×200 thumbnail for grid display
   - Inserts row in `email_media` with dimensions, size, mime_type
   - Returns enriched response (id, url, thumbnailUrl, dimensions)
3. **Soft delete** — DELETE endpoint now sets `deleted_at` instead of removing from storage
4. **GET /api/v1/team/mail/media** — new endpoint listing all active media, supports `?filenames=` for draft image restoration
5. **Media picker popover** — image toolbar button opens picker with "Upload nieuw" + thumbnail grid of existing media
6. **Media tab** — third tab on mail page (compose | campaigns | media) with upload zone + grid
7. **Draft image restoration** — when editing a draft, parses HTML for image URLs, fetches metadata from DB, restores thumbnail strip
8. **MAX_WIDTH adjusted** — 1200px → 960px (2× retina for 480px email content area)

### Session 2: Deployment Protocol Fix

1. **Identified UX-039 (PIN/vergelijk) on production** — was supposed to be staging-only
2. **Reverted UX-039 from main** — 4 code commits reverted, docs kept (harmless)
3. **Cherry-picked UX-039 back to staging** — feature remains testable on staging
4. **Updated CLAUDE.md** — new "Staging & Deployment Protocol" section with:
   - Deployment Decision Gate (mandatory before every push)
   - Three-tier routing: admin features → both, small fixes → ask, new user features → staging only
   - Batch release workflow for user-facing features

### Session 3: Email Deliverability (DNS)

1. **Diagnosed SPF failure** — root record had `include:rijksuitgaven.nl` (self-reference = no-op)
2. **Identified correct SPF** — `v=spf1 mx a include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev ~all`
3. **Verified Resend DNS** — DKIM, send MX, send SPF all verified in Resend dashboard
4. **Guided DNS cleanup** — removed old SPF, stray root DKIM key, verified via authoritative nameserver
5. **Confirmed DMARC** — `p=reject; sp=reject;` already strict and correct

### Session 4: Professional Campaign Features (13 Features, 6 Phases)

Research plan: `docs/plans/2026-02-22-campaign-features-research.md`

**Phase 1: Webhook Enhancement (Foundation)**
1. SQL migration `066-bounce-suppress.sql` — added `bounced_at`, `bounce_type` to `people` + index
2. SQL migration `067-campaign-event-ua.sql` — added `user_agent`, `ua_client`, `ua_device`, `ua_os` to `campaign_events` + index
3. Webhook route: hard bounce → sets `people.bounced_at` + `bounce_type`; complaint → sets `people.unsubscribed_at`
4. Send route: filters out bounced people from recipients
5. Installed `ua-parser-js` (v2) — used `require()` with type cast (v2 API is function, not constructor)

**Phase 2: Pre-Send Quality**
6. New route `team/mail/test` — sends test email to admin with `[TEST]` prefix
7. New route `team/mail/precheck` — 5-area pre-send checklist (Inhoud, Links, Afbeeldingen, Authenticatie, Ontvangers)
8. Device preview — 3 toggle buttons (Desktop/Tablet/Mobile) on compose preview

**Phase 3: Campaign Analytics Enhancement**
9. Modified `campaigns/[id]` route — added `link_stats` (per-link click counts) and `device_stats` (client/device/OS breakdown)
10. New route `campaigns/compare` — side-by-side comparison of 2-4 campaigns with computed rates

**Phase 4: Subscriber Intelligence**
11. SQL migration `068-engagement-scoring.sql` — 2 SQL functions for engagement scoring
12. New route `team/leden/[id]/timeline` — per-person email timeline with engagement data
13. New route `team/leden/engagement` — bulk engagement scores for all persons
14. New page `team/leden/[id]/page.tsx` — member detail with timeline, engagement badge, subscription info
15. Modified `team/leden/page.tsx` — clickable member names, engagement badge column

**Phase 5: Sequence Engine**
16. SQL migration `069-email-sequences.sql` — 4 new tables (sequences, steps, enrollments, sends) + indexes + RLS
17. SQL migration `070-campaign-events-sequence-cols.sql` — sequence_id/step_id on campaign_events, campaign_id nullable
18. CRUD routes for sequences, steps, manual enrollment (5 new route files)
19. Cron route `cron/sequences` — hourly processor, CET-aware, weekday-only, rate-limited
20. `sequence-enrollment.ts` helper — auto-enrolls on invite
21. Modified invite route for auto-enrollment
22. Sequences tab on mail page — list, create, expand detail, manage steps, enrollment table

**Phase 5b: Infrastructure**
23. Guided Railway cron service setup: `curlimages/curl` Docker image, `CRON_SECRET` env var, schedule `0 7-16 * * 1-5`

**Phase 6: Preference Center**
24. SQL migration `071-email-preferences.sql` — `email_topics` + `email_preferences` tables, topic_id FK on campaigns/sequences, seed data
25. Topic CRUD routes (GET/POST + PATCH/DELETE)
26. Public preference API `preferences` (GET/POST) — secured by unsubscribe_token, rate limited
27. Public page `/voorkeuren` — toggle switches per topic, unsubscribe all, re-subscribe
28. Modified campaign template — "Voorkeuren beheren" link in email footer
29. Modified send route — topic preference filtering (respects opt-out per topic)

**Staging Recovery**
30. Force-push to staging destroyed UX-039 — recovered via cherry-pick from old staging ref
31. Updated CLAUDE.md staging protocol: never force-push, always merge

### Session 5: Email Module UX Polish

**Help Popovers**
32. **Compose help popover** — HelpCircle icon next to "E-mail" heading, click to show Dutch help text explaining 4 tabs, compose fields, and recommended workflow
33. **Sequences help popover** — HelpCircle icon next to "Sequenties" heading, explains what sequences are, setup steps, how they work, with concrete example (Welkom-sequentie)
34. **Click-outside handler** — `data-help-popover` attribute pattern for clean popover dismissal

**Sequence Step Upgrade (Full Compose Experience)**
35. **Rich text editor** — replaced basic HTML textarea with EmailEditor (Tiptap) component, reusing media library from compose tab
36. **Preheader field** — added preheader input for sequence steps (was missing)
37. **Preview panel** — device toggle buttons (Desktop/Tablet/Mobile) with responsive iframe preview, reusing renderCampaignEmail template
38. **Pre-send checklist** — "Controleer" button runs 5-area precheck (Inhoud, Links, Afbeeldingen, Authenticatie, Ontvangers) on step content
39. **Test email** — "Verstuur test" button sends step content as test email to admin with [TEST] prefix
40. **Edit existing steps** — clicking a step in the list loads it into the editor form for modification (highlight + Pencil icon)
41. **Save/update flow** — "Opslaan" (editing) or "Toevoegen" (new) buttons with loading state

### Session 6: Cron Service Debugging

42. **Diagnosed cron crash** — Railway `curlimages/curl` container crashed on startup; deploy log showed only "Starting Container" with no curl output → missing/incorrect start command
43. **Verified start command** — `curl -X POST https://beta.rijksuitgaven.nl/api/v1/cron/sequences -H "Authorization: Bearer $CRON_SECRET" -f`
44. **Restarted service** — container now ACTIVE
45. **Manual endpoint test** — curl returned `{"skipped":true,"reason":"weekend"}` (correct for Saturday)

### Session 7: UX-039 Vergelijk Tooltip Fix (Staging Only)

46. **CSS tooltip attempts** — tried `data-tooltip-center` (clipped by `overflow-x:auto` scroll container), `data-tooltip-right` (behind adjacent content), `hover:z-20` on rows (stacking context conflicts)
47. **Root cause identified** — CSS `::after` pseudo-element tooltips cannot escape parent `overflow-x:auto` or `z-index` stacking contexts in a complex table layout
48. **Radix Tooltip with Portal** — installed `@radix-ui/react-tooltip`, replaced pin/unpin button tooltips with `<Tooltip.Portal>` (renders in `document.body`). Instant (`delayDuration={0}`), same dark navy styling as all other tooltips
49. **Matched tooltip styling** — `data-tooltip-center` CSS updated to match `data-tooltip`: padding 6px 10px, font-size 13px, font-weight 400, line-height 1.4

### Session 9: Homepage Copy + Onboarding Email Sequence Design

**Homepage Copy Updates**
52. **Headline restored to V1** — "Overheidsbestedingen snel tot in detail doorzoeken en vergelijken" (was "Waar gaat €1.700 miljard naartoe?")
53. **Subheadline restored to V1** — "Rijksuitgaven is hét onafhankelijke platform voor inzicht in overheidsuitgaven."
54. **Value prop #1 rewritten** — "Doel door doen" applied: "Direct zien wie wat ontvangt, doorzoek overheidsuitgaven in seconden."
55. **Subheadline maxWidth** — 800px → 900px for single-line fit

**Onboarding Email Sequence Design (5 emails)**
56. **Brainstorm with specialist team** — Email Marketing, B2G, B2B Growth, Dutch Copywriter, Adversarial Strategist
57. **Sequence architecture** — 5 emails over 11 days (day 0, 2, 4, 7, 11), job-based not feature-based
58. **Mail 1: Welkom** — login uitleg (magic link, 4 stappen), 7-dag sessie uitleg, absolute bedragen (1 regel), beta feedback ask
59. **Mail 2: Zoeken** — autocomplete, Nederlands (politie voorbeeld), drie zoekmethoden, "Ook in" kolom, integraal
60. **Mail 3: Filteren** — cascading filters, klik-to-filter (generiek voorbeeld), kolommen kiezen
61. **Mail 4: Ontdekking** — 9 jaar + expand/collapse hint, anomalieën (50%+ rood), data beschikbaarheid
62. **Mail 5: Details + Export** — inline uitklappen, groepering, Google zoeken, Excel/CSV export
63. **Design doc created** — `docs/plans/2026-02-22-onboarding-email-sequence.md`

### Session 8: Process & Copywriting Standards

50. **Staging deploy protocol clarified** — all pushes to both (admin, hotfix, approved release) use same flow: push main → checkout staging → merge main → push staging. Only staging-only features go directly to staging branch. Saved to persistent memory.
51. **"Doel door doen" writing principle** — all external copy must lead with the goal (why), then the means (how). Format: "[Doel] — door [doen]". Example: "Sneller vinden wie geld ontvangt — door te zoeken in alle databronnen". Saved to persistent memory.

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/065-email-media.sql` | Migration: email_media table with soft delete + indexes |
| `app/src/app/api/v1/team/mail/media/route.ts` | GET endpoint: list all active media |
| `scripts/sql/066-bounce-suppress.sql` | Migration: bounced_at + bounce_type on people |
| `scripts/sql/067-campaign-event-ua.sql` | Migration: UA columns on campaign_events |
| `scripts/sql/068-engagement-scoring.sql` | Migration: 2 engagement scoring SQL functions |
| `scripts/sql/069-email-sequences.sql` | Migration: 4 sequence tables + indexes + RLS |
| `scripts/sql/070-campaign-events-sequence-cols.sql` | Migration: sequence_id/step_id on campaign_events |
| `scripts/sql/071-email-preferences.sql` | Migration: email_topics + email_preferences + seed data |
| `app/src/app/api/v1/team/mail/test/route.ts` | Test email to admin |
| `app/src/app/api/v1/team/mail/precheck/route.ts` | Pre-send checklist (5 areas) |
| `app/src/app/api/v1/team/mail/campaigns/compare/route.ts` | Campaign comparison |
| `app/src/app/api/v1/team/leden/[id]/timeline/route.ts` | Per-person email timeline |
| `app/src/app/api/v1/team/leden/engagement/route.ts` | Bulk engagement scores |
| `app/src/app/team/leden/[id]/page.tsx` | Member detail page |
| `app/src/app/api/v1/team/mail/sequences/route.ts` | Sequence CRUD (GET/POST) |
| `app/src/app/api/v1/team/mail/sequences/[id]/route.ts` | Sequence detail (GET/PATCH/DELETE) |
| `app/src/app/api/v1/team/mail/sequences/[id]/steps/route.ts` | Add step (POST) |
| `app/src/app/api/v1/team/mail/sequences/[id]/steps/[stepId]/route.ts` | Step CRUD (PATCH/DELETE) |
| `app/src/app/api/v1/team/mail/sequences/[id]/enroll/route.ts` | Manual enrollment (POST) |
| `app/src/app/api/v1/cron/sequences/route.ts` | Cron handler for sequence processing |
| `app/src/app/api/_lib/sequence-enrollment.ts` | Auto-enrollment helper |
| `app/src/app/api/v1/team/mail/topics/route.ts` | Topic CRUD (GET/POST) |
| `app/src/app/api/v1/team/mail/topics/[id]/route.ts` | Topic detail (PATCH/DELETE) |
| `app/src/app/api/v1/preferences/route.ts` | Public preference API (GET/POST) |
| `app/src/app/voorkeuren/page.tsx` | Public preference center page |
| `docs/plans/2026-02-22-onboarding-email-sequence.md` | Onboarding email sequence design (5 emails) |

## Files Modified

| File | Changes |
|------|---------|
| `app/package.json` | Added `sharp` + `@types/sharp`, added `ua-parser-js` |
| `app/src/app/api/v1/team/mail/upload/route.ts` | Sharp processing pipeline, DB insert, soft delete, MAX_WIDTH 960px |
| `app/src/components/email-editor/email-editor.tsx` | Enhanced UploadedImage interface, MediaItem type, media picker popover, thumbnailUrl in strip |
| `app/src/app/team/mail/page.tsx` | Media tab, media library state/fetch, draft image restoration, upload zone text, test button, precheck, device preview, sequences tab, topic selector, help popovers, sequence step full compose experience (rich editor, preview, precheck, test, edit) |
| `app/src/components/data-table/data-table.tsx` | UX-039 reverted from main (kept on staging) |
| `CLAUDE.md` | Deployment protocol: decision gate, three-tier routing rules, updated staging protocol (merge, never force-push) |
| `app/src/app/api/v1/webhooks/resend/route.ts` | Bounce/complaint handling + UA parsing |
| `app/src/app/api/v1/team/mail/send/route.ts` | Bounce filter + topic preference filter |
| `app/src/app/api/v1/team/mail/route.ts` | Exclude bounced from segment counts |
| `app/src/app/api/v1/team/mail/campaigns/[id]/route.ts` | Link stats + device breakdown |
| `app/src/app/team/leden/page.tsx` | Clickable names, engagement badges |
| `app/src/app/api/_lib/campaign-template.ts` | Preference center link in footer |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | Auto-enrollment on invite |
| `app/src/components/homepage/homepage.tsx` | Restored V1 headline/subheadline, "doel door doen" value prop |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Uploaded images lost on page reload / draft edit | `email_media` table + draft image restoration via URL parsing |
| No way to browse/reuse previously uploaded images | Media tab + media picker popover in editor |
| Orphan files in storage with no tracking | DB tracking on upload, soft delete on removal |
| UX-039 accidentally on production | Reverted from main, cherry-picked to staging |
| Deployment protocol too ambiguous | New CLAUDE.md rules: admin→both, fixes→ask, features→staging |
| Magic link emails going to junk | Broken SPF record (self-referencing include) → replaced with correct Resend + ZXCS includes |
| Images too large for email (1200px) | Reduced MAX_WIDTH to 960px (2× retina for 480px email content) |
| ua-parser-js v2 TypeScript error | Used require() with type cast (v2 API is function, not constructor) |
| Force-push destroyed UX-039 on staging | Recovered via cherry-pick, updated protocol to merge-only |
| No guidance for email module usage | Help popovers with Dutch text for compose workflow + sequence setup |
| Sequence steps had basic textarea only | Upgraded to full compose: rich editor, preview, precheck, test email, edit existing |
| TypeScript TS2448: handleSaveStep used before declaration | Moved handleSaveStep after handleExpandSequence in callback ordering |
| Railway cron service crashed on startup | Container had no output — restarted, verified endpoint returns correct weekend skip response |
| UX-039 Vergelijk tooltip clipped/hidden by table rows | CSS tooltips can't escape overflow-x:auto — switched to Radix Tooltip.Portal (renders in document.body) |
| UX-039 tooltip styling mismatch (smaller padding/font) | Matched `data-tooltip-center` CSS to `data-tooltip` (6px padding, 13px font) |

---

## DNS Changes Made

| Record | Change |
|--------|--------|
| `rijksuitgaven.nl` TXT (SPF) | Replaced `include:rijksuitgaven.nl` with `include:spfmailpod.zxcs.nl include:rrpproxyspf.zxcs.nl include:send.resend.dev` |
| `rijksuitgaven.nl` TXT (stray DKIM) | Deleted `k=rsa; p=MIGf...` from root (doesn't belong there) |

---

## Commits

| Hash | Description |
|------|-------------|
| `a77c7cf` | Email Media Library: Sharp processing, DB tracking, media picker + tab |
| `f22fc4c` | Revert media library (mistaken — restored immediately) |
| `b075f67` | Reapply media library |
| `f856bd2` | Revert UX-039: Style Wis selectie |
| `e19a826` | Revert UX-039: Move Wis selectie to toolbar |
| `1246ef1` | Revert UX-039: Fix tooltip readability |
| `b7a977b` | Revert UX-039 data-table code from main |
| `df6e1ef` | CLAUDE.md: Deployment protocol |
| `d38cec2` | Email media: MAX_WIDTH 1200→960px |
| `c968f8b` | Fix: Betalingen column renders as plain text, not a clickable link |
| `0825746` | Campaign features: 6 phases, 13 features, 6 migrations |
| `ce53267` | Docs: daily log session 4 + database docs + session context |
| `052678c` | Add help popovers to email module (compose + sequences) |
| `443fe11` | Upgrade sequence steps to full compose experience |
| `3059d20` | Docs: daily log session 5 + session context |
| `ea05682` | Docs: comprehensive audit — database docs, versioning, daily log |
| `3f6ce7f` | Fix UX-039: Radix Tooltip with portal for pin buttons (staging) |
| `8484cdc` | Docs: daily log sessions 6-7 (cron debugging, UX-039 tooltip fix) |
| `30cf5c0` | Docs: daily log session 8 (deploy protocol, copywriting) |
| `f1a00a6` | Homepage copy: restore V1 headline + "doel door doen" value prop text |
| `1db7c6d` | Docs: onboarding email sequence design (5 emails) |

---

## Next Steps

- [ ] Verify DNS propagation (stray DKIM key removal)
- [ ] Test magic link delivery after SPF fix
- [ ] Test media library upload flow on production
- [ ] Test draft image restoration
- [ ] UX-039 (vergelijk) testing on staging
- [x] Run migrations 066-071 on Supabase (executed in session)
- [x] Deploy Railway cron service for sequences (deployed, verified with manual curl)
- [ ] Test bounce webhook with hard bounce
- [ ] Test preference center at /voorkeuren
- [ ] Test sequence enrollment + cron firing
- [ ] Test pre-send checklist with broken links
- [ ] Verify engagement badges on /team/leden

---

**Session Status:** Complete
