# Daily Log — 2026-02-16

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 7 — Pre-Launch Tasks
**Session Duration:** [to be filled]

---

## Summary

[To be completed at /closeday]

---

## Work Completed

### Session 1: UX-034 — Committed Search Tracking + Dashboard Redesign

**Problem:** Search analytics tracked typing noise (debounce-based). Dashboard showed typos and partial words as real searches. User's "Gemeente Deventer" search appeared as "Gemeente Deventtr" and "Gmeente" in NIET GEVONDEN.

**Root cause:** 2-second debounce timer captured whatever was typed during pauses, including typos, partial words, and autocomplete browsing pauses.

**Solution — Three-layer search analytics model:**

1. **Committed search tracking** — Only Enter press and autocomplete clicks generate search events. No more debounce timer.
2. **search_id linking** — Every committed search gets a unique ID. All engagement events (row_expand, export, cross_module_nav, etc.) carry this search_id.
3. **search_end event** — New 14th event type. Tracks duration (with visibility pause handling) and exit action (new_search, module_switch, page_leave, search_clear).
4. **Retry chains** — `prev_search_id` links a new search to a previous zero-result search within 60 seconds.
5. **Deferred result counting** — Search commit is signaled from filter-panel, but tracking fires only after data loads (when result_count is known).

**Dashboard redesign:**
- New `SearchSection` component with 4 KPI cards (searches, success rate, avg duration, engagement rate)
- Enriched search table: Zoekterm, Resultaten, Via (Enter/Auto pills), Duur, Engagement %, Aantal, Module
- Zero results section with retry count badges
- Engagement breakdown bar chart (what users do after finding results)

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/052-search-tracking-v2.sql` | Truncate + 4 new/replaced functions: searches (with duration/engagement), zero_results (with retry), search_success (search_id based), search_engagement (new) |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Removed debounce tracking. Added committed search system: pendingSearchCommit ref, handleSearchCommit, endCurrentSearch, generateSearchId, visibility pause, search_id on all engagement events |
| `app/src/components/filter-panel/filter-panel.tsx` | Replaced `onAutocompleteSelect` with `onSearchCommit` prop. Enter key calls onSearchCommit('enter'). Current module autocomplete calls onSearchCommit('autocomplete', typedText) |
| `app/src/hooks/use-analytics.ts` | Added `'search_end'` to AnalyticsEventType |
| `app/src/app/api/v1/events/route.ts` | Added `'search_end'` to VALID_EVENT_TYPES |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added `get_usage_search_engagement` RPC call + response field |
| `app/src/app/team/statistieken/page.tsx` | Updated types (SearchItem: enter/auto/duration/engagement, ZeroResultItem: retry). New SearchSection component with KPIs, enriched table, engagement breakdown. Added search_end to event labels + formatEventLine |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typing noise tracked as searches (debounce race) | Kill debounce, track only committed actions (Enter/autocomplete click) |
| No engagement data per search | search_id links all follow-up events back to originating search |
| No search duration tracking | search_end event with duration_seconds, visibility pause handling |
| No retry detection (typo → correction) | prev_search_id links zero-result search to corrected follow-up |
| Result count unknown at commit time | Deferred tracking: store pending commit, track after data loads with actual result_count |
| Dashboard showed flat table | New 3-layer SearchSection: KPIs → enriched table → engagement breakdown |

### Session 2: Statistics Dashboard Visual Redesign (8 commits)

**Context:** Expert team audit of `/team/statistieken` identified 3 issues: (1) Filters missing from Adoption Funnel, (2) "Waar stoppen sessies?" confusing, (3) UI not visually appealing. Multiple rounds of iterative refinement followed.

**Changes (in order):**

1. **Module-centric dashboard** (0d0e3d0, 3694e78) — Initial restructure: per-module activity cards with searches, filters, drilldowns, columns, exports, google clicks, row expands grouped per module.

2. **Dark hero cards + adoption funnel** (c35886d) — Dark navy hero PulseCards with `DeltaBadge` dark variant, Feature Adoption as horizontal bars (sorted by adoption rate), filters added as "Gefilterd" row, "Waar stoppen sessies?" removed, page background → `#F7F8FA`, shadow-based cards.

3. **Merge secondary metrics into Feature Adoption** (464d5a5) — Removed redundant Tier 2 PulseCards (searches, filters, exports, expands). Their data now shown inline in AdoptionFunnel as value + actors + DeltaBadge per feature row.

4. **Module activity card redesign** (763796e) — Inactive modules collapsed into single "Niet bezocht:" pill row. Activity metrics changed from verbose pills to `ActivityChip` (icon-only, non-zero only). Cleaner search rows.

5. **Search redesign** (789a99f) — Removed `SearchSection`, `SearchKPI`, `CommitTypePill`, `EngagementPill` components. Searches now shown as horizontal bars per module (proportional width, navy/amber gradient for results/no-results).

6. **Label fix** (bccb38d) — Unclear labels ("1×", "3 res", "auto") expanded to self-explanatory ("1× gezocht", "3 resultaten", "via autocomplete").

7. **Bar layout fix** (a9e1e4c, 4e10bf2) — Bars proportional to result count (not search frequency, which was always 1×). Fixed-width columns (w-36, w-28, w-20, w-24, w-24) for consistent vertical alignment.

8. **Engagement row** (7db1737) — Replaced scattered activity chips ("Regeling 1×", "Drilldown Artikel 1×") with single compact engagement line: "1× gefilterd (Regeling) · 1× drilldown (Artikel) · 6× uitgeklapt". Field name in parentheses when single field, totals when multiple. Subtle top border separator.

**Expert team consultations:**
- Team 1 (Sofia, Daan, Lena, Kai): Removed Zoekgedrag KPI section (redundant), redesigned search as horizontal bars
- Team 2 (Sofia, Daan, Lena, Kai): Redesigned activity chips as compact engagement row

**Components removed:** `SearchSection`, `SearchKPI`, `CommitTypePill`, `EngagementPill`, `ActivityDetail`, `ActivityChip`

**New SQL migrations:**
- `054-pulse-period-comparison.sql` — `get_usage_pulse_period()` for delta indicators
- `055-module-events.sql` — `get_usage_module_events()` for per-module event counts

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/052-search-tracking-v2.sql` | Truncate + 4 new/replaced functions: searches (with duration/engagement), zero_results (with retry), search_success (search_id based), search_engagement (new) |
| `scripts/sql/053-filter-origin.sql` | Rewritten `get_usage_filters()` with origin column (filter_panel vs expanded_row) |
| `scripts/sql/054-pulse-period-comparison.sql` | `get_usage_pulse_period()` — bounded pulse for period-over-period delta comparison |
| `scripts/sql/055-module-events.sql` | `get_usage_module_events()` — event counts grouped by module + event_type |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Removed debounce tracking. Added committed search system: pendingSearchCommit ref, handleSearchCommit, endCurrentSearch, generateSearchId, visibility pause, search_id on all engagement events |
| `app/src/components/filter-panel/filter-panel.tsx` | Replaced `onAutocompleteSelect` with `onSearchCommit` prop. Enter key calls onSearchCommit('enter'). Current module autocomplete calls onSearchCommit('autocomplete', typedText) |
| `app/src/hooks/use-analytics.ts` | Added `'search_end'` to AnalyticsEventType |
| `app/src/app/api/v1/events/route.ts` | Added `'search_end'` to VALID_EVENT_TYPES |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added `get_usage_search_engagement`, `get_usage_pulse_period`, `get_usage_module_events` RPC calls + subscriptions JOIN for de-anonymization |
| `app/src/app/team/statistieken/page.tsx` | Major visual redesign: dark hero cards, AdoptionFunnel with features array, module-centric activity cards, search horizontal bars, engagement row, collapsed inactive modules. Removed 6 components, added DeltaBadge dark variant, ADOPTION_ICONS, AdoptionFeature interface |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typing noise tracked as searches (debounce race) | Kill debounce, track only committed actions (Enter/autocomplete click) |
| No engagement data per search | search_id links all follow-up events back to originating search |
| No search duration tracking | search_end event with duration_seconds, visibility pause handling |
| No retry detection (typo → correction) | prev_search_id links zero-result search to corrected follow-up |
| Result count unknown at commit time | Deferred tracking: store pending commit, track after data loads with actual result_count |
| Dashboard showed flat table | New 3-layer SearchSection: KPIs → enriched table → engagement breakdown |
| Filters missing from Adoption Funnel | Added `filter_apply` as "Gefilterd" row in AdoptionFunnel |
| "Waar stoppen sessies?" confusing | Removed entirely (exit intent section) |
| UI not visually appealing | Dark navy hero cards, shadow-based cards, #F7F8FA background |
| Redundant secondary metrics | Merged into AdoptionFunnel as inline values |
| Inactive modules waste space | Collapsed into single "Niet bezocht:" pill row |
| Zoekgedrag KPIs redundant | Removed — per-module search bars more insightful |
| Search bars all same width | Changed to proportional to result count, fixed-width columns |
| Activity chips unclear | Replaced with compact engagement row (totals + field in parens) |

---

## Next Steps

[To be completed at /closeday]

---

**Session Status:** In Progress
