# Daily Log — 2026-02-16

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 7 — Pre-Launch Tasks
**Session Duration:** ~7 hours (4 sessions)

---

## Summary

Four sessions focused on search analytics, dashboard quality, and concurrency hardening. Session 1 replaced debounce-based search tracking with committed action tracking (Enter/autocomplete only), eliminating typing noise from analytics. Session 2 was an extensive visual redesign of the `/team/statistieken` dashboard through 8 iterative commits with multiple expert team consultations — dark hero cards, feature adoption bars, module-centric activity cards, and compact engagement rows. Session 3 performed a comprehensive code audit (5-person expert team with adversarial review), identified 12 verified issues (eliminated 5 false positives), and implemented all fixes. Session 4 was a concurrency and stress-testing audit (5-person expert team with adversarial review) that verified database constraints against production, found duplicate subscription race condition, and implemented 6 fixes including a unique partial index on subscriptions. 21 commits total.

---

## Work Completed

### Session 1: UX-034 — Committed Search Tracking + Dashboard Redesign

**Problem:** Search analytics tracked typing noise (debounce-based). Dashboard showed typos and partial words as real searches. User's "Gemeente Deventer" search appeared as "Gemeente Deventtr" and "Gmeente" in NIET GEVONDEN.

**Root cause:** 2-second debounce timer captured whatever was typed during pauses, including typos, partial words, and autocomplete browsing pauses.

**Solution — Three-layer search analytics model:**

1. **Committed search tracking** — Only Enter press and autocomplete clicks generate search events. No more debounce timer.
2. **search_id linking** — Every committed search gets a unique ID. All engagement events (row_expand, export, cross_module_nav, etc.) carry this search_id.
3. **search_end event** — New 14th event type. Tracks duration (with visibility pause handling) and exit action (new_search, module_switch, page_leave, search_clear).
4. **Retry chains** — `prev_search_id` links a new search to a previous zero-result search within 60 seconds.
5. **Deferred result counting** — Search commit is signaled from filter-panel, but tracking fires only after data loads (when result_count is known).

**Dashboard redesign:**
- New `SearchSection` component with 4 KPI cards (searches, success rate, avg duration, engagement rate)
- Enriched search table: Zoekterm, Resultaten, Via (Enter/Auto pills), Duur, Engagement %, Aantal, Module
- Zero results section with retry count badges
- Engagement breakdown bar chart (what users do after finding results)

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/052-search-tracking-v2.sql` | Truncate + 4 new/replaced functions: searches (with duration/engagement), zero_results (with retry), search_success (search_id based), search_engagement (new) |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Removed debounce tracking. Added committed search system: pendingSearchCommit ref, handleSearchCommit, endCurrentSearch, generateSearchId, visibility pause, search_id on all engagement events |
| `app/src/components/filter-panel/filter-panel.tsx` | Replaced `onAutocompleteSelect` with `onSearchCommit` prop. Enter key calls onSearchCommit('enter'). Current module autocomplete calls onSearchCommit('autocomplete', typedText) |
| `app/src/hooks/use-analytics.ts` | Added `'search_end'` to AnalyticsEventType |
| `app/src/app/api/v1/events/route.ts` | Added `'search_end'` to VALID_EVENT_TYPES |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added `get_usage_search_engagement` RPC call + response field |
| `app/src/app/team/statistieken/page.tsx` | Updated types (SearchItem: enter/auto/duration/engagement, ZeroResultItem: retry). New SearchSection component with KPIs, enriched table, engagement breakdown. Added search_end to event labels + formatEventLine |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typing noise tracked as searches (debounce race) | Kill debounce, track only committed actions (Enter/autocomplete click) |
| No engagement data per search | search_id links all follow-up events back to originating search |
| No search duration tracking | search_end event with duration_seconds, visibility pause handling |
| No retry detection (typo → correction) | prev_search_id links zero-result search to corrected follow-up |
| Result count unknown at commit time | Deferred tracking: store pending commit, track after data loads with actual result_count |
| Dashboard showed flat table | New 3-layer SearchSection: KPIs → enriched table → engagement breakdown |

### Session 2: Statistics Dashboard Visual Redesign (8 commits)

**Context:** Expert team audit of `/team/statistieken` identified 3 issues: (1) Filters missing from Adoption Funnel, (2) "Waar stoppen sessies?" confusing, (3) UI not visually appealing. Multiple rounds of iterative refinement followed.

**Changes (in order):**

1. **Module-centric dashboard** (0d0e3d0, 3694e78) — Initial restructure: per-module activity cards with searches, filters, drilldowns, columns, exports, google clicks, row expands grouped per module.

2. **Dark hero cards + adoption funnel** (c35886d) — Dark navy hero PulseCards with `DeltaBadge` dark variant, Feature Adoption as horizontal bars (sorted by adoption rate), filters added as "Gefilterd" row, "Waar stoppen sessies?" removed, page background → `#F7F8FA`, shadow-based cards.

3. **Merge secondary metrics into Feature Adoption** (464d5a5) — Removed redundant Tier 2 PulseCards (searches, filters, exports, expands). Their data now shown inline in AdoptionFunnel as value + actors + DeltaBadge per feature row.

4. **Module activity card redesign** (763796e) — Inactive modules collapsed into single "Niet bezocht:" pill row. Activity metrics changed from verbose pills to `ActivityChip` (icon-only, non-zero only). Cleaner search rows.

5. **Search redesign** (789a99f) — Removed `SearchSection`, `SearchKPI`, `CommitTypePill`, `EngagementPill` components. Searches now shown as horizontal bars per module (proportional width, navy/amber gradient for results/no-results).

6. **Label fix** (bccb38d) — Unclear labels ("1×", "3 res", "auto") expanded to self-explanatory ("1× gezocht", "3 resultaten", "via autocomplete").

7. **Bar layout fix** (a9e1e4c, 4e10bf2) — Bars proportional to result count (not search frequency, which was always 1×). Fixed-width columns (w-36, w-28, w-20, w-24, w-24) for consistent vertical alignment.

8. **Engagement row** (7db1737) — Replaced scattered activity chips ("Regeling 1×", "Drilldown Artikel 1×") with single compact engagement line: "1× gefilterd (Regeling) · 1× drilldown (Artikel) · 6× uitgeklapt". Field name in parentheses when single field, totals when multiple. Subtle top border separator.

**Expert team consultations:**
- Team 1 (Sofia, Daan, Lena, Kai): Removed Zoekgedrag KPI section (redundant), redesigned search as horizontal bars
- Team 2 (Sofia, Daan, Lena, Kai): Redesigned activity chips as compact engagement row

**Components removed:** `SearchSection`, `SearchKPI`, `CommitTypePill`, `EngagementPill`, `ActivityDetail`, `ActivityChip`

**New SQL migrations:**
- `054-pulse-period-comparison.sql` — `get_usage_pulse_period()` for delta indicators
- `055-module-events.sql` — `get_usage_module_events()` for per-module event counts

---

## Files Created

| File | Description |
|------|-------------|
| `scripts/sql/052-search-tracking-v2.sql` | Truncate + 4 new/replaced functions: searches (with duration/engagement), zero_results (with retry), search_success (search_id based), search_engagement (new) |
| `scripts/sql/053-filter-origin.sql` | Rewritten `get_usage_filters()` with origin column (filter_panel vs expanded_row) |
| `scripts/sql/054-pulse-period-comparison.sql` | `get_usage_pulse_period()` — bounded pulse for period-over-period delta comparison |
| `scripts/sql/055-module-events.sql` | `get_usage_module_events()` — event counts grouped by module + event_type |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Removed debounce tracking. Added committed search system: pendingSearchCommit ref, handleSearchCommit, endCurrentSearch, generateSearchId, visibility pause, search_id on all engagement events |
| `app/src/components/filter-panel/filter-panel.tsx` | Replaced `onAutocompleteSelect` with `onSearchCommit` prop. Enter key calls onSearchCommit('enter'). Current module autocomplete calls onSearchCommit('autocomplete', typedText) |
| `app/src/hooks/use-analytics.ts` | Added `'search_end'` to AnalyticsEventType |
| `app/src/app/api/v1/events/route.ts` | Added `'search_end'` to VALID_EVENT_TYPES |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added `get_usage_search_engagement`, `get_usage_pulse_period`, `get_usage_module_events` RPC calls + subscriptions JOIN for de-anonymization |
| `app/src/app/team/statistieken/page.tsx` | Major visual redesign: dark hero cards, AdoptionFunnel with features array, module-centric activity cards, search horizontal bars, engagement row, collapsed inactive modules. Removed 6 components, added DeltaBadge dark variant, ADOPTION_ICONS, AdoptionFeature interface |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typing noise tracked as searches (debounce race) | Kill debounce, track only committed actions (Enter/autocomplete click) |
| No engagement data per search | search_id links all follow-up events back to originating search |
| No search duration tracking | search_end event with duration_seconds, visibility pause handling |
| No retry detection (typo → correction) | prev_search_id links zero-result search to corrected follow-up |
| Result count unknown at commit time | Deferred tracking: store pending commit, track after data loads with actual result_count |
| Dashboard showed flat table | New 3-layer SearchSection: KPIs → enriched table → engagement breakdown |
| Filters missing from Adoption Funnel | Added `filter_apply` as "Gefilterd" row in AdoptionFunnel |
| "Waar stoppen sessies?" confusing | Removed entirely (exit intent section) |
| UI not visually appealing | Dark navy hero cards, shadow-based cards, #F7F8FA background |
| Redundant secondary metrics | Merged into AdoptionFunnel as inline values |
| Inactive modules waste space | Collapsed into single "Niet bezocht:" pill row |
| Zoekgedrag KPIs redundant | Removed — per-module search bars more insightful |
| Search bars all same width | Changed to proportional to result count, fixed-width columns |
| Activity chips unclear | Replaced with compact engagement row (totals + field in parens) |

### Session 3: Comprehensive Code Audit (12 fixes)

**Context:** Full code audit with 5-person expert team (Ravi — Security, Elena — Backend Python, Tomasz — Frontend/React, Lin — DevOps/Infrastructure, Viktor — Adversarial Strategist). Eliminated 5 false positives through adversarial verification, implemented all 12 verified issues.

**Audit findings eliminated (false positives):**
1. SQL injection in `_lookup_matched_fields` — fields from hardcoded MODULE_CONFIG, not user input
2. ILIKE escape vulnerability — parameterized query ($N), no injection possible
3. `isAdmin()` RLS bypass — `.eq('user_id', session.user.id)` IS the authorization guard
4. `onFilterChangeRef` stale closure — latest-ref pattern is the correct React fix
5. `pausedDuration` unit mismatch — ms/1000 converts correctly to seconds

**12 fixes implemented (commit `cfa92ce`):**

| # | Category | Fix |
|---|----------|-----|
| 1 | CSRF | `new URL(origin).host !== host` in 5 admin routes (prevents substring bypass like `evil-rijksuitgaven.nl`) |
| 2 | Timeout | 25s `Promise.race` wrapper on statistieken 18-query parallel batch |
| 3 | Export perf | Map-based O(1) column/year lookups replacing O(n) `.find()` in CSV/XLS export |
| 4 | DB pool | `acquire(timeout=10)` prevents indefinite connection pool wait |
| 5 | HTTP client | Centralized `http_client.py` — shared httpx.AsyncClient with shutdown cleanup |
| 6 | Origin whitelist | `ALLOWED_HOSTS` Set in magic-link + invite routes (prevents `x-forwarded-host` injection) |
| 7 | Hash warning | Production console.warn if default analytics hash secret in use |
| 8 | Response cap | 5MB `content-length` check in BFF proxy before parsing response body |
| 9 | Logging | `exc_info=True` on backend error logs for full stack traces |
| 10 | Unit docs | ms/s comments on all duration references in module-page.tsx |
| 11 | Rate limit | `setInterval` periodic cleanup (5 min) for magic-link rate limit Map |
| 12 | Contact notes | Append on repeat inquiry instead of overwriting (preserves history) |

**Additional fixes (separate commits):**
- Removed Fouten section from Statistieken page (already on dedicated `/team/fouten`)
- Network error suppression in autocomplete catch block (`Failed to fetch`, `NetworkError`)

## Files Created (Session 3)

| File | Description |
|------|-------------|
| `backend/app/services/http_client.py` | Shared httpx.AsyncClient singleton with lifecycle management |

## Files Modified (Session 3)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/leden/route.ts` | CSRF: `new URL(origin).host !== host` |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | CSRF: same fix |
| `app/src/app/api/v1/team/contacten/route.ts` | CSRF: same fix |
| `app/src/app/api/v1/team/contacten/[id]/route.ts` | CSRF: same fix |
| `app/src/app/api/v1/feedback/route.ts` | CSRF: same fix |
| `app/src/app/api/v1/team/statistieken/route.ts` | 25s timeout wrapper on Promise.all, hash secret warning |
| `app/src/components/data-table/data-table.tsx` | Map-based O(1) lookups in export functions |
| `app/src/app/api/_lib/proxy.ts` | 5MB response size cap |
| `app/src/app/api/v1/auth/magic-link/route.ts` | ALLOWED_HOSTS whitelist, setInterval rate limit cleanup |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | ALLOWED_HOSTS whitelist |
| `app/src/app/api/v1/events/route.ts` | Hash secret production warning |
| `app/src/app/api/v1/contact/route.ts` | Append notes on repeat inquiry |
| `app/src/components/module-page/module-page.tsx` | Unit comments on duration refs |
| `backend/app/services/database.py` | pool.acquire(timeout=10) |
| `backend/app/services/modules.py` | Centralized httpx import, exc_info=True |
| `backend/app/api/v1/search.py` | Centralized httpx import |
| `backend/app/main.py` | httpx shutdown cleanup in lifespan |
| `app/src/components/filter-panel/filter-panel.tsx` | Network error suppression in autocomplete |
| `app/src/app/team/statistieken/page.tsx` | Removed Fouten section |

### Session 4: Concurrency & Stress-Testing Audit (6 fixes)

**Context:** Full concurrency audit with 5-person expert team (Sanjay — Concurrency Architect, Nadia — Penetration Tester, Tomasz — Frontend Resilience Lead, Elara — Database Safety Engineer, Viktor — Adversarial Strategist). Deep-dive agents analyzed backend Python and frontend Next.js codebases in parallel.

**Key discovery:** Verified against production database that `subscriptions.person_id` had NO unique constraint — only a regular index. Two concurrent admin requests could both pass the "has active subscription?" check and both INSERT, creating duplicate active subscriptions.

**Additional verified findings:**
- `http_client.py` lazy init had no lock (unlike `database.py` which uses `asyncio.Lock()`)
- Magic link rate limiter Map had no size cap (memory exhaustion vector)
- BFF proxy trusted `Content-Length` header for response size cap (bypassable with chunked encoding)

**Eliminated (false positives by Viktor):**
- "Activation double-write" — idempotent (same timestamp written twice)
- "Client-side stale closures" — refs pattern correctly prevents this
- "Analytics double-counting" — JS single-threaded + `splice()` atomic
- "URL sync race on filter changes" — Next.js `router.replace` batches internally

**6 fixes implemented (commit `7bf5ef7`):**

| # | Fix | Details |
|---|-----|---------|
| 1 | Unique partial index | `idx_subscriptions_active_person` on `subscriptions(person_id) WHERE cancelled_at IS NULL AND deleted_at IS NULL` — migration 056 executed on production |
| 2 | Constraint violation handling | `team/leden/route.ts` and `team/contacten/[id]/convert/route.ts` catch Supabase error code `23505` → return 409 |
| 3 | HTTP client lock | `http_client.py` now uses `asyncio.Lock()` + `async def`, matching `database.py` pattern. All callers updated to `await` |
| 4 | Rate limiter size cap | `MAX_RATE_LIMIT_ENTRIES = 10_000` — rejects with 429 when Map is full |
| 5 | Response body size check | BFF proxy reads `response.text()` and checks `text.length` instead of trusting `Content-Length` header |

## Files Created (Session 4)

| File | Description |
|------|-------------|
| `scripts/sql/056-subscription-unique-person.sql` | Unique partial index preventing duplicate active subscriptions per person |

## Files Modified (Session 4)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/leden/route.ts` | Handle 23505 unique violation → 409 |
| `app/src/app/api/v1/team/contacten/[id]/convert/route.ts` | Handle 23505 unique violation → 409 |
| `backend/app/services/http_client.py` | asyncio.Lock() + async def for thread-safe lazy init |
| `backend/app/services/modules.py` | `await get_http_client()` (was sync call) |
| `backend/app/api/v1/search.py` | `await get_http_client()` (was sync call) |
| `app/src/app/api/v1/auth/magic-link/route.ts` | MAX_RATE_LIMIT_ENTRIES cap (10,000) |
| `app/src/app/api/_lib/proxy.ts` | Read actual body bytes via response.text() |
| `scripts/sql/DATABASE-DOCUMENTATION.md` | Added migration 056 |

## Issues Resolved (Session 4)

| Issue | Solution |
|-------|----------|
| Duplicate active subscriptions possible via concurrent requests | Unique partial index + 23505 error handling |
| HTTP client lazy init inconsistent with database pool pattern | Added asyncio.Lock() + async def |
| Rate limiter Map unbounded memory growth | 10,000 entry cap with 429 rejection |
| BFF response size check bypassable via chunked encoding | Read actual body bytes instead of Content-Length |

---

## Commits (21 total)

| Hash | Message |
|------|---------|
| `9cc5e96` | UX-034: committed search tracking + dashboard redesign |
| `da81004` | Fix: search tracking race condition + restore Fouten section |
| `6830277` | Split filter analytics: panel filters vs expanded row drilldown |
| `5b1190c` | Fix: suppress abort error in expanded row grouping counts fetch |
| `8e92479` | Dashboard redesign P0: visual hierarchy, delta indicators, adoption funnel |
| `0d0e3d0` | Redesign platform usage: module-centric activity cards |
| `3694e78` | Module-centric dashboard: comprehensive per-module activity cards |
| `c35886d` | Dashboard redesign: dark hero cards, adoption funnel with filters, remove exit intent |
| `464d5a5` | Merge secondary metrics into Feature Adoption — single combined view |
| `763796e` | Redesign module activity cards: collapsed inactive, icon chips, cleaner search rows |
| `789a99f` | Remove Zoekgedrag section, redesign search as horizontal bars per module |
| `bccb38d` | Fix: clearer search labels — 1× gezocht, 3 resultaten, via autocomplete |
| `a9e1e4c` | Fix: search bars proportional to result count, constrained width |
| `4e10bf2` | Fix: restore full search labels + align columns with fixed widths |
| `7db1737` | Redesign: engagement row replaces activity chips |
| `52e2941` | Docs: session 2 — statistics dashboard visual redesign (8 commits) |
| `4f16045` | Remove Fouten section from Statistieken — already on dedicated /team/fouten page |
| `eb625b8` | Fix: suppress transient network errors in autocomplete catch block |
| `cfa92ce` | Security + resilience audit: 12 fixes across frontend and backend |
| `2ae63b7` | Docs: closeday 2026-02-16 — 18 commits, 3 sessions, audit complete |
| `7bf5ef7` | Concurrency + stress test fixes: 6 verified issues |

---

## Next Steps

1. **Homepage integration** — embed De Geldstroom + Ontdekking widget in redesigned `public-homepage.tsx`
2. **Search enhancements** — multi-word AND, exact phrase, prefix (SR-005 spec ready, awaiting user review)
3. **CRM Phase 3** — drop redundant columns from subscriptions (email, first_name, last_name, organization)
4. **User migration** — ~50 WordPress users to import to Supabase
5. **Pre-launch** — rate limiting + backend auth/network isolation (identified in security audit)
6. **Load testing** — k6 or Artillery against production-like data (stress test plan from Session 4 team)

---

**Session Status:** Complete
**Total commits:** 21 (Session 1: 4, Session 2: 12, Session 3: 2, Session 4: 1, Docs: 2)
