# Daily Log — 2026-02-10

## Summary

**Week 6: Magic Link Authentication — IMPLEMENTED**

Full Magic Link authentication system built and deployed to production (`beta.rijksuitgaven.nl`). Supabase Auth with PKCE flow, Resend SMTP for transactional email from `noreply@rijksuitgaven.nl`. Login tested end-to-end successfully.

---

## Session 1: Auth Implementation + Deployment

### Work Completed

#### Phase 1: Foundation (no protection — safe to deploy)
- Installed `@supabase/supabase-js` + `@supabase/ssr`
- Created 3 Supabase client utilities:
  - `src/lib/supabase/client.ts` — browser client (Client Components)
  - `src/lib/supabase/server.ts` — server client (Server Components, Route Handlers)
  - `src/lib/supabase/middleware.ts` — middleware client (`updateSession()` + `getUser()`)
- Updated CSP `connect-src` with specific Supabase project URL
- Added `X-BFF-Secret` header to `proxyToBackend()` + POST filters route
- Added `BFFSecretMiddleware` to FastAPI backend + `bff_secret` config setting

#### Phase 2: Login Flow
- Login page at `/login` — redirects to `/` if already logged in
- `LoginForm` client component — Magic Link OTP with PKCE, 60s cooldown, Dutch error messages, callback error display via URL params
- Auth callback at `/auth/callback` — code exchange with cross-device PKCE error detection
- Logout handler at `/auth/logout` — `signOut()` + redirect to `/login`
- Updated `layout.tsx` — async Server Component, fetches user via server client, passes `userEmail` to Header/Footer
- `AuthButton` component — shows "Inloggen" link or email + "Uitloggen"
- Header wired with `userEmail` prop, commented auth placeholder replaced
- Footer logout link updated to `/auth/logout`

#### Phase 3: Protection (enforcement)
- `getAuthenticatedUser()` helper — uses `getSession()` for fast JWT decode in BFF routes
- Auth guard added to all 9 BFF route files — returns 401 JSON
- `middleware.ts` — page route protection, excludes `/api/*`, `/auth/*`, `/login`, static assets
- 401 detection in `api.ts` — all 4 fetch functions redirect to `/login` on 401

#### Phase 4: Polish
- Profile page at `/profiel` — shows email, logout button

### External Configuration (Manual)
- **Resend:** Domain `rijksuitgaven.nl` added, DNS records (DKIM, SPF, MX) all verified
- **Resend:** API key created (Sending access, scoped to rijksuitgaven.nl)
- **Supabase Auth:** Email provider enabled, sign-ups enabled (code-level `shouldCreateUser: false` prevents self-registration)
- **Supabase SMTP:** Resend credentials configured (host: `smtp.resend.com`, port: 587, user: `resend`)
- **Supabase Email Template:** Dutch Magic Link template ("Inloggen bij Rijksuitgaven.nl")
- **Supabase URL Config:** Site URL = `https://beta.rijksuitgaven.nl`, redirect URLs for production + localhost
- **Railway Frontend:** Added `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `BFF_SECRET`
- **Railway Backend:** Added `BFF_SECRET` (matching value)
- **Supabase Users:** First beta test user created (michiel@mavencollectief.nl)

### Issues Resolved During Deployment

| Issue | Root Cause | Fix |
|-------|------------|-----|
| 401 on `/auth/v1/otp` | Supabase anon key was rotated; `.env.local` had stale key | Updated anon key in `.env.local` + Railway |
| 401 persisted after key fix | "Allow new users to sign up" disabled blocks `signInWithOtp` entirely | Re-enabled sign-ups; added `shouldCreateUser: false` to code instead |
| 500 on OTP send | Trailing space in SMTP host field (`smtp.resend.com `) | Removed trailing space in Supabase SMTP Settings |
| 500 "no such host" | Same trailing space issue after port change | Cleaned host field, changed port to 587 |
| Magic Link redirected to `localhost:8080` | Railway proxies internally; `request.url` returns internal origin | Added `getOrigin()` helper using `x-forwarded-host`/`x-forwarded-proto` headers |
| Post-login landed on `/integraal` | Callback default redirect was `/integraal` | Changed to `/` (homepage) |

---

## Files Created (13)

| File | Purpose |
|------|---------|
| `app/src/lib/supabase/client.ts` | Browser Supabase client (singleton) |
| `app/src/lib/supabase/server.ts` | Server Supabase client (per-request, async cookies) |
| `app/src/lib/supabase/middleware.ts` | Middleware client + `updateSession()` with `getUser()` |
| `app/src/middleware.ts` | Page route protection + session refresh |
| `app/src/app/login/page.tsx` | Login page (Server Component shell) |
| `app/src/components/auth/login-form.tsx` | Email input + Magic Link (Client Component) |
| `app/src/components/auth/auth-button.tsx` | Header auth state (email + logout, or login link) |
| `app/src/components/auth/index.ts` | Barrel export |
| `app/src/app/auth/callback/route.ts` | Token exchange, PKCE error handling, `x-forwarded-host` |
| `app/src/app/auth/logout/route.ts` | Logout handler, `x-forwarded-host` |
| `app/src/app/profiel/page.tsx` | Minimal profile page (email, logout) |
| `app/src/app/api/_lib/auth.ts` | `getAuthenticatedUser()` + `unauthorizedResponse()` |

## Files Modified (12)

| File | Change |
|------|--------|
| `app/package.json` | Added `@supabase/supabase-js`, `@supabase/ssr` |
| `app/package-lock.json` | Updated lockfile (12 new packages) |
| `app/next.config.ts` | CSP `connect-src` += Supabase project URL |
| `app/src/app/layout.tsx` | Async, fetches user via server client, passes props |
| `app/src/components/header/header.tsx` | Accepts `userEmail` prop, renders `AuthButton` |
| `app/src/components/footer/footer.tsx` | Logout link → `/auth/logout` |
| `app/src/lib/api.ts` | 401 detection → redirect to `/login` (all 4 fetch functions) |
| `app/src/app/api/_lib/proxy.ts` | Exports `BFF_SECRET`, adds `X-BFF-Secret` header |
| `app/src/app/api/v1/modules/[module]/filters/route.ts` | Auth guard + `X-BFF-Secret` on POST |
| All 9 BFF route files | Import + call `getAuthenticatedUser()`/`unauthorizedResponse()` |
| `backend/app/config.py` | Added `bff_secret: str` setting |
| `backend/app/main.py` | Added `BFFSecretMiddleware`, `X-BFF-Secret` in CORS headers |

## Commits

| Hash | Message |
|------|---------|
| `a75fff9` | Feat: Magic Link authentication (Week 6) |
| `fbebd19` | Fix: Add shouldCreateUser:false to signInWithOtp |
| `47dfd9a` | Fix: Use x-forwarded-host for redirects on Railway |
| `3f6dc1d` | Fix: Post-login redirect to homepage instead of /integraal |

---

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Keep "Allow sign ups" ON in Supabase | Disabling blocks `signInWithOtp` entirely. Use `shouldCreateUser: false` in code instead |
| SMTP port 587 (not 465) | Port 465 also works but 587 resolved connectivity with Supabase's GoTrue |
| `x-forwarded-host` for redirects | Railway proxies via internal `localhost:8080`; `request.url` returns wrong origin |
| Post-login redirect to `/` | Homepage is the natural landing page, not `/integraal` |
| Cookies: secure + sameSite=lax (NOT httpOnly) | `@supabase/ssr` requires browser-readable cookies |
| Middleware = pages, BFF guard = API | Middleware redirects (302). BFF returns 401 JSON. Separate concerns |

---

## Session 2: Auth Cookie Fix (Critical Bug)

### Problem

Magic Link login appeared to work (user shown as logged in after callback) but cookies were NOT persisting. After any navigation, user was kicked back to `/login`.

**Evidence:** DevTools showed code-verifier cookie present on `/login`, but ZERO cookies on homepage after callback redirect.

### Root Cause Investigation (3 iterations)

| Attempt | Approach | Result |
|---------|----------|--------|
| 1. Route Handler | Replaced Page Component with `route.ts` for server-side PKCE exchange | Cookies still cleared — layout.tsx `getUser()` adding Set-Cookie headers on homepage |
| 2. Remove layout getUser | Removed `getUser()` from `layout.tsx`, Header/Footer switched to `useAuth()` hook | Cookies still cleared — middleware or other server-side code still interfering |
| 3. Fully client-side | Replaced route handler with client-side page component, made server.ts `setAll()` no-op | **WORKING** — cookies persist |

### Root Cause

In Next.js 16 dynamic rendering, `cookieStore.set()` in Server Components **succeeds silently** (no error thrown, try/catch catches nothing). This adds `Set-Cookie` headers to page responses that clear or corrupt auth cookies. Multiple server-side components were contributing:
- `layout.tsx` calling `getUser()` → triggered `setAll()` → Set-Cookie headers
- Middleware and other SSR code potentially adding conflicting Set-Cookie headers

The official Supabase Next.js example does NOT call `getUser()` in `layout.tsx`.

### Fix (3 commits)

**Commit `3668778` — Remove getUser() from layout:**
- `layout.tsx` no longer calls `getUser()` or imports `createClient` from server
- Created `hooks/use-auth.ts` — client-side hook using browser Supabase client
- Header and Footer now use `useAuth()` hook instead of server-side props

**Commit `8a87183` — Fully client-side PKCE exchange:**
- Deleted `route.ts` (server-side Route Handler)
- Created `page.tsx` (client-side Page Component with `useEffect`)
- Browser Supabase client reads code-verifier from cookie jar, exchanges code, writes auth tokens directly
- No server-side Set-Cookie headers involved at any point
- Made `server.ts` `setAll()` a no-op to prevent any Server Component from adding Set-Cookie headers

**Commit `ec3b526` — Cleanup:**
- Removed diagnostic logging from `middleware.ts`
- Deleted `/api/cookie-test` and `/api/auth-debug` endpoints

### Architecture Change

**Before (broken):**
```
layout.tsx (Server) → getUser() → cookieStore.set() → Set-Cookie headers → cookies cleared
callback/route.ts (Server) → exchangeCodeForSession() → Set-Cookie headers → cookies cleared by layout
```

**After (working):**
```
layout.tsx (Server) → pure shell, no auth operations
callback/page.tsx (Client) → browser client exchanges code → cookies set directly in browser
Header/Footer (Client) → useAuth() hook → getSession() from browser client
middleware.ts (Server) → own Supabase client for token refresh (separate from server.ts)
```

### Files Created (2)

| File | Purpose |
|------|---------|
| `app/src/hooks/use-auth.ts` | Client-side auth hook (getSession + onAuthStateChange) |
| `app/src/app/auth/callback/page.tsx` | Client-side PKCE exchange (replaces route.ts) |

### Files Modified (4)

| File | Change |
|------|--------|
| `app/src/app/layout.tsx` | Removed `getUser()`, `createClient` import, async keyword; no longer passes auth props |
| `app/src/lib/supabase/server.ts` | `setAll()` is now a no-op (prevents Set-Cookie interference) |
| `app/src/components/header/header.tsx` | Removed `userEmail` prop, `AuthButton` now self-sufficient |
| `app/src/components/footer/footer.tsx` | Uses `useAuth()` hook instead of props |

### Files Modified (Cleanup)

| File | Change |
|------|--------|
| `app/src/lib/supabase/middleware.ts` | Removed diagnostic console.error logging, stale layout comment |
| `app/src/components/auth/auth-button.tsx` | Uses `useAuth()` hook instead of prop |

### Files Deleted (3)

| File | Reason |
|------|--------|
| `app/src/app/auth/callback/route.ts` | Replaced by client-side page.tsx |
| `app/src/app/api/cookie-test/route.ts` | Diagnostic endpoint no longer needed |
| `app/src/app/api/auth-debug/route.ts` | Diagnostic endpoint no longer needed |

### Commits

| Hash | Message |
|------|---------|
| `ab15a25` | Fix auth: server-side Route Handler callback instead of Page Component |
| `3668778` | Fix auth: remove getUser() from layout.tsx — cookies no longer cleared |
| `8a87183` | Fix auth: fully client-side PKCE exchange, no server-side cookies |
| `ec3b526` | Cleanup: remove auth diagnostic logging and test endpoints |

### Key Lesson

**NEVER set auth cookies server-side in Next.js 16 on Railway.** Use the browser Supabase client exclusively for cookie management. Server-side `cookieStore.set()` in dynamic rendering succeeds silently and adds Set-Cookie headers that corrupt auth cookies.

---

## Decisions Made (Session 2)

| Decision | Rationale |
|----------|-----------|
| Client-side PKCE exchange | Server-side Set-Cookie headers unreliable through Next.js 16 + Railway |
| `server.ts` setAll() no-op | Prevents any Server Component from adding Set-Cookie headers |
| `useAuth()` hook for Header/Footer | Client components fetch user info from browser client directly |
| Middleware keeps own Supabase client | Token refresh still works (separate from server.ts) |

---

## Next Steps

- [ ] Migrate ~50 WordPress users to Supabase (via Admin API or Dashboard)
- [ ] Test deliverability via mail-tester.com (target >9/10)
- [ ] Add DMARC DNS record (monitor mode) for email deliverability
- [ ] Week 7: UX/UI Optimization sprint
- [ ] Pre-launch: rate limiting + backend network isolation (V1.1)
