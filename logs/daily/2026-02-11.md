# Daily Log — 2026-02-11

## Summary

**Membership Management System — DESIGNED & IMPLEMENTED**

Full membership management system: subscriptions table, computed status from dates (no cron), grace periods (3d monthly / 14d yearly), admin dashboard at `/team`, member management at `/team/leden`. Also completed UX-026 profile dropdown from previous session.

---

## Session 1: UX-026 Completion + Membership Management

### Work Completed

#### UX-026: Profile Dropdown Menu (completion from 2026-02-10)
- AuthButton: user icon + chevron dropdown with email, profile link, logout
- Footer: removed redundant email + Uitloggen from bottom bar
- Removed unused `handleLogout`, `createClient` import, `userEmail` from Footer
- Build verified, committed, pushed
- UX requirement entry added to search-requirements.md

#### Membership Management Design
- Brainstorm session covering: data model, billing approach, access control, admin pages, status lifecycle
- Design document written and committed: `docs/plans/2026-02-10-membership-management-design.md`

**Key Design Decisions:**

| Decision | Outcome |
|----------|---------|
| Invoicing | External accounting software (Moneybird/Exact), not built-in |
| Data model | `subscriptions` table, dates as source of truth |
| Status computation | From dates — no status column, no cron job |
| Grace period | 3 days (monthly €150/mo), 14 days (yearly €1,500/yr) |
| Expired users | Redirected to `/verlopen` |
| Warning banner | Shown during grace period, dismissable per session |
| Admin access | `role` column in subscriptions table (`member` / `admin`) |
| Admin URL | `/team` namespace (not `/admin` — less guessable) |
| Profile page | Shows plan type + end date, no self-service changes |

#### Membership Management Implementation

**1. SQL Migration (`030-subscriptions.sql`)**
- `subscriptions` table: user_id, email, name, org, plan, role, dates
- RLS: users can read own row, service_role has full access
- Indexes on user_id (middleware lookups) and end_date (admin queries)
- Auto-update trigger for `updated_at`

**2. Middleware Subscription Check**
- `updateSession()` now queries subscriptions table after auth check
- Computes status from dates: active / grace / expired
- Expired → redirect to `/verlopen`
- No subscription row = allow access (safe default during setup)
- Skips check for `/login`, `/auth/*`, `/verlopen`

**3. `useSubscription` Hook**
- Client-side hook fetching subscription data from Supabase
- Computes status from `end_date`, `grace_ends_at`, `cancelled_at`
- Returns: status, plan, dates, name, org, role, loading

**4. `/verlopen` Page**
- Expired subscription page with plan details and formatted date
- Contact email + phone buttons
- Logout button
- Shows current user email

**5. Subscription Banner**
- Shown during grace period below header
- Monthly: "Neem binnen X dagen contact op"
- Yearly: "Uw abonnement is verlopen op [date]"
- Dismissable per session (useState, not localStorage)

**6. Profile Page Update**
- Converted from Server Component to Client Component
- Shows: name, organization, plan type, end date
- Grace period: red text with grace end date
- Contact link for plan changes

**7. Admin API Routes**
- `GET /api/v1/team/leden` — list all subscriptions
- `POST /api/v1/team/leden` — create auth user + subscription row
- `PATCH /api/v1/team/leden/[id]` — update subscription fields
- Admin guard: checks `role = 'admin'` from subscriptions table
- Service role client for bypassing RLS in admin operations
- Validation, error handling, auth user rollback on subscription failure

**8. `/team` Dashboard**
- Stats: total, active, grace, expired counts
- "Actie vereist" table: members in grace period
- "Verloopt binnen 30 dagen" table: upcoming renewals
- "Alles op orde" message when nothing needs attention

**9. `/team/leden` Member Management**
- Table: name, org, email, plan, status badge, end date
- Click row to edit (modal): change name/org/plan/end_date/notes
- Deactivate (sets cancelled_at) / Reactivate (clears cancelled_at)
- "Nieuw lid" form: email, name, org, plan, start date
- Auto-calculates end_date and grace_ends_at from plan + start date
- Status badges: green (active), amber (grace), red (expired)

#### Backlog Item Added
- Invite email for new members: replace `admin.createUser()` with `admin.inviteUserByEmail()`

---

## Files Created (14)

| File | Purpose |
|------|---------|
| `scripts/sql/030-subscriptions.sql` | Subscriptions table migration |
| `app/src/hooks/use-subscription.ts` | Client-side subscription hook |
| `app/src/app/verlopen/page.tsx` | Expired subscription page |
| `app/src/components/subscription-banner/subscription-banner.tsx` | Grace period warning banner |
| `app/src/components/subscription-banner/index.ts` | Barrel export |
| `app/src/app/api/_lib/admin.ts` | Admin role check helper |
| `app/src/app/api/_lib/supabase-admin.ts` | Service role Supabase client |
| `app/src/app/api/v1/team/leden/route.ts` | Admin API: list + create members |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | Admin API: update member |
| `app/src/app/team/page.tsx` | Admin dashboard |
| `app/src/app/team/leden/page.tsx` | Member management page |
| `docs/plans/2026-02-10-membership-management-design.md` | Design document |

## Files Modified (6)

| File | Change |
|------|--------|
| `app/src/components/auth/auth-button.tsx` | UX-026: User icon + chevron dropdown |
| `app/src/components/footer/footer.tsx` | Removed email + logout from bottom bar |
| `app/src/lib/supabase/middleware.ts` | Added subscription check + /verlopen redirect |
| `app/src/app/layout.tsx` | Added SubscriptionBanner import |
| `app/src/app/profiel/page.tsx` | Client component with subscription info |
| `02-requirements/backlog.md` | Added invite email backlog item |

## Commits

| Hash | Message |
|------|---------|
| `f4cbe1d` | UX-026: Profile dropdown menu replaces exposed logout button |
| `91ebb3e` | Add UX-026 requirement entry for profile dropdown menu |
| `4d48323` | Add membership management design document |
| `058f7a8` | Feat: Membership management system |
| `d4b4a62` | Add invite email backlog item for new member onboarding |
| `fbe90ce` | Docs: Daily log 2026-02-11, session context, UX number update |
| `19bac8f` | Add branded magic link email template to backlog |
| `c9019be` | Update invite email backlog: per-member button, not auto on create |

---

## External Configuration (Manual)

| Action | Status |
|--------|--------|
| Run `030-subscriptions.sql` in Supabase SQL Editor | ✅ Done |
| Add `SUPABASE_SERVICE_ROLE_KEY` to Railway frontend | ✅ Done |
| Insert admin subscription row for michiel@mavencollectief.nl | ✅ Done |

---

## Session 2: Database & SQL Migration Audit

### Work Completed

**Comprehensive database audit** covering all SQL migrations, RLS policies, indexes, view consistency, and data integrity.

**Scope:**
- 55 SQL migration files (001-030 + lettered variants + utility scripts)
- 16 tables (6 source + 6 aggregated + 4 metadata)
- 7 materialized views
- 80+ indexes
- 25+ RLS policies

**Key Findings:**

| Category | Status | Notes |
|----------|--------|-------|
| RLS Coverage | ✅ EXCELLENT | All tables protected, correct `(SELECT auth.uid())` pattern |
| Index Coverage | ✅ COMPREHENSIVE | All query patterns covered (default, search, entity filter, cascading) |
| View Consistency | ✅ MAINTAINED | All 7 views have y2016-y2024, years_with_data, totaal, random_order |
| Migration Safety | ✅ GOOD | All idempotent, no destructive operations without safeguards |
| Data Integrity | ✅ VERIFIED | Constraints exist, totaal calculations correct, per-entity views accurate |

**Issues Found & Fixed:**

1. ✅ **FIXED:** `refresh-all-views.sql` was missing ANALYZE statements
   - Added `ANALYZE {view}` after each `REFRESH MATERIALIZED VIEW`
   - Impact: Query planner will now have up-to-date statistics after data imports

2. ⚠️ **MINOR:** Some indexes defined in multiple migrations (001 + 021)
   - Impact: None (PostgreSQL silently ignores duplicates via IF NOT EXISTS)
   - Recommendation: Document pattern for future migrations

3. ⚠️ **DOCUMENTED:** `spatial_ref_sys` RLS warning (PostGIS system table)
   - Action: API access revoked, documented as acceptable exception

**Deliverables:**
- `/scripts/sql/DATABASE-AUDIT-2026-02-11.md` (comprehensive 500+ line report)
- Fixed `refresh-all-views.sql` (added 7 ANALYZE statements)

**Verification Queries Provided:**
- Check all views exist and have recent data
- Check all indexes exist with sizes
- Check RLS enabled on all tables
- Check subscription table constraints
- Check view column consistency
- Check ANALYZE status (last_analyze timestamps)

**Audit Result:** ✅ **PRODUCTION-READY** — No blocking issues found

---

## Files Created (1)

| File | Purpose |
|------|---------|
| `scripts/sql/DATABASE-AUDIT-2026-02-11.md` | Comprehensive database audit report |

## Files Modified (1)

| File | Change |
|------|--------|
| `scripts/sql/refresh-all-views.sql` | Added ANALYZE statements after all REFRESH operations |

---

## Session 3: Branded Email Templates + UX-025 Feedback Button

### Work Completed

#### Branded Email Templates
- **Magic link template** (`docs/email-templates/magic-link.html`): Card layout, logo, pink CTA button, "Deze link is een uur geldig", subject "Inloggen bij Rijksuitgaven"
- **Invite user template** (`docs/email-templates/invite-user.html`): Same styling, subject "Welkom bij Rijksuitgaven"
- Both configured in Supabase Dashboard → Authentication → Email Templates

#### UX-025: Feedback Button with Element Marking
Persistent feedback widget for beta users. Evolved through 3 iterations:
1. Full-page html2canvas → failed on complex data tables
2. Element highlighting (Feedbucket-style) → working, more useful metadata
3. Structured form with categories → actionable feedback data

**Final implementation:**
- Floating "Feedback" button (navy pill, bottom-right, logged-in only)
- Category pills: **Suggestie** / **Bug** / **Vraag** with dynamic placeholders
- Element marking mode: hover highlights, click captures, compact attachment chip preview
- Email delivery via Resend with category badge, element metadata, screenshot attachment
- BFF at `POST /api/v1/feedback` with auth, CSRF, body size validation

**Key bugs fixed during development:**
- html2canvas full-page capture failing → switched to single-element capture
- Invisible overlay blocking `elementFromPoint()` → removed overlay, set cursor on body
- Annuleren button not working → moved toolbar check before `stopPropagation()`
- Pre-existing build error: duplicate `supabase` variable in `team/leden/[id]/route.ts`

### Files Created (4)

| File | Purpose |
|------|---------|
| `app/src/components/feedback/feedback-button.tsx` | Feedback widget with element marking |
| `app/src/components/feedback/index.ts` | Barrel export |
| `app/src/app/api/v1/feedback/route.ts` | BFF endpoint — Resend email delivery |
| `scripts/data/import-wordpress-users.py` | WordPress user migration script (not yet used) |

### Files Modified (4)

| File | Change |
|------|--------|
| `app/src/app/layout.tsx` | Added `<FeedbackButton />` |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | Fixed duplicate `supabase` variable → `adminSupabase` |
| `app/package.json` | Added `resend` and `html2canvas` dependencies |
| `02-requirements/search-requirements.md` | UX-025 status → ✅ Implemented 2026-02-11 |

### Commits

| Hash | Message |
|------|---------|
| `3e58f8a` | Feat: UX-025 Feedback button + email templates + migration script |
| `3213033` | Add structured feedback form: category pills + reason field |
| `a678c86` | Simplify feedback form: Suggestie/Bug/Vraag categories, remove Waarom field |
| `dc7aee7` | Clean up marked element preview: screenshot-only, hide metadata from user |
| `9f164c0` | Feedback: compact attachment chip for marked element preview |

### External Configuration

| Action | Status |
|--------|--------|
| Add `RESEND_API_KEY` to Railway frontend | ✅ Done |
| Configure magic link template in Supabase | ✅ Done |
| Configure invite user template in Supabase | ✅ Done |

---

## Session 4: Feedback Management + Dashboard Redesign + Invite Flow + Trial Role

### Work Completed

#### Feedback Management System (`/team/feedback`)
- **SQL migration** (`031-feedback.sql`): feedback table with RLS, indexes, status workflow, Supabase Storage bucket
- **BFF update** (`POST /api/v1/feedback`): dual-write — INSERT to DB + upload screenshot to Storage + email via Resend
- **Admin API**: `GET /api/v1/team/feedback` (list + `?count_only=true` for badge), `PATCH /api/v1/team/feedback/[id]` (update status/priority/notes)
- **TeamNav component**: Shared tab bar (Dashboard | Leden | Feedback) with unread count badge
- **`/team/feedback` page**: Admin inbox with summary stats, filter dropdowns (status/category/priority), card list with inline status/priority changes, detail modal with screenshot/admin notes/requirement ref
- **Status workflow**: nieuw → in_behandeling → requirement → afgerond/afgewezen
- **Categories**: Bug (red, sorts first), Suggestie (green), Vraag (blue)

#### Dashboard Redesign (3 iterations)
1. Added feedback stats section to dashboard
2. Removed confusing composite filter options ("Open (behandeling + req.)")
3. **Expert team Proposal B**: Two clean white section cards (Leden, Feedback) with consistent headers and inline stats
4. Removed redundant "Beheren" / "Bekijk alles" links (tab bar serves same purpose)

#### Invite Flow with Status Lifecycle (UX-027)
- **SQL migration** (`033-invited-at.sql`): `invited_at timestamptz` column on subscriptions
- **Invite endpoint** (`POST /api/v1/team/leden/[id]/invite`): Handles 3 scenarios:
  1. New user → `inviteUserByEmail` (standard Supabase)
  2. Existing, never logged in → `generateLink` + Resend email with branded magic link
  3. Existing, already active → just set `invited_at` (no email needed)
- **GET enrichment**: `invited_at` + `last_sign_in_at` from auth.users in member list
- **Status lifecycle**: Aangemaakt (gray) → Uitgenodigd (blue) → Actief (green) → Verlengingsperiode (amber) → Verlopen (red)
- **Per-row invite buttons**: "Uitnodigen" on Aangemaakt, "Opnieuw" on Uitgenodigd rows

#### Leden Page Redesign
- **Stat cards → inline stats** row (consistent with dashboard design)
- **"+ Nieuw lid" button** repositioned to stats row (right-aligned, always visible)
- **Role dropdown** (Member | Trial | Admin) in both "Nieuw lid" and "Lid bewerken" forms
- **Trial plan**: 14 days, 0 grace period, auto-set when Trial role selected
- **ESC key** closes edit modal
- **"trial" badge** shown in blue next to member name in table

#### Trial Role
- **SQL migration** (`034-trial-role.sql`): Updated CHECK constraints for role + plan
- **API**: Validation updated for 'trial' in role and plan fields, end_date calculation (start + 14 days)
- **Frontend**: Plan dropdown hidden when Trial role selected, "Proef" label in table

### Files Created (7)

| File | Purpose |
|------|---------|
| `scripts/sql/031-feedback.sql` | Feedback table + RLS + storage bucket |
| `scripts/sql/033-invited-at.sql` | invited_at column on subscriptions |
| `scripts/sql/034-trial-role.sql` | Trial role + plan CHECK constraints |
| `app/src/app/api/v1/team/feedback/route.ts` | Admin feedback list API |
| `app/src/app/api/v1/team/feedback/[id]/route.ts` | Admin feedback update API |
| `app/src/app/api/v1/team/leden/[id]/invite/route.ts` | Invite email endpoint |
| `app/src/components/team-nav/team-nav.tsx` + `index.ts` | Shared tab bar component |

### Files Modified (6)

| File | Change |
|------|--------|
| `app/src/app/api/v1/feedback/route.ts` | Added DB insert + Storage upload (dual-write) |
| `app/src/app/api/v1/team/leden/route.ts` | Enriched with invited_at + last_sign_in_at, trial plan validation |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | Trial role/plan validation |
| `app/src/app/team/page.tsx` | Full dashboard redesign (3 iterations) |
| `app/src/app/team/leden/page.tsx` | Full redesign: inline stats, invite buttons, role dropdown, trial support |
| `app/src/app/team/feedback/page.tsx` | Admin feedback inbox |

### Commits

| Hash | Message |
|------|---------|
| `7df96bb` | Feat: Feedback management system at /team/feedback |
| `6ee7ace` | Dashboard: add feedback overview stats, remove confusing composite filters |
| `6e1a9c3` | Dashboard redesign: consistent section cards (Proposal B) |
| `9f50fd4` | Dashboard: remove redundant section action links |
| `199177a` | Feat: Invite flow with status lifecycle (Aangemaakt → Uitgenodigd → Actief) |
| `5d45ff4` | Fix invite for existing users: fallback to magic link via Resend |
| `fe26eeb` | Feat: Trial role, role dropdown in forms, ESC to close modal |

### External Configuration (Manual)

| Action | Status |
|--------|--------|
| Run `031-feedback.sql` in Supabase | ✅ Done |
| Run `033-invited-at.sql` in Supabase | ✅ Done |
| Run `034-trial-role.sql` in Supabase | ✅ Done |
| Click "Uitnodigen" on existing members | ✅ Done (both Actief) |

---

## Next Steps

- [ ] Import ~50 WordPress users to Supabase (via /team/leden)
- [ ] Send invite emails to imported users
- [ ] V1 Feature Close Review — check backlog and sprints
- [ ] Week 7-9: UX polish, marketing pages, launch prep

## Backlog Items Added

- Row selector for bulk actions on `/team/leden` (admin module, future)
