# Daily Log — 2026-02-11

## Summary

**Membership Management System — DESIGNED & IMPLEMENTED**

Full membership management system: subscriptions table, computed status from dates (no cron), grace periods (3d monthly / 14d yearly), admin dashboard at `/team`, member management at `/team/leden`. Also completed UX-026 profile dropdown from previous session.

---

## Session 1: UX-026 Completion + Membership Management

### Work Completed

#### UX-026: Profile Dropdown Menu (completion from 2026-02-10)
- AuthButton: user icon + chevron dropdown with email, profile link, logout
- Footer: removed redundant email + Uitloggen from bottom bar
- Removed unused `handleLogout`, `createClient` import, `userEmail` from Footer
- Build verified, committed, pushed
- UX requirement entry added to search-requirements.md

#### Membership Management Design
- Brainstorm session covering: data model, billing approach, access control, admin pages, status lifecycle
- Design document written and committed: `docs/plans/2026-02-10-membership-management-design.md`

**Key Design Decisions:**

| Decision | Outcome |
|----------|---------|
| Invoicing | External accounting software (Moneybird/Exact), not built-in |
| Data model | `subscriptions` table, dates as source of truth |
| Status computation | From dates — no status column, no cron job |
| Grace period | 3 days (monthly €150/mo), 14 days (yearly €1,500/yr) |
| Expired users | Redirected to `/verlopen` |
| Warning banner | Shown during grace period, dismissable per session |
| Admin access | `role` column in subscriptions table (`member` / `admin`) |
| Admin URL | `/team` namespace (not `/admin` — less guessable) |
| Profile page | Shows plan type + end date, no self-service changes |

#### Membership Management Implementation

**1. SQL Migration (`030-subscriptions.sql`)**
- `subscriptions` table: user_id, email, name, org, plan, role, dates
- RLS: users can read own row, service_role has full access
- Indexes on user_id (middleware lookups) and end_date (admin queries)
- Auto-update trigger for `updated_at`

**2. Middleware Subscription Check**
- `updateSession()` now queries subscriptions table after auth check
- Computes status from dates: active / grace / expired
- Expired → redirect to `/verlopen`
- No subscription row = allow access (safe default during setup)
- Skips check for `/login`, `/auth/*`, `/verlopen`

**3. `useSubscription` Hook**
- Client-side hook fetching subscription data from Supabase
- Computes status from `end_date`, `grace_ends_at`, `cancelled_at`
- Returns: status, plan, dates, name, org, role, loading

**4. `/verlopen` Page**
- Expired subscription page with plan details and formatted date
- Contact email + phone buttons
- Logout button
- Shows current user email

**5. Subscription Banner**
- Shown during grace period below header
- Monthly: "Neem binnen X dagen contact op"
- Yearly: "Uw abonnement is verlopen op [date]"
- Dismissable per session (useState, not localStorage)

**6. Profile Page Update**
- Converted from Server Component to Client Component
- Shows: name, organization, plan type, end date
- Grace period: red text with grace end date
- Contact link for plan changes

**7. Admin API Routes**
- `GET /api/v1/team/leden` — list all subscriptions
- `POST /api/v1/team/leden` — create auth user + subscription row
- `PATCH /api/v1/team/leden/[id]` — update subscription fields
- Admin guard: checks `role = 'admin'` from subscriptions table
- Service role client for bypassing RLS in admin operations
- Validation, error handling, auth user rollback on subscription failure

**8. `/team` Dashboard**
- Stats: total, active, grace, expired counts
- "Actie vereist" table: members in grace period
- "Verloopt binnen 30 dagen" table: upcoming renewals
- "Alles op orde" message when nothing needs attention

**9. `/team/leden` Member Management**
- Table: name, org, email, plan, status badge, end date
- Click row to edit (modal): change name/org/plan/end_date/notes
- Deactivate (sets cancelled_at) / Reactivate (clears cancelled_at)
- "Nieuw lid" form: email, name, org, plan, start date
- Auto-calculates end_date and grace_ends_at from plan + start date
- Status badges: green (active), amber (grace), red (expired)

#### Backlog Item Added
- Invite email for new members: replace `admin.createUser()` with `admin.inviteUserByEmail()`

---

## Files Created (14)

| File | Purpose |
|------|---------|
| `scripts/sql/030-subscriptions.sql` | Subscriptions table migration |
| `app/src/hooks/use-subscription.ts` | Client-side subscription hook |
| `app/src/app/verlopen/page.tsx` | Expired subscription page |
| `app/src/components/subscription-banner/subscription-banner.tsx` | Grace period warning banner |
| `app/src/components/subscription-banner/index.ts` | Barrel export |
| `app/src/app/api/_lib/admin.ts` | Admin role check helper |
| `app/src/app/api/_lib/supabase-admin.ts` | Service role Supabase client |
| `app/src/app/api/v1/team/leden/route.ts` | Admin API: list + create members |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | Admin API: update member |
| `app/src/app/team/page.tsx` | Admin dashboard |
| `app/src/app/team/leden/page.tsx` | Member management page |
| `docs/plans/2026-02-10-membership-management-design.md` | Design document |

## Files Modified (6)

| File | Change |
|------|--------|
| `app/src/components/auth/auth-button.tsx` | UX-026: User icon + chevron dropdown |
| `app/src/components/footer/footer.tsx` | Removed email + logout from bottom bar |
| `app/src/lib/supabase/middleware.ts` | Added subscription check + /verlopen redirect |
| `app/src/app/layout.tsx` | Added SubscriptionBanner import |
| `app/src/app/profiel/page.tsx` | Client component with subscription info |
| `02-requirements/backlog.md` | Added invite email backlog item |

## Commits

| Hash | Message |
|------|---------|
| `f4cbe1d` | UX-026: Profile dropdown menu replaces exposed logout button |
| `91ebb3e` | Add UX-026 requirement entry for profile dropdown menu |
| `4d48323` | Add membership management design document |
| `058f7a8` | Feat: Membership management system |
| `d4b4a62` | Add invite email backlog item for new member onboarding |
| `fbe90ce` | Docs: Daily log 2026-02-11, session context, UX number update |
| `19bac8f` | Add branded magic link email template to backlog |
| `c9019be` | Update invite email backlog: per-member button, not auto on create |

---

## External Configuration (Manual)

| Action | Status |
|--------|--------|
| Run `030-subscriptions.sql` in Supabase SQL Editor | ✅ Done |
| Add `SUPABASE_SERVICE_ROLE_KEY` to Railway frontend | ✅ Done |
| Insert admin subscription row for michiel@mavencollectief.nl | ✅ Done |

---

## Next Steps

- [ ] Branded magic link email template (logo, card layout, pink CTA button)
- [ ] Branded invite email template (same styling)
- [ ] Import ~50 WordPress users to Supabase (via /team/leden or CSV)
- [ ] "Stuur uitnodiging" button per member in /team/leden (pre-launch)
- [ ] UX-025 Feedback button (P1 — required before beta launch)
- [ ] Week 7-9: UX polish, marketing pages, launch prep
