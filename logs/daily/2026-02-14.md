# Daily Log — 2026-02-14

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 7 — Pre-Launch Tasks
**Session Duration:** [to be filled]

---

## Summary

Session 1: De Geldstroom design sprint — 6-person expert team brainstorm (11 rounds) to design dynamic Sankey hero visualization for homepage. Validated all 6 module stories against real production data. Key finding: COA spending 6.6× increase (€0.56→€3.72 mld, 2018-2024). Decision: 6 selectable stories with year slider, build-time static data (no public API). Full design document written.

Session 2: De Geldstroom implementation — build-time data script + component refactor. Generated real data for all 6 stories (2018-2024), replaced static prototype at `/h1` with fully interactive dynamic visualization. Year selector, story tabs, proportional flow thickness, weighted particle animation, accessibility support.

Session 3: Ontdekking van de Week brainstorm + implementation — 6-person expert team (Data Journalist, Creative Strategist, Data Analyst, Adversarial Editor, UX Writer, Info Architect). Fact-checked 3 prototype claims (ALL wrong/fabricated). Mined production Supabase for verified patterns across all 6 modules. 23 verified discoveries implemented with social sharing (LinkedIn, X, Bluesky). UX-031.

Session 4: Usage Statistics (UX-032) — 6-person expert team (Analytics Lead, Data Engineer, Privacy/GDPR, Dashboard UX, Backend Architect, Adversarial Reviewer). Designed and implemented server-side product analytics with pseudonymized user tracking. 6 event types, client-side batching hook, BFF endpoint, admin dashboard at `/team/statistieken`. SQL migrations executed on production. Deployed.

Session 5: UX-032 V2 — Dashboard redesign + analytics expansion. Fixed 4 bugs (keystroke tracking, false zero-results, missing search context, no per-user view). Dashboard rewritten as 3-act structure (Pulse → Inzichten → Gebruikers) with per-user expandable event timelines and combined search table. 5 new event types added (autocomplete_search/click, sort_change, page_change, cross_module_nav). Total: 11 event types across search-bar.tsx and module-page.tsx. Migration 039 executed. Stale test data cleaned.

---

## Work Completed

### De Geldstroom Design Sprint (Session 1)
- 11-round team brainstorm: Lead UI/UX + Creative Strategist + Data Specialist + Info Architect + Motion Designer + Adversarial Strategist
- Validated data for all 6 stories by querying production Supabase
- Key decisions: 6 selectable stories, Integraal as default, year pills (not slider), build-time JSON, per-story visual scale, node order fixed by 2024 ranking
- Identified and documented 9 risks with mitigations
- Full design document: `docs/plans/2026-02-14-de-geldstroom-design.md`

### Real Data Findings
- **Instrumenten:** SVB receives €36.4 mld from Sociale Zaken (single largest flow)
- **Publiek/COA:** 6.6× spending increase 2018→2024, top recipients are security/healthcare/hotel firms
- **Integraal:** Politie in 4 modules (€34.3 mld), Amsterdam in 5 modules (€11.3 mld)
- **Inkoop:** Ministry name inconsistencies identified (I&W vs "I & W") — normalization implemented
- **Gemeente:** Amsterdam dominates (€5.9 mld, 2.4× Den Haag)
- **Provincie:** Noord-Brabant leads (€4.4 mld), 10 of 12 provinces queried

### Ontdekking van de Week (Session 3)
- **UX-031** requirement entry written in `02-requirements/search-requirements.md`
- **Fact-checked 3 prototype claims** — all wrong:
  - Politieacademie: claimed €342M, actual €131M
  - Wolvenbeheer: completely fabricated, no wolf management in data
  - Rotterdam > 47 gemeenten: Rotterdam not in gemeente top 10, only 12 gemeenten in module
- **Mined production Supabase** — 20+ SQL queries across all 6 modules
- **23 verified discoveries** organized in 6 categories:
  - Energy & Infrastructure (4): TenneT €13.1B/2024, €17B total, ProRail €8.7B, NS Reizigers €2.2B
  - Asylum & Migration (5): COA 6.7× growth, €10.6B total, €3.7B/2024, RMA Healthcare €1.1B, Trigion €730M
  - Government IT & Procurement (4): ICT €6.5B, Heijmans €2.1B #1 supplier, Pels Rijcken €637M, €91.5B total
  - Regional (2): Noord-Brabant > 4 provinces combined, Amsterdam 2× Den Haag
  - Culture & Education (3): Koninklijke Bibliotheek €813M (2.4× Rijksmuseum), €50B universities, Rijksmuseum €336M
  - System-wide (5): SVB €114B, Politie 4 modules €34B, 179 billion-euro recipients, top 10 = 26%, 463K total
- **Social sharing**: LinkedIn (existing) + X + Bluesky added
- **Shuffled rotation**: Fisher-Yates shuffle on mount, progress bar replaces dots
- **Architecture**: Option A (hardcoded JSON) — editorially curated, no build-time script needed
- **Thomas's comparison rules enforced**: same module, same years, no cross-module comparisons

### De Geldstroom Implementation (Session 2)
- **UX-030** requirement entry written in `02-requirements/search-requirements.md`
- **Build-time data script** (`app/scripts/generate-geldstroom-data.mjs`):
  - Connects to Supabase via `DATABASE_URL`
  - 6 story generators with single-query-per-story pattern
  - Ministry name normalization for inkoop (I&W, J&V variants)
  - Year filtering (2018-2024) to exclude dirty data (years 0, 1900, 2025)
  - Checksum validation, fallback to existing JSON if DB unreachable
  - Generates `app/src/data/geldstroom.json` (60.3 KB)
- **Component refactor** (`app/src/app/h1/page.tsx`):
  - Replaced hardcoded data with JSON import
  - 6 story tabs (Alle bronnen, Publieke organisaties, Rijksbegroting, Inkoopdata, Gemeenten, Provincies)
  - Year selector pills (2018-2024) with keyboard arrow navigation
  - Dynamic headline: "Waar ging €X miljard naartoe in [year]?"
  - Flow thickness proportional to actual amounts (per-story scale normalization)
  - Particle density weighted by flow amount
  - `prefers-reduced-motion` accessibility: disables particles
  - ARIA labels on nodes and flows, keyboard-navigable
  - Tooltip on flow hover: "Source → Target: €X mld"
  - Node click CTA: "Bekijk bestedingen →" / "Bekijk ontvangers →"
- **Package.json** updated: `pg` dependency + `prebuild` script (runs before `next build`)
- **Data notes:** COA/inkoop amounts are average staffelbedragen (midpoint estimates) — noted for future attribution text

---

## Files Created

| File | Description |
|------|-------------|
| `docs/plans/2026-02-14-de-geldstroom-design.md` | Full design document — 6 stories, real data, decisions, architecture, risks (~500 lines) |
| `app/scripts/generate-geldstroom-data.mjs` | Build-time data script — queries Supabase, generates JSON |
| `app/src/data/geldstroom.json` | Generated data (60.3 KB) — 6 stories × 7 years, real government flows |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/app/h1/page.tsx` | Complete refactor: static → dynamic data, added year selector + story tabs |
| `app/src/app/h3/page.tsx` | Rewritten: 3 fabricated discoveries → 23 verified, added X + Bluesky share, shuffled rotation |
| `app/package.json` | Added `pg` dependency, `prebuild` script, updated `build` command |
| `02-requirements/search-requirements.md` | Added UX-030 (De Geldstroom) + UX-031 (Ontdekking van de Week) |

### Usage Statistics (Session 4)
- **UX-032** requirement entry written in `02-requirements/search-requirements.md`
- **Expert team brainstorm** (4 rounds): event schema, pseudonymization, dashboard layout, capture architecture
- **6 event types**: module_view, search, row_expand, filter_apply, export, column_change
- **Privacy**: pseudonymized actor_hash (SHA256, first 16 chars), no PII, 90-day retention
- **Client hook** (`hooks/use-analytics.ts`): batched queue, flush every 30s or 10 events, sendBeacon on unload
- **BFF endpoint** (`POST /api/v1/analytics`): validate events, hash user_id, async fire-and-forget write
- **Dashboard** (`/team/statistieken`): 6 sections — pulse cards, module bar chart, top searches, filter/column usage, exports, zero-result searches
- **Dashboard API**: 7 SQL functions called via `supabase.rpc()`, all queries run in parallel
- **Date range picker**: 7d / 30d / 90d / Alles
- **Skew protection**: every metric shows event count + unique users
- **SQL migrations executed**: `038-usage-events.sql` + `038b-usage-events-functions.sql`
- **Env var set**: `ANALYTICS_HASH_SECRET` on Railway frontend

## Files Created (Session 4)

| File | Description |
|------|-------------|
| `docs/plans/2026-02-14-usage-statistics-design.md` | Full design document from team brainstorm |
| `scripts/sql/038-usage-events.sql` | Table + indexes + RLS + retention function |
| `scripts/sql/038b-usage-events-functions.sql` | 7 SQL functions for dashboard queries |
| `app/src/hooks/use-analytics.ts` | Client-side analytics hook with batching |
| `app/src/app/api/v1/analytics/route.ts` | BFF analytics ingestion endpoint |
| `app/src/app/api/v1/team/statistieken/route.ts` | Dashboard API (admin-only) |
| `app/src/app/team/statistieken/page.tsx` | Dashboard page with 6 sections |

## Files Modified (Session 4)

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Instrumented with 6 analytics events |
| `app/src/components/data-table/data-table.tsx` | Added onExport callback for analytics |
| `app/src/components/team-nav/team-nav.tsx` | Added Statistieken tab |
| `02-requirements/search-requirements.md` | Added UX-032 requirement |

### UX-032 V2: Dashboard Redesign + Analytics Expansion (Session 5)
- **4 bug fixes**: keystroke tracking → 2s debounce, false zero-results → fresh result_count, no search context → avg_results column, no per-user view → expandable actor rows
- **Dashboard rewrite**: 3-act structure (Pulse KPIs → Inzichten search/platform usage → Gebruikers per-user drill-down)
- **Combined search table**: searches with results first, amber "Niet gevonden" divider, zero-result rows with amber styling
- **Per-user timeline**: expandable actor rows with activity dots (green <24h, amber <7d, gray), event timeline (50 latest)
- **5 new event types**: autocomplete_search (search-bar, 1.5s debounce), autocomplete_click (recipient/keyword selection), sort_change, page_change (page 2+ only), cross_module_nav (expanded row → other module)
- **Migration 039** executed on production: updated get_usage_searches (avg_results), new get_usage_actors, new get_usage_actor_detail
- **Cleanup**: 8 stale keystroke-polluted test events deleted

## Files Created (Session 5)

| File | Description |
|------|-------------|
| `scripts/sql/039-usage-dashboard-v2.sql` | Dashboard V2 SQL functions (actors summary, actor detail, search avg_results) |

## Files Modified (Session 5)

| File | Changes |
|------|---------|
| `app/src/app/team/statistieken/page.tsx` | Full rewrite: 3-act dashboard, per-user expandable rows, combined search table |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added actor detail mode (?actor=), actors query in dashboard mode |
| `app/src/components/module-page/module-page.tsx` | Debounced search tracking (2s), added sort_change, page_change, cross_module_nav |
| `app/src/components/search-bar/search-bar.tsx` | Added autocomplete_search (1.5s debounce) + autocomplete_click tracking |
| `app/src/hooks/use-analytics.ts` | Extended AnalyticsEventType: 6 → 11 event types |
| `docs/FRONTEND-DOCUMENTATION.md` | Updated event types list + changelog |
| `scripts/sql/DATABASE-DOCUMENTATION.md` | Added migration 039 + 2 new RPC functions |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Integer overflow on instrumenten SUM | Cast bedrag to bigint: `SUM(bedrag::bigint * 1000)` |
| Publiek uses `jaar` not `begrotingsjaar` | Different column name per module — build script handles per-module config |
| Inkoop amount column is `totaal_avg` not `bedrag` | Staffelbedragen use midpoint averages |
| Dirty years (0, 1900, 2025, 2026) in data | Added WHERE year BETWEEN 2018 AND 2024 to all queries |
| Ministry name variants in inkoop | Normalization CTE: I & W/I & M → I&W, J & V → J&V |
| 3 fabricated prototype discoveries | Replaced with 23 fact-checked discoveries from production SQL |
| 23 dot indicators too many | Replaced with progress bar + "X / 23" counter |

### UX-032 V2 Continued: Error Tracking + Errors Section Redesign (Session 6)
- **Error event type added**: 12th event type (`error`) — tracks client-side data fetch failures with context (search query, sort column, active filters)
- **Immediate flush for errors**: Error events bypass 30s batch timer, flush immediately (high priority, low frequency)
- **BFF whitelist fix**: `VALID_EVENT_TYPES` in `/api/v1/analytics/route.ts` only had 6 original types — all 6 new event types (including `error`) were silently rejected. `sendBeacon` swallows HTTP 400 so failures were invisible. Fixed by adding all 12 types.
- **Year column sort fix**: Data-table column IDs `year-2024` didn't match backend expected format `y2024`. Added transform in `handleSortChange`: `column.startsWith('year-') ? 'y' + column.slice(5) : column`
- **Migration 040 executed**: `get_usage_errors()` SQL function — returns error events with context (module, message, properties, actor_hash, created_at)
- **Errors section V1**: Table layout with Time → Module → Context → Message columns, "Wissen" clear button
- **Errors section V2**: Redesigned from sparse table to stacked cards (/frontend-design review). Each error as red-tinted card: error message headline + metadata line with time/module badge/context pills. Empty state with green check icon.
- **DELETE endpoint**: `DELETE /api/v1/team/statistieken` — clears all error events from usage_events table
- **UX-032 marked COMPLETE** — post-V1.0 release feature, fully implemented

### Error Message UX Overhaul (Session 7)
- **Expert panel review** (5 specialists: UX Writer, Product Designer, Frontend Engineer, Support Lead, Privacy/Legal)
- **Industry standard**: single universal message "Er is iets misgegaan" (matches GitHub, Stripe, ING, Belastingdienst)
- **English error leak fixed**: `lib/api.ts` English errors no longer surface to users — catch blocks always use hard-coded Dutch
- **"Fout melden" button**: replaces all "Opnieuw proberen" — confirms error was auto-logged
- **Countdown redirect**: "Fout melden" → "✓ Fout is gemeld" (1s) → "↩ Terug in 3/2/1..." → `router.back()`
- **ErrorReport shared component**: `components/error-boundary/error-report.tsx` — two variants (page card + inline)
- **Three-tier error model**: Silent retry (filters) → Inline notice (expanded rows) → Full error state (page)
- Filter panel keeps "Opnieuw" retry (Tier B — transient dropdown failure)
- **Error trigger tracking**: `lastTrigger` ref in module-page.tsx captures what user action caused the error (sort_change, filter_apply, search, page_change, page_load). Dashboard "Actie" pill shows Dutch-labeled trigger context.

### Comprehensive Error Tracking — 7 Components (Session 8)
- **Audit finding**: Only 1 of 35 catch blocks tracked errors (module-page.tsx). 97% of errors were invisible.
- **7 components instrumented** with `track('error', module, { message, trigger })`:
  1. `expanded-row.tsx` — row detail fetch failure (trigger: `row_expand`)
  2. `detail-panel.tsx` — side panel fetch failure (trigger: `detail_panel`)
  3. `filter-panel.tsx` — filter dropdown load (trigger: `filter_load`) + autocomplete (trigger: `autocomplete`)
  4. `search-bar.tsx` — hub autocomplete search failure (trigger: `autocomplete`)
  5. `feedback-button.tsx` — feedback submit failure (trigger: `feedback_submit`)
  6. `login-form.tsx` — magic link: rate limit + OTP error + network error (trigger: `login`)
  7. `public-homepage.tsx` — contact/demo form HTTP + network errors (trigger: `contact_form`)
- **Dashboard updated**: 7 new Dutch trigger labels (Rij openen, Detailpaneel, Filter laden, Autocomplete, Feedback, Inloggen, Contactformulier)
- **No module context** for non-module components: feedback, login, contact form use `undefined` as module

## Files Created (Session 6)

| File | Description |
|------|-------------|
| `scripts/sql/040-usage-errors-function.sql` | Error tracking dashboard function — get_usage_errors() |

## Files Modified (Session 6)

| File | Changes |
|------|---------|
| `app/src/hooks/use-analytics.ts` | Added `error` event type (11 → 12 types), immediate flush for errors |
| `app/src/components/module-page/module-page.tsx` | Added error tracking in catch block (message, search_query, sort_by, has_filters) |
| `app/src/app/api/v1/analytics/route.ts` | Fixed VALID_EVENT_TYPES whitelist: 6 → 12 types |
| `app/src/app/api/v1/team/statistieken/route.ts` | Added get_usage_errors query, DELETE handler for clearing errors |
| `app/src/app/team/statistieken/page.tsx` | Added ErrorsSection (table → card redesign), error count in pulse, clearErrors callback |
| `02-requirements/search-requirements.md` | UX-032 status → ✅ Completed |
| `docs/FRONTEND-DOCUMENTATION.md` | Updated event types 11 → 12, changelog entry |
| `scripts/sql/DATABASE-DOCUMENTATION.md` | Added migration 040, get_usage_errors function |

## Files Created (Session 7)

| File | Description |
|------|-------------|
| `app/src/components/error-boundary/error-report.tsx` | Shared ErrorReport component — "Fout melden" + countdown redirect |

## Files Modified (Session 7)

| File | Changes |
|------|---------|
| `app/src/app/error.tsx` | Uses ErrorReport, removed custom message |
| `app/src/components/error-boundary/error-boundary.tsx` | Uses ErrorReport, removed two-button UI |
| `app/src/components/error-boundary/index.ts` | Added ErrorReport export |
| `app/src/components/module-page/module-page.tsx` | Hard-coded Dutch in catch, uses ErrorReport |
| `app/src/components/detail-panel/detail-panel.tsx` | Hard-coded Dutch in catch, uses ErrorReport |
| `app/src/components/data-table/expanded-row.tsx` | Hard-coded Dutch in catch, uses ErrorReport inline |
| `app/src/components/filter-panel/filter-panel.tsx` | "Filteropties niet beschikbaar", "Opnieuw" (Tier B) |

## Files Modified (Session 7 — continued)

| File | Changes |
|------|---------|
| `app/src/components/module-page/module-page.tsx` | Added `lastTrigger` ref, set trigger in each callback, passed to error track |
| `app/src/app/team/statistieken/page.tsx` | Added "Actie" pill with Dutch trigger labels |

## Files Modified (Session 8)

| File | Changes |
|------|---------|
| `app/src/components/data-table/expanded-row.tsx` | Added useAnalytics import + `track('error', module, ...)` in catch |
| `app/src/components/detail-panel/detail-panel.tsx` | Added useAnalytics import + `track('error', moduleId, ...)` in catch |
| `app/src/components/filter-panel/filter-panel.tsx` | Added useAnalytics to MultiSelect + FilterPanel, track in 2 catch blocks |
| `app/src/components/search-bar/search-bar.tsx` | Added `track('error', ...)` in hub search catch (already had useAnalytics) |
| `app/src/components/feedback/feedback-button.tsx` | Added useAnalytics import + `track('error', ...)` in submit catch |
| `app/src/components/auth/login-form.tsx` | Added useAnalytics import + `track('error', ...)` in 3 error paths |
| `app/src/components/homepage/public-homepage.tsx` | Added useAnalytics to ContactSection + track in 2 error paths |
| `app/src/app/team/statistieken/page.tsx` | Added 7 new Dutch trigger labels to triggerLabels map |

## Issues Resolved (Session 6+7+8)

| Issue | Solution |
|-------|----------|
| Year column sort crash (`year-2024` vs `y2024`) | Transform in handleSortChange: `year-` prefix → `y` prefix |
| New event types silently rejected by BFF | VALID_EVENT_TYPES whitelist updated from 6 → 12 |
| sendBeacon hides HTTP 400 errors | Fixed validation so events pass; documented invisible failure pattern |
| Errors section too sparse (table layout) | Redesigned as stacked cards with /frontend-design |
| English error messages leak to users | Hard-coded Dutch in all catch blocks, English only in console + analytics |
| No error trigger context in dashboard | `lastTrigger` ref captures user action, "Actie" pill shows Dutch label |
| 97% of catch blocks don't track errors | Added `track('error', ...)` to 7 critical components (35→8 tracked) |

---

### Complete UI Event Tracking — 9 Tracking Points (Session 9)
- **Exhaustive UI event audit** (previous session end): user noticed "Zoek op Google" clicks untracked, demanded comprehensive audit. Found ~75 untracked user actions across 33 files.
- **Scoped to 9 tracking points** (expert team validated): excluded homepage (V1.1 backlog) and admin pages
- **1 new event type**: `external_link` (VALID_EVENT_TYPES 12 → 13)
- **9 tracking points implemented**:
  1. "Zoek op Google" in data-table → `external_link` with `origin: 'data_table'`
  2. "Zoek op Google" in detail-panel → `external_link` with `origin: 'detail_panel'`
  3. Detail panel CSV export → `export` with `origin: 'detail_panel'`
  4. Detail panel cross-module nav → `cross_module_nav` with `origin: 'detail_panel'`
  5. Cross-module-results link clicks → `cross_module_nav` with `origin: 'cross_module_results'`
  6. Filter-panel autocomplete selections (3 handlers) → `autocomplete_click`
  7. 404 page view → `error` with `trigger: '404'` + URL path
  8. React render crash (ErrorBoundary) → `error` with `trigger: 'react_render'` (direct sendBeacon — class component can't use hooks)
  9. Expanded row grouping counts fetch error → `error` with `trigger: 'row_expand'`
- **Dashboard updates**: "Externe links" pulse card, `external_link` in actor timeline (formatEventLine), trigger labels for `404` + `react_render`, `path` context pill for 404 errors
- **Homepage analytics deferred** to V1.1 backlog (CTA clicks, contact form, scroll engagement)
- **not-found.tsx**: converted from server component to client component for hook access

## Files Modified (Session 9)

| File | Changes |
|------|---------|
| `app/src/hooks/use-analytics.ts` | Added `external_link` to AnalyticsEventType (12 → 13 types) |
| `app/src/app/api/v1/analytics/route.ts` | Added `external_link` to VALID_EVENT_TYPES (12 → 13) |
| `app/src/components/data-table/data-table.tsx` | Added useAnalytics hook + track `external_link` on Google link click |
| `app/src/components/detail-panel/detail-panel.tsx` | Track Google link, CSV export, cross-module nav |
| `app/src/components/data-table/expanded-row.tsx` | Track grouping counts fetch error in catch |
| `app/src/components/filter-panel/filter-panel.tsx` | Track autocomplete selections (3 handlers) |
| `app/src/components/cross-module-results/cross-module-results.tsx` | Added useAnalytics + track cross-module link clicks |
| `app/src/app/not-found.tsx` | Converted to client component, added Track404 component |
| `app/src/components/error-boundary/error-boundary.tsx` | Direct sendBeacon in componentDidCatch for React render crash tracking |
| `app/src/app/team/statistieken/page.tsx` | "Externe links" pulse card, formatEventLine for external_link, trigger labels 404 + react_render, path pill |
| `02-requirements/backlog.md` | Added "Homepage Analytics Tracking" V1.1 backlog item |

## Issues Resolved (Session 9)

| Issue | Solution |
|-------|----------|
| "Zoek op Google" clicks untracked | Added `external_link` event type, tracked in both data-table and detail-panel |
| Detail panel CSV export untracked | Added `export` tracking with `origin: 'detail_panel'` |
| Cross-module navigation untracked in detail-panel + cross-module-results | Added `cross_module_nav` tracking with origin context |
| Filter autocomplete selections untracked | Added `autocomplete_click` to 3 handlers in filter-panel |
| 404 pages invisible to analytics | Converted not-found.tsx to client component, track as error with trigger `404` |
| React render crashes invisible | Direct sendBeacon in class component componentDidCatch |
| Grouping counts error silently swallowed | Added error tracking to catch block |

---

### Admin Dashboard + Leden Management Improvements (Session 10)
- **Copy-prompt button** on error cards in `/team/statistieken` — formats error context as a ready-to-paste prompt for debugging (error message, module, trigger, sort, filters, path, extra JSON context). "Gekopieerd" feedback with green checkmark.
- **Member actions** in leden table — replaced single "Opnieuw" button with contextual actions per status:
  - Aangemaakt: Uitnodigen + Verwijderen
  - Uitgenodigd: Opnieuw + Verwijderen
  - Actief: Deactiveren (non-admin only)
  - Verlengingsperiode: Deactiveren (non-admin only)
  - Verlopen: Activeren + Verwijderen
  - Own row: no actions (self-deletion/deactivation prevented)
- **DELETE endpoint** `DELETE /api/v1/team/leden/[id]` — hard deletes subscription row + Supabase auth user, with self-deletion prevention
- **Admins never expire** — `computeStatus()` returns `'active'` for admins, middleware skips expiry redirect for admins
- **Einddatum hidden for admins** — table shows "—", edit modal hides Einddatum field, deactivate button hidden
- **Removed deactivate/reactivate** from edit modal (now in table actions)
- **Removed activity dates** (Eerste login, Laatst actief) from edit modal
- **`last_active_at` fix** — ROOT CAUSE: two bugs preventing updates:
  1. RLS policy only allowed SELECT on subscriptions — added UPDATE policy (migration 041)
  2. Edge Runtime cancels fire-and-forget promises — changed to `await`ed update
- **"Laatst actief" column** added to leden table — shows relative time ("Nu", "3 uur geleden"), sortable
- **Sortable columns** — click "Laatst actief" or "Einddatum" headers to sort (asc/desc toggle)
- **Editable end date** in "Nieuw lid" form — shown for member/trial, hidden for admin, defaults computed from plan
- **Per-error delete** in statistics dashboard — each error card has its own trash icon, DELETE endpoint accepts `?created_at=` for single-error removal, "Wis alles" only shows when 2+ errors

## Files Created (Session 10)

| File | Description |
|------|-------------|
| `scripts/sql/041-subscriptions-update-rls.sql` | RLS UPDATE policy for subscriptions (users can update own row) |

## Files Modified (Session 10)

| File | Changes |
|------|---------|
| `app/src/app/team/statistieken/page.tsx` | Copy-prompt button, per-error delete, "Wis alles" secondary action |
| `app/src/app/api/v1/team/statistieken/route.ts` | DELETE accepts `?created_at=` for single-error removal |
| `app/src/app/team/leden/page.tsx` | MemberActions component, sortable columns, "Laatst actief" column, admin handling, editable end date in add form, removed modal deactivate/reactivate + activity dates |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | Added DELETE handler (hard delete subscription + auth user) |
| `app/src/app/api/v1/team/leden/route.ts` | POST accepts optional `end_date` override |
| `app/src/lib/supabase/middleware.ts` | Await last_active_at update (Edge Runtime fix), admin skip expiry, error logging |

## Issues Resolved (Session 10)

| Issue | Solution |
|-------|----------|
| `last_active_at` never updated (showed first login date) | RLS UPDATE policy + await in Edge Runtime (was fire-and-forget) |
| No way to delete members | DELETE endpoint + per-row delete button with confirmation |
| No way to activate/deactivate from table | Contextual action buttons per status |
| Admins showed expiry date/deactivate button | `computeStatus()` returns 'active', hidden Einddatum + deactivate |
| Can only clear ALL errors at once | Per-error delete via `?created_at=` param |
| No end date field in add member form | Editable Einddatum for member/trial roles |

---

## Next Steps

- Homepage integration: embed De Geldstroom + Ontdekking widget in `public-homepage.tsx`
- Data attribution text for staffelbedragen (COA/inkoop disclaimer)
- Search enhancements (exact phrase, wildcard, multi-word AND)
- User migration (~50 WordPress users)
- V1 Feature Close Review
- Monitor usage statistics dashboard with real user data

---

**Session Status:** Complete
