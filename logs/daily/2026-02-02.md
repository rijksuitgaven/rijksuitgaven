# Daily Log - 2026-02-02

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Mini Sprint - UI/UX Polish (before Week 6)
**Sessions:** 7
**Focus:** Filter UX Optimization + BFF Proxy + Search Relevance + Search Tips UX + Table Layout Polish

---

## Summary

Major filter UX overhaul to match the old WordPress system:
1. Converted all text filters to searchable multi-select dropdowns
2. Added "GESELECTEERD" section showing selected items at top of dropdown
3. Filtered fields now automatically appear as table columns
4. Fixed multiple bugs discovered during testing

Plus: BFF (Backend-for-Frontend) proxy implementation to hide FastAPI URL from browsers.

Plus: Search relevance and word boundary fixes across all modules.

---

## Work Completed

### Session 1: Filter Multi-Select Conversion

**User Request:** Convert all filter fields to searchable multi-select pattern like the old system.

**Design Decision:** Option A - Load all options when dropdown opens, filter client-side.

**Filters Converted (from text input to multiselect):**

| Module | Filters Now MultiSelect |
|--------|------------------------|
| Instrumenten | Begrotingsnaam, Artikel, Artikelonderdeel, Instrument, Regeling |
| Apparaat | Begrotingsnaam, Artikel, Detail |
| Inkoop | Ministerie, Categorie, Staffel |
| Gemeente | Beleidsterrein |
| Publiek | Regeling |

**MultiSelect Component Enhancements:**
1. Lazy loading - Options fetch when dropdown opens
2. Auto-focus - Search input focuses automatically
3. Option count footer - Shows "2,156 opties"
4. Filtered count - Shows "24 van 2,156 opties" when searching
5. Increased height - `max-h-72` (288px)
6. Module change reset - Clears cached options when navigating

### Session 2: UX-006 - Advanced Filter Features

**Feature 1: "GESELECTEERD" section in dropdown**
- Selected items now appear at top with "GESELECTEERD" header
- Unselected items below with "ALLE OPTIES" header
- Matches old WordPress system UX exactly

**Feature 2: Auto-show filter columns (max 2)**
- When multiselect filters are active, first 2 become table columns
- Overrides user's manual column selection while filters active
- Column selector hidden when filters control columns
- When filters cleared, user's column preference returns

**Design Decision:** Option B selected for column limit:
- Unlimited filters allowed
- Only first 2 active filters shown as columns
- Prevents table from becoming too wide

**Bug Fixes:**
1. Infinite render loop - `useCallback` was creating new array references causing endless API calls. Fixed with `useMemo`.
2. Missing filter API parameters - Backend only had 3 filter Query params (provincie, gemeente, source). Added all 11 missing filter fields.
3. No results with filters - `isDefaultView` didn't consider multiselect filters, so `min_years=4` was still applied. Fixed to include `activeFilterColumns.length === 0`.
4. Empty dropdown option - Empty strings from database appeared in dropdown. Added filter to exclude empty/whitespace options.

---

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/filter-panel/filter-panel.tsx` | All filters to multiselect; GESELECTEERD section; lazy loading; empty string filter |
| `app/src/components/module-page/module-page.tsx` | Active filter columns detection; effectiveColumns with useMemo; isDefaultView fix |
| `app/src/components/data-table/data-table.tsx` | hasActiveFilters prop; hide column selector when filters active |
| `backend/app/api/v1/modules.py` | Added 11 missing filter Query parameters |
| `app/.env.local` | Changed `NEXT_PUBLIC_API_URL` to `BACKEND_API_URL` (server-side only) |
| `app/src/lib/api-config.ts` | Set `API_BASE_URL = ''` for relative URLs through BFF |
| `app/src/lib/format.ts` | Consistent text-xs for all amounts (removed dynamic sizing) |

## Files Created

| File | Purpose |
|------|---------|
| `app/src/app/api/_lib/proxy.ts` | Shared proxy helper with security sanitization |
| `app/src/app/api/v1/modules/route.ts` | GET /api/v1/modules |
| `app/src/app/api/v1/modules/[module]/route.ts` | GET /api/v1/modules/{module} |
| `app/src/app/api/v1/modules/[module]/stats/route.ts` | GET /api/v1/modules/{module}/stats |
| `app/src/app/api/v1/modules/[module]/autocomplete/route.ts` | GET /api/v1/modules/{module}/autocomplete |
| `app/src/app/api/v1/modules/[module]/filters/[field]/route.ts` | GET /api/v1/modules/{module}/filters/{field} |
| `app/src/app/api/v1/modules/[module]/[value]/details/route.ts` | GET /api/v1/modules/{module}/{value}/details |
| `app/src/app/api/v1/search/autocomplete/route.ts` | GET /api/v1/search/autocomplete |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Text filters don't show available options | Converted to searchable multi-select dropdowns |
| Users can't discover data breadth | Footer shows option count ("2,156 opties") |
| Selected items not visible when reopening dropdown | Added "GESELECTEERD" section at top |
| Filter column not shown in table | Auto-add first 2 active filter fields as columns |
| Infinite API request loop | Changed useCallback to useMemo for array memoization |
| Regeling filter returned no results | Added missing Query parameters to API endpoint |
| min_years=4 applied with filters | Include activeFilterColumns in isDefaultView check |
| Empty option in dropdown | Filter out empty/whitespace strings |
| Search results wrong order | Word boundary regex was double-escaped (`\\y` → `\y`) |
| "Ook in" counts inflated | Added word boundary filter to Typesense results |
| Dropdown opens on URL navigation | Track user typing vs URL pre-fill with ref |
| Users don't know search is powerful | Added search tips popover with examples |
| No way to collapse expanded 2016-20 years | Added visible "< 2016-20" collapse header |
| Table too wide, Totaal column cut off | Added table-fixed + optimized column widths |
| Inconsistent font sizes in year columns | Changed all amounts to consistent text-xs |
| Anomaly highlighting too chunky | Simplified to subtle bg + padding |

---

## Commits (38 total)

1. `5d79727` - Convert all filters to searchable multi-select dropdowns
2. `fd3ea82` - Daily log 2026-02-02: Filter multi-select conversion
3. `09b113f` - UX-006: Auto-show filter columns + GESELECTEERD section
4. `5a9f242` - Fix infinite loop: use useMemo for effectiveColumns
5. `3e1a5f6` - Add missing filter Query parameters to API endpoint
6. `f591f9c` - Fix: Include multiselect filters in isDefaultView check
7. `88a139a` - Fix: Filter out empty strings from dropdown options
8. `ae67c63` - Code audit fixes round 2: 7 additional issues resolved
9. `08f0ca5` - Code audit fixes: 12 issues resolved
10. `ff8ddaf` - Add BFF proxy to hide backend URL from browsers
11. `f83c843` - Fix: BFF limit cap 100 → 500 to match dropdown options
12. `a429fe3` - Docs: Update for BFF proxy implementation
13. `7f1e36b` - UX: Change default results to 100, dropdown options 50/100/150/250/500
14. `0a760fa` - UX: Default to 50 results (100 requires too much scrolling)
15. `33d5b3a` - Fix: Word boundary regex escaping for relevance sorting
16. `4177446` - Fix: Add word boundary filtering to Typesense search results
17. `5b4c93a` - UX: Don't auto-open autocomplete dropdown on URL navigation
18. `cb264e9` - Fix: Prevent dropdown opening on autocomplete results from URL navigation
19. `4a9792c` - Docs: Add phrase search and wildcards to V1.1 backlog
20. `7dc0c0c` - UX: Add search tips popover with first-visit pulse animation
21. `1c552d9` - Fix: Make search tips dynamic per module
22. `5e0d37b` - UX: Match info button style to Filters button + simplify tip text

---

## Technical Notes

### UX-006: Filter Column Auto-Display

When user selects filter values:
1. Frontend detects active filters via `activeFilterColumns` (useMemo)
2. First 2 active filter field names become `effectiveColumns`
3. Passed to API via `columns` parameter
4. Backend returns those fields via MODE() aggregation
5. Table displays them between primary column and year columns

### Filter Parameter Flow

Frontend → API → Backend:
```
filters.regeling = ['FATF', 'Subsidie X']
  ↓
URL: ?regeling=FATF&regeling=Subsidie%20X
  ↓
API Query param: regeling: Optional[list[str]]
  ↓
filter_fields['regeling'] = ['FATF', 'Subsidie X']
  ↓
WHERE regeling IN ('FATF', 'Subsidie X')
```

---

### Session 3: BFF Proxy Implementation

**User Request:** Hide the FastAPI backend URL from browsers by routing all API calls through Next.js API routes.

**Implementation:**

Created 9 new files:
- `app/src/app/api/_lib/proxy.ts` - Shared proxy helper with security sanitization
- `app/src/app/api/v1/modules/route.ts` - GET /api/v1/modules
- `app/src/app/api/v1/modules/[module]/route.ts` - GET /api/v1/modules/{module}
- `app/src/app/api/v1/modules/[module]/stats/route.ts` - GET /api/v1/modules/{module}/stats
- `app/src/app/api/v1/modules/[module]/autocomplete/route.ts` - GET /api/v1/modules/{module}/autocomplete
- `app/src/app/api/v1/modules/[module]/filters/[field]/route.ts` - GET /api/v1/modules/{module}/filters/{field}
- `app/src/app/api/v1/modules/[module]/[value]/details/route.ts` - GET /api/v1/modules/{module}/{value}/details
- `app/src/app/api/v1/search/autocomplete/route.ts` - GET /api/v1/search/autocomplete

**Security Hardening Built In:**
| Protection | Implementation |
|------------|----------------|
| Hide backend URL | `BACKEND_API_URL` is server-side only (no `NEXT_PUBLIC_` prefix) |
| Block random sort | `sort_by=random` → `sort_by=totaal` |
| Cap offset | Maximum 10,000 |
| Cap limit | Maximum 500 per request (matches dropdown) |
| Input validation | Module names must be alphabetic only |
| Timeout | 30 seconds |

**Environment Changes:**
- `.env.local`: `NEXT_PUBLIC_API_URL` → `BACKEND_API_URL` (server-side only)
- `api-config.ts`: `API_BASE_URL = ''` (empty string = relative URLs)

**Verification Tests Passed:**
- `/api/v1/modules` → Returns module list
- `/api/v1/modules/instrumenten?limit=2` → Returns data
- `/api/v1/modules/instrumenten?offset=50000` → Capped at 10000 ✓
- `/api/v1/modules/instrumenten?limit=200` → Capped at 100 ✓
- `/api/v1/modules/INVALID123` → Returns 400 "Invalid module name" ✓
- All autocomplete, stats, filters, details endpoints working ✓

### Session 4: Documentation Audit + UX Tweaks

**Documentation Audit:**
- Updated FRONTEND-DOCUMENTATION.md with BFF proxy details
- Fixed stale API URL reference (was hardcoded, now documents BFF pattern)
- Updated SESSION-CONTEXT.md with BFF implementation
- Added environment variable documentation

**UX Tweaks:**
- Changed pagination dropdown: 25 → 50 (minimum option)
- Changed default results per page: 25 → 50
- Kept options: 50, 100, 150, 250, 500

**Bug Fix:**
- BFF limit cap was 100, broke dropdown options 150/250/500 → Fixed to 500

### Session 5: Search Relevance & UX Fixes

**Issue 1: Search results not sorted by relevance**
- "Dienst Justitiële Inrichtingen" (match in Regeling) appeared before "Centraal Bureau COA" (match in name)
- Root cause: PostgreSQL `\y` word boundary was double-escaped (`\\y` instead of `\y`)
- Fix: Changed `f"\\\\y{search}\\\\y"` to `rf"\y{search}\y"` in all 3 search functions

**Issue 2: Inflated "Ook in" cross-module counts**
- "COA" showed 326 results in Publiek (actual: ~5)
- Root cause: Typesense prefix matching returned "Coaching", "Coach", etc.
- Fix: Added `is_word_boundary_match()` filter to `_typesense_get_primary_keys_with_highlights()`

**Issue 3: Autocomplete dropdown opens on URL navigation**
- Clicking "Ook in: Publiek" opened dropdown instead of showing table results
- Fix: Added `hasUserTypedRef` to track user typing vs URL pre-fill
- Dropdown only opens when user actively types, not on focus with pre-filled search

**Files Modified:**
- `backend/app/services/modules.py` - Word boundary regex fix + Typesense filtering
- `app/src/components/filter-panel/filter-panel.tsx` - hasUserTypedRef for dropdown control

**Commits:**
- `33d5b3a` - Fix: Word boundary regex escaping for relevance sorting
- `4177446` - Fix: Add word boundary filtering to Typesense search results
- `5b4c93a` - UX: Don't auto-open autocomplete dropdown on URL navigation
- `cb264e9` - Fix: Prevent dropdown opening on autocomplete results from URL navigation

### Session 6: Search Tips Popover (UX Guidance)

**User Request:** Help users understand the power of the new search vs the old WordPress search that "sucked".

**UX Research:**
- Discussed UX best practices (Google, Airbnb approach: "don't explain, guide through interaction")
- Exception: When users have been burned by bad search, they need to know "this one actually works"
- Decided on click-triggered popover with first-visit attention

**Implementation:**
- Info icon button next to search bar (matches Filters button style)
- First-visit pulse animation (pink glow, stored in localStorage)
- Navy popover with pink accent bar (brand-aligned)
- Dynamic content per module (uses existing `MODULE_SEARCH_TEXT`)

**Content (Dutch, formal):**
- Header: "SLIM ZOEKEN"
- Module-specific: "Doorzoekt automatisch {fields per module}"
- "Wat werkt" section with 3 examples
- Tip: "Combineer zoeken met filters voor preciezere resultaten"

**V1.1 Backlog Updates:**
- Added: Exact phrase search with quotes (`"rode kruis"`)
- Added: Wildcard syntax support (`prorail*`)

**Files Modified:**
- `app/src/components/filter-panel/filter-panel.tsx` - Search tips popover
- `app/src/app/globals.css` - Pulse ring animation
- `docs/VERSIONING.md` - V1.1 backlog additions

**Commits:**
- `4a9792c` - Docs: Add phrase search and wildcards to V1.1 backlog
- `7dc0c0c` - UX: Add search tips popover with first-visit pulse animation
- `1c552d9` - Fix: Make search tips dynamic per module
- `5e0d37b` - UX: Match info button style to Filters button + simplify tip text

---

### Session 7: Table Layout & UX Polish

**Focus:** Fix table layout issues and polish year column UX.

**Bug Fixes:**

1. **Missing collapse button for 2016-20 years**
   - Expand worked but users couldn't collapse back
   - Added visible "< 2016-20" header with left chevron when expanded
   - Mirrors the expand UX ("2016-20 >") for consistency

2. **Table overflow with extra columns selected**
   - Table was too wide, cutting off Totaal column
   - Added `table-fixed` CSS to enforce column widths
   - Optimized column widths:
     - Primary (Ontvanger): 200 → 160px
     - Extra columns: 180 → 140px
     - Year columns: 80 → 95px
     - Totaal: 100 → 110px

3. **Inconsistent font sizes in year columns**
   - Numbers ≤10 chars were `text-sm`, >10 chars were `text-xs`
   - Changed to consistent `text-xs` for ALL amounts

4. **Anomaly highlighting too chunky**
   - Removed border, kept subtle background
   - Added `px-2` horizontal padding for breathing room
   - Clean: `bg-[var(--trend-anomaly-bg)] rounded-sm px-2`

**Decided Against:**
- Sticky Totaal column on right - caused layout issues with expanded rows and overall table width. Horizontal scroll is rare and acceptable.

**Files Modified:**
- `app/src/components/data-table/data-table.tsx` - Column widths, table-fixed, collapse button, anomaly styling
- `app/src/lib/format.ts` - Consistent text-xs for all amounts

**Commits:**
- `f4c62cb` - Fix: Add visible collapse button for expanded year columns
- `013e312` - UX: Make Totaal column sticky on right for visibility
- `a1050b1` - Fix: Add right padding to expanded row for sticky Totaal column
- `dd676e6` - Revert: Remove sticky Totaal column - was causing layout issues
- `8de6d0d` - Fix: Use dynamic font sizing for collapsed years cell
- `a2bdf1f` - Fix: Add table-fixed to enforce column widths
- `d987501` - UX: Optimize column widths for better year/Totaal visibility
- `46c898e` - Fix: Use consistent text-xs for all amounts
- `439ebbb` - UX: Cleaner anomaly highlighting - remove border, keep subtle bg
- `43909be` - UX: Refined anomaly indicator with editorial accent bar
- `aba271d` - UX: Simple anomaly highlight with horizontal padding

---

## Next Steps

- Overzichtspagina design + implementation
- Hyperlinks / cross-module navigation

---

**Session Status:** Complete
