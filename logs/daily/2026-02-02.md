# Daily Log - 2026-02-02

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Mini Sprint - UI/UX Polish (before Week 6)
**Sessions:** 3
**Focus:** Filter UX Optimization + BFF Proxy Implementation

---

## Summary

Major filter UX overhaul to match the old WordPress system:
1. Converted all text filters to searchable multi-select dropdowns
2. Added "GESELECTEERD" section showing selected items at top of dropdown
3. Filtered fields now automatically appear as table columns
4. Fixed multiple bugs discovered during testing

Plus: BFF (Backend-for-Frontend) proxy implementation to hide FastAPI URL from browsers.

---

## Work Completed

### Session 1: Filter Multi-Select Conversion

**User Request:** Convert all filter fields to searchable multi-select pattern like the old system.

**Design Decision:** Option A - Load all options when dropdown opens, filter client-side.

**Filters Converted (from text input to multiselect):**

| Module | Filters Now MultiSelect |
|--------|------------------------|
| Instrumenten | Begrotingsnaam, Artikel, Artikelonderdeel, Instrument, Regeling |
| Apparaat | Begrotingsnaam, Artikel, Detail |
| Inkoop | Ministerie, Categorie, Staffel |
| Gemeente | Beleidsterrein |
| Publiek | Regeling |

**MultiSelect Component Enhancements:**
1. Lazy loading - Options fetch when dropdown opens
2. Auto-focus - Search input focuses automatically
3. Option count footer - Shows "2,156 opties"
4. Filtered count - Shows "24 van 2,156 opties" when searching
5. Increased height - `max-h-72` (288px)
6. Module change reset - Clears cached options when navigating

### Session 2: UX-006 - Advanced Filter Features

**Feature 1: "GESELECTEERD" section in dropdown**
- Selected items now appear at top with "GESELECTEERD" header
- Unselected items below with "ALLE OPTIES" header
- Matches old WordPress system UX exactly

**Feature 2: Auto-show filter columns (max 2)**
- When multiselect filters are active, first 2 become table columns
- Overrides user's manual column selection while filters active
- Column selector hidden when filters control columns
- When filters cleared, user's column preference returns

**Design Decision:** Option B selected for column limit:
- Unlimited filters allowed
- Only first 2 active filters shown as columns
- Prevents table from becoming too wide

**Bug Fixes:**
1. Infinite render loop - `useCallback` was creating new array references causing endless API calls. Fixed with `useMemo`.
2. Missing filter API parameters - Backend only had 3 filter Query params (provincie, gemeente, source). Added all 11 missing filter fields.
3. No results with filters - `isDefaultView` didn't consider multiselect filters, so `min_years=4` was still applied. Fixed to include `activeFilterColumns.length === 0`.
4. Empty dropdown option - Empty strings from database appeared in dropdown. Added filter to exclude empty/whitespace options.

---

## Files Modified

| File | Changes |
|------|---------|
| `app/src/components/filter-panel/filter-panel.tsx` | All filters to multiselect; GESELECTEERD section; lazy loading; empty string filter |
| `app/src/components/module-page/module-page.tsx` | Active filter columns detection; effectiveColumns with useMemo; isDefaultView fix |
| `app/src/components/data-table/data-table.tsx` | hasActiveFilters prop; hide column selector when filters active |
| `backend/app/api/v1/modules.py` | Added 11 missing filter Query parameters |
| `app/.env.local` | Changed `NEXT_PUBLIC_API_URL` to `BACKEND_API_URL` (server-side only) |
| `app/src/lib/api-config.ts` | Set `API_BASE_URL = ''` for relative URLs through BFF |

## Files Created

| File | Purpose |
|------|---------|
| `app/src/app/api/_lib/proxy.ts` | Shared proxy helper with security sanitization |
| `app/src/app/api/v1/modules/route.ts` | GET /api/v1/modules |
| `app/src/app/api/v1/modules/[module]/route.ts` | GET /api/v1/modules/{module} |
| `app/src/app/api/v1/modules/[module]/stats/route.ts` | GET /api/v1/modules/{module}/stats |
| `app/src/app/api/v1/modules/[module]/autocomplete/route.ts` | GET /api/v1/modules/{module}/autocomplete |
| `app/src/app/api/v1/modules/[module]/filters/[field]/route.ts` | GET /api/v1/modules/{module}/filters/{field} |
| `app/src/app/api/v1/modules/[module]/[value]/details/route.ts` | GET /api/v1/modules/{module}/{value}/details |
| `app/src/app/api/v1/search/autocomplete/route.ts` | GET /api/v1/search/autocomplete |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Text filters don't show available options | Converted to searchable multi-select dropdowns |
| Users can't discover data breadth | Footer shows option count ("2,156 opties") |
| Selected items not visible when reopening dropdown | Added "GESELECTEERD" section at top |
| Filter column not shown in table | Auto-add first 2 active filter fields as columns |
| Infinite API request loop | Changed useCallback to useMemo for array memoization |
| Regeling filter returned no results | Added missing Query parameters to API endpoint |
| min_years=4 applied with filters | Include activeFilterColumns in isDefaultView check |
| Empty option in dropdown | Filter out empty/whitespace strings |

---

## Commits (9 total)

1. `5d79727` - Convert all filters to searchable multi-select dropdowns
2. `fd3ea82` - Daily log 2026-02-02: Filter multi-select conversion
3. `09b113f` - UX-006: Auto-show filter columns + GESELECTEERD section
4. `5a9f242` - Fix infinite loop: use useMemo for effectiveColumns
5. `3e1a5f6` - Add missing filter Query parameters to API endpoint
6. `f591f9c` - Fix: Include multiselect filters in isDefaultView check
7. `88a139a` - Fix: Filter out empty strings from dropdown options
8. `ae67c63` - Code audit fixes round 2: 7 additional issues resolved
9. `08f0ca5` - Code audit fixes: 12 issues resolved

---

## Technical Notes

### UX-006: Filter Column Auto-Display

When user selects filter values:
1. Frontend detects active filters via `activeFilterColumns` (useMemo)
2. First 2 active filter field names become `effectiveColumns`
3. Passed to API via `columns` parameter
4. Backend returns those fields via MODE() aggregation
5. Table displays them between primary column and year columns

### Filter Parameter Flow

Frontend → API → Backend:
```
filters.regeling = ['FATF', 'Subsidie X']
  ↓
URL: ?regeling=FATF&regeling=Subsidie%20X
  ↓
API Query param: regeling: Optional[list[str]]
  ↓
filter_fields['regeling'] = ['FATF', 'Subsidie X']
  ↓
WHERE regeling IN ('FATF', 'Subsidie X')
```

---

### Session 3: BFF Proxy Implementation

**User Request:** Hide the FastAPI backend URL from browsers by routing all API calls through Next.js API routes.

**Implementation:**

Created 9 new files:
- `app/src/app/api/_lib/proxy.ts` - Shared proxy helper with security sanitization
- `app/src/app/api/v1/modules/route.ts` - GET /api/v1/modules
- `app/src/app/api/v1/modules/[module]/route.ts` - GET /api/v1/modules/{module}
- `app/src/app/api/v1/modules/[module]/stats/route.ts` - GET /api/v1/modules/{module}/stats
- `app/src/app/api/v1/modules/[module]/autocomplete/route.ts` - GET /api/v1/modules/{module}/autocomplete
- `app/src/app/api/v1/modules/[module]/filters/[field]/route.ts` - GET /api/v1/modules/{module}/filters/{field}
- `app/src/app/api/v1/modules/[module]/[value]/details/route.ts` - GET /api/v1/modules/{module}/{value}/details
- `app/src/app/api/v1/search/autocomplete/route.ts` - GET /api/v1/search/autocomplete

**Security Hardening Built In:**
| Protection | Implementation |
|------------|----------------|
| Hide backend URL | `BACKEND_API_URL` is server-side only (no `NEXT_PUBLIC_` prefix) |
| Block random sort | `sort_by=random` → `sort_by=totaal` |
| Cap offset | Maximum 10,000 |
| Cap limit | Maximum 100 per request |
| Input validation | Module names must be alphabetic only |
| Timeout | 30 seconds |

**Environment Changes:**
- `.env.local`: `NEXT_PUBLIC_API_URL` → `BACKEND_API_URL` (server-side only)
- `api-config.ts`: `API_BASE_URL = ''` (empty string = relative URLs)

**Verification Tests Passed:**
- `/api/v1/modules` → Returns module list
- `/api/v1/modules/instrumenten?limit=2` → Returns data
- `/api/v1/modules/instrumenten?offset=50000` → Capped at 10000 ✓
- `/api/v1/modules/instrumenten?limit=200` → Capped at 100 ✓
- `/api/v1/modules/INVALID123` → Returns 400 "Invalid module name" ✓
- All autocomplete, stats, filters, details endpoints working ✓

---

## Next Steps

- Add `BACKEND_API_URL` to Railway environment variables (production)
- Remove commented `NEXT_PUBLIC_API_URL` from `.env.local` after production verification
- Test all filter combinations across modules
- Overzichtspagina design + implementation
- Hyperlinks / cross-module navigation

---

**Session Status:** Complete
