# Daily Log - 2026-01-29

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** Phase 1 - V1.0 Development
**Sprint:** Week 6 - User Auth
**Session Duration:** [to be filled]

---

## Summary

[To be completed at /closeday]

---

## Work Completed

### 1. Added Golden Rules to CLAUDE.md

Reinforced four non-negotiable behaviors that must be automatic:

| Rule | Behavior |
|------|----------|
| **Requirements Check** | Before ANY proposal, verify against V1 and V2 requirements |
| **Documentation Sync** | After ANY change, immediately update all affected docs |
| **Ask, Don't Assume** | When in doubt, stop and ask - never guess |
| **Pre-Commit Audit** | Before EVERY commit, audit docs, requirements, clarity - SHOW audit to user |

These rules now appear at the top of CLAUDE.md and override all other rules.

### 2. Frontend Code Review & Security Fixes

Comprehensive code review of all frontend components. Fixed critical and high-priority issues.

#### Critical Fixes

| Issue | Fix |
|-------|-----|
| **Typesense API key exposed in client code** | Created backend proxy (`/api/v1/search/autocomplete`), moved all Typesense calls server-side |
| **XSS risk in CSV filename** | Added filename sanitization: `replace(/[^a-zA-Z0-9\s\-_.]/g, '')` |
| **console.error leaking data** | Removed error logging that could expose sensitive data |

#### High/Medium Fixes

| Issue | Fix |
|-------|-----|
| TypeScript `any` types | Added proper `Column<RecipientRow>` and `ColumnMeta` types |
| Header dropdown fragile blur pattern | Replaced with proper `useEffect` for click-outside and Escape key |
| API_BASE_URL duplicated 5 times | Created centralized `lib/api-config.ts`, updated all imports |

#### Accessibility Fixes

| Component | Fix |
|-----------|-----|
| `search-bar.tsx` | Added `aria-label`, `aria-expanded`, `aria-haspopup` to search input |
| `filter-panel.tsx` | Added `aria-label` to min/max bedrag inputs, plus input validation (min >= 0, min <= max) |
| `data-table.tsx` | Added `aria-label` and `aria-expanded` to expand/collapse buttons, sort headers, pagination, export button |

---

## Files Created

| File | Description |
|------|-------------|
| `backend/app/api/v1/search.py` | Typesense proxy endpoint - keeps API key server-side |
| `app/src/lib/api-config.ts` | Centralized API base URL configuration |
| `scripts/sql/011-add-random-order-to-views.sql` | Migration: random_order column for fast random sorting |
| `scripts/sql/011a-011g-*.sql` | Split migrations for Supabase timeout (7 files) |
| `.claude/commands/document.md` | /document skill for session documentation |

## Files Modified

| File | Changes |
|------|---------|
| `CLAUDE.md` | Added "Golden Rules" section |
| `backend/app/api/v1/__init__.py` | Added search router import |
| `app/src/components/search-bar/search-bar.tsx` | Use backend proxy, added accessibility labels |
| `app/src/components/detail-panel/detail-panel.tsx` | Sanitized filename, removed console.error |
| `app/src/components/data-table/data-table.tsx` | Fixed TypeScript types, added accessibility labels |
| `app/src/components/filter-panel/filter-panel.tsx` | Added min/max validation, accessibility labels |
| `app/src/components/header/header.tsx` | Fixed dropdown: Escape key + click-outside handling |
| `app/src/components/data-table/expanded-row.tsx` | Use centralized API config |
| `app/src/components/cross-module-results/cross-module-results.tsx` | Use centralized API config |
| `app/src/lib/api.ts` | Use centralized API config |
| `scripts/sql/refresh-all-views.sql` | Added note about random_order regeneration |
| `backend/app/services/modules.py` | ORDER BY random_order for fast random sorting |
| `app/src/lib/api.ts` | Map `search` to `q` for backend API (bug fix) |
| `app/src/types/api.ts` | Added comment for search→q mapping |
| `backend/app/services/database.py` | Disabled prepared statement cache for pgbouncer |
| `app/src/components/module-page/module-page.tsx` | Show "Random resultaten" for default view |
| `app/src/components/search-bar/search-bar.tsx` | Reorder: Ontvangers before Zoektermen |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typesense API key exposed | Backend proxy, key stays server-side only |
| XSS risk in CSV download | Filename sanitization |
| TypeScript `any` usage | Proper typing with Column and ColumnMeta |
| Header dropdown UX bugs | Proper event handlers for Escape and click-outside |
| Duplicated API_BASE_URL | Centralized config file |
| Typesense API key rotation | New key deployed, backend proxy working |
| Railway private networking | Added to backlog - public URL works |
| Missing accessibility labels | Added aria-labels to search, filter, table buttons |
| Filter input validation | Added min/max validation for bedrag range filters |
| **UX-002 randomization** | Implemented random sort + min_years filter for default view |
| **UX-002 performance** | Pre-computed random_order column (~50ms vs 3000ms) |
| **UX-002 true randomization** | WHERE random_order > threshold for different results each time |
| **Supabase timeout** | Split migration into 7 smaller scripts |
| **RLS on materialized views** | Removed - not supported by PostgreSQL |
| **Search not filtering** | Frontend `search` param mapped to backend `q` param |
| **pgbouncer prepared statements** | Disabled statement cache (`statement_cache_size=0`) |
| **Unclear default view** | Show "Random resultaten" instead of count |
| **Search dropdown order** | Ontvangers now shown before Zoektermen |
| **Multi-select filters** | Auto-populated dropdowns for Provincie/Gemeente |
| **TypeScript build error** | Fixed params type in module-page.tsx |

### 3. UX-002: Default View Randomization

Implemented the requirement for randomized results when switching modules.

**Backend changes:**
- Added `sort_by=random` option using `ORDER BY RANDOM()`
- Added `min_years` parameter to filter recipients with data in 4+ years
- Updated all module queries (aggregated view, source table, integraal)

**Frontend changes:**
- Default sort is now `random` instead of `total`
- Tracks if user has explicitly sorted (preserves their choice)
- Resets to random when switching modules
- Passes `min_years=4` for default view

**Files modified:**
- `backend/app/services/modules.py` - Added random sort and min_years filter
- `backend/app/api/v1/modules.py` - Added min_years parameter
- `app/src/components/module-page/module-page.tsx` - Default random, module switch reset
- `app/src/types/api.ts` - Added min_years to query params
- `02-requirements/search-requirements.md` - Clarified randomization triggers

### 4. UX-002: Random Sort Performance Optimization

Fixed performance issue where `ORDER BY RANDOM()` took 3+ seconds.

**Problem:** PostgreSQL RANDOM() requires full table scan and sort (O(n log n)).

**Solution:** Pre-computed `random_order` column in all materialized views.
- Added `RANDOM() AS random_order` to all 7 materialized views
- Added indexes on `random_order` for fast sorting
- Backend now uses `ORDER BY random_order` (~50ms vs 3000ms)
- Random values regenerate on each view refresh (fresh selection after data updates)

**Files created:**
- `scripts/sql/011-add-random-order-to-views.sql` - Migration to add random_order column

**Files modified:**
- `scripts/sql/refresh-all-views.sql` - Added note about random_order regeneration
- `backend/app/services/modules.py` - Changed to ORDER BY random_order

### 5. Migration Script Splitting (Supabase Timeout)

Original migration script timed out in Supabase SQL Editor. Split into 7 smaller scripts:

| Script | View |
|--------|------|
| `011a-random-order-instrumenten.sql` | instrumenten_aggregated |
| `011b-random-order-apparaat.sql` | apparaat_aggregated |
| `011c-random-order-inkoop.sql` | inkoop_aggregated |
| `011d-random-order-provincie.sql` | provincie_aggregated |
| `011e-random-order-gemeente.sql` | gemeente_aggregated |
| `011f-random-order-publiek.sql` | publiek_aggregated |
| `011g-random-order-universal-search.sql` | universal_search |

**Fix:** Removed RLS statements (not supported on materialized views).

### 6. Random Offset Fix (True Randomization)

**Problem:** Pre-computed `random_order` column gave same results each time (not truly random per request).

**Solution:** Use `WHERE random_order > threshold` instead of OFFSET.
- Generate random threshold 0-0.9 on each request
- PostgreSQL uses index to jump directly to position
- Fast (~50ms) AND different results each time

**Files modified:**
- `backend/app/services/modules.py` - Random threshold for aggregated views and integraal

### 7. Created /document Skill

Created `.claude/commands/document.md` for comprehensive session documentation:
- Document all work completed
- Audit documentation for accuracy
- Verify against V1/V2 requirements
- Identify open items and ask questions

### 8. Search Bug Fix (Session 2)

**Problem:** Searching for "bloemen" returned 221,362 results (entire table) instead of filtered results.

**Root cause:** Frontend sent `?search=bloemen` but backend expected `?q=bloemen`.

**Fix:** Map `search` to `q` in `api.ts`:
```typescript
const paramKey = key === 'search' ? 'q' : key
```

### 9. pgbouncer Prepared Statement Fix

**Problem:** 500 errors on provincie/gemeente endpoints with error: "prepared statement already exists".

**Root cause:** asyncpg uses prepared statements by default, but pgbouncer transaction mode (port 6543) doesn't support them because each query can be routed to a different backend connection.

**Fix:** Set `statement_cache_size=0` in `database.py`:
```python
_pool = await asyncpg.create_pool(
    settings.database_url,
    statement_cache_size=0,  # Required for pgbouncer transaction mode
    ...
)
```

### 10. "Random resultaten" Display Message

**Requirement:** Make it clear that default view shows random sample, not full dataset.

**Implementation:**
- Default view (no search, no filters) → "Random resultaten"
- When searching → "293 resultaten voor 'bloemen'"
- When filtering → "1.234 resultaten"

### 11. Search Dropdown Reorder

**Requirement:** Show Ontvangers before Zoektermen in search autocomplete dropdown.

**Implementation:**
- Swapped render order: Ontvangers section first, Zoektermen second
- Updated keyboard navigation index calculation to match new order

### 12. Multi-Select Filters for Provincie/Gemeente (Session 3)

**Requirement:** Auto-populated multi-select dropdowns for Provincie and Gemeente filters.

**Backend changes:**
- New endpoint: `GET /api/v1/modules/{module}/filters/{field}` returns distinct values
- Accept array parameters: `?provincie=Drenthe&provincie=Friesland`
- Uses source table aggregation when filter fields provided (aggregated views don't have filter columns)
- Added `get_filter_options()` function in modules.py service

**Frontend changes:**
- New `MultiSelect` component with search, checkboxes, selection count
- Filter panel supports `multiselect` type filters
- Auto-fetches options from backend on component mount
- Updated `FilterValues` type to support `string[]` values
- API handles array parameters in URL

**Data available:**
- Provincie module: 10 provinces (Drenthe, Friesland, Gelderland, etc.)
- Gemeente module: 13 municipalities (Amsterdam, Rotterdam, Utrecht, etc.)

**Files created/modified:**
- `backend/app/api/v1/modules.py` - New filter endpoint + array params
- `backend/app/services/modules.py` - get_filter_options() + filter_fields support
- `app/src/components/filter-panel/filter-panel.tsx` - MultiSelect component
- `app/src/components/module-page/module-page.tsx` - Pass array filters to API
- `app/src/lib/api.ts` - Handle array params in URL
- `app/src/types/api.ts` - Updated types for array values

---

## Next Steps

[To be completed at /closeday]

---

**Session Status:** In Progress
