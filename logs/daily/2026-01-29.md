# Daily Log - 2026-01-29

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** Phase 1 - V1.0 Development
**Sprint:** Week 6 - User Auth
**Session Duration:** [to be filled]

---

## Summary

**Three major sprints completed:**

### Sprint 1: Code Review & Security Fixes
Comprehensive security audit and code quality improvements across the entire codebase.

**Key accomplishments:**
1. **Security hardening**: SQL injection prevention, XSS sanitization, API key server-side only, generic error messages
2. **TypeScript quality**: Eliminated all `any` types, proper interfaces for API responses
3. **React optimization**: AbortController for race conditions, useMemo for expensive computations
4. **Code organization**: Created shared constants file, eliminated 4x duplication of MODULE_LABELS
5. **Accessibility**: ARIA roles and labels for combobox pattern compliance
6. **Model Selection rule**: Added Golden Rule #5 to CLAUDE.md for cost-effective model usage

**Bug fixes**: Search filtering, pgbouncer compatibility, YoY calculation edge cases, cross-module results API field mismatch

### Sprint 2: Module Filter Enhancements
Complete overhaul of filter configuration for all 7 modules.

**Key accomplishments:**
1. **New filter fields**: Artikelonderdeel, Instrument (Instrumenten), Detail (Apparaat), Staffel (Inkoop)
2. **New filter types**: Added `select` type for dropdown options (Instanties per ontvanger)
3. **Multi-select Organisatie**: Publiek now has multiselect for COA/NWO/RVO/ZonMW
4. **Integraal filters**: Modules per ontvanger (multiselect) + Instanties per ontvanger (dropdown)
5. **Filter order**: Module-specific filters first, Bedrag bereik last
6. **Bug fix**: Numeric column handling in get_filter_options() (staffel INTEGER)

**Deployed & tested**: All filters working on production

**Build verified**: `npm run lint` ✅ and `npm run build` ✅ both pass

### Sprint 3: Entity Resolution & Semantic Search V1.1
Extended entity resolution and implemented Dutch language-aware search with smart ranking.

**Key accomplishments:**
1. **Entity resolution**: Extended `normalize_recipient()` to all 5 module aggregated views (was only universal_search)
2. **Case normalization**: "politie", "Politie", "POLITIE" now merge into single "Politie" row
3. **V1.1a Dutch word rules**: Filter false cognates (-ie/-iek pattern)
4. **V1.1a Option C ranking**: Exact match first, then everything else by totaal (biggest money flows)
5. **V1.1b Roadmap**: Embeddings with Cohere embed-multilingual-v3 (~€1/month)

**Deployed & tested**:
- Entity resolution ✅
- Dutch word rules ✅
- Option C ranking ✅ ("politie" shows Nationale Politie €17.2B near top)

---

## Work Completed

### 1. Added Golden Rules to CLAUDE.md

Reinforced five non-negotiable behaviors that must be automatic:

| Rule | Behavior |
|------|----------|
| **Requirements Check** | Before ANY proposal, verify against V1 and V2 requirements |
| **Documentation Sync** | After ANY change, immediately update all affected docs |
| **Ask, Don't Assume** | When in doubt, stop and ask - never guess |
| **Pre-Commit Audit** | Before EVERY commit, audit docs, requirements, clarity - SHOW audit to user |
| **Model Selection** | Before ANY task, assess complexity and use appropriate model (Haiku/Sonnet/Opus) |

These rules now appear at the top of CLAUDE.md and override all other rules.

### 2. Frontend Code Review & Security Fixes

Comprehensive code review of all frontend components. Fixed critical and high-priority issues.

#### Critical Fixes

| Issue | Fix |
|-------|-----|
| **Typesense API key exposed in client code** | Created backend proxy (`/api/v1/search/autocomplete`), moved all Typesense calls server-side |
| **XSS risk in CSV filename** | Added filename sanitization: `replace(/[^a-zA-Z0-9\s\-_.]/g, '')` |
| **console.error leaking data** | Removed error logging that could expose sensitive data |

#### High/Medium Fixes

| Issue | Fix |
|-------|-----|
| TypeScript `any` types | Added proper `Column<RecipientRow>` and `ColumnMeta` types |
| Header dropdown fragile blur pattern | Replaced with proper `useEffect` for click-outside and Escape key |
| API_BASE_URL duplicated 5 times | Created centralized `lib/api-config.ts`, updated all imports |

#### Accessibility Fixes

| Component | Fix |
|-----------|-----|
| `search-bar.tsx` | Added `aria-label`, `aria-expanded`, `aria-haspopup` to search input |
| `filter-panel.tsx` | Added `aria-label` to min/max bedrag inputs, plus input validation (min >= 0, min <= max) |
| `data-table.tsx` | Added `aria-label` and `aria-expanded` to expand/collapse buttons, sort headers, pagination, export button |

---

## Files Created

| File | Description |
|------|-------------|
| `backend/app/api/v1/search.py` | Typesense proxy endpoint - keeps API key server-side |
| `app/src/lib/api-config.ts` | Centralized API base URL configuration |
| `app/src/lib/constants.ts` | Shared constants (MODULE_LABELS, FIELD_LABELS, ALL_MODULES) |
| `scripts/sql/011-add-random-order-to-views.sql` | Migration: random_order column for fast random sorting |
| `scripts/sql/011a-011g-*.sql` | Split migrations for Supabase timeout (7 files) |
| `.claude/commands/document.md` | /document skill for session documentation |
| `assets/brand/Rijksuitgaven-favicon.svg` | Source favicon (512×512 SVG) |
| `assets/brand/Rijksuitgaven-favicon.png` | Source favicon (PNG format) |
| `assets/brand/Rijksuitgaven-logo-color.png` | Full logo with text + tagline |
| `assets/brand/Rijksuitgaven-logo-white.png` | Icon only (for dark backgrounds) |
| `app/src/app/icon.svg` | Next.js auto-detected favicon |
| `app/src/app/apple-icon.png` | Apple touch icon (180×180) |
| `app/public/logo.png` | Logo for light backgrounds |
| `app/public/logo-white.png` | Logo icon for header |
| `scripts/sql/010-normalize-module-aggregated-views.sql` | Entity resolution for all module views |
| `docs/plans/2026-01-29-semantic-search-design.md` | Semantic search design (V1.1/V2.0) |
| `docs/plans/2026-01-29-visual-refresh-design.md` | Visual refresh design (header, background, table) |
| `app/public/logo-icon.png` | Color icon for header (white background) |

## Files Modified

| File | Changes |
|------|---------|
| `CLAUDE.md` | Added "Golden Rules" section |
| `backend/app/api/v1/__init__.py` | Added search router import |
| `app/src/components/search-bar/search-bar.tsx` | Use backend proxy, added accessibility labels |
| `app/src/components/detail-panel/detail-panel.tsx` | Sanitized filename, removed console.error |
| `app/src/components/data-table/data-table.tsx` | Fixed TypeScript types, added accessibility labels |
| `app/src/components/filter-panel/filter-panel.tsx` | Added min/max validation, accessibility labels |
| `app/src/components/header/header.tsx` | Fixed dropdown: Escape key + click-outside handling |
| `app/src/components/data-table/expanded-row.tsx` | Use centralized API config |
| `app/src/components/cross-module-results/cross-module-results.tsx` | Use centralized API config |
| `app/src/lib/api.ts` | Use centralized API config |
| `scripts/sql/refresh-all-views.sql` | Added note about random_order regeneration |
| `backend/app/services/modules.py` | ORDER BY random_order for fast random sorting |
| `app/src/lib/api.ts` | Map `search` to `q` for backend API (bug fix) |
| `app/src/types/api.ts` | Added comment for search→q mapping |
| `backend/app/services/database.py` | Disabled prepared statement cache for pgbouncer |
| `app/src/components/module-page/module-page.tsx` | Show "Random resultaten" for default view |
| `app/src/components/search-bar/search-bar.tsx` | Reorder: Ontvangers before Zoektermen |
| `app/src/components/filter-panel/filter-panel.tsx` | Added `select` filter type, reordered filters, all module configs |
| `backend/app/api/v1/modules.py` | Added source, modules, min_instanties parameters |
| `backend/app/services/modules.py` | Integraal filters, numeric column fix in get_filter_options(), search relevance ranking |
| `docs/plans/2026-01-29-search-relevance-ranking.md` | Design document for search relevance ranking |
| `02-requirements/backlog.md` | Added "Search on Other Fields" backlog item |
| `app/src/components/filter-panel/filter-panel.tsx` | Full autocomplete redesign: module-specific search, two-section dropdown |
| `app/src/components/header/header.tsx` | Removed SearchBar, added logo image with Next.js Image component |
| `docs/plans/2026-01-29-search-bar-consolidation.md` | Design document for search bar consolidation |
| `app/src/components/filter-panel/filter-panel.tsx` | Removed year filter dropdown (Session 9) |
| `app/src/components/module-page/module-page.tsx` | Removed availableYears prop from FilterPanel |
| `backend/app/services/modules.py` | V1.1 Dutch word rules: `build_search_condition()` helper for -ie/-iek exclusion |
| `docs/plans/2026-01-29-semantic-search-design.md` | Updated V1.1 status to implemented |
| `02-requirements/backlog.md` | Updated semantic search item with V1.1 completion |
| `app/src/app/globals.css` | Visual refresh: page background #E1EAF2, added --totaal-bg variable |
| `app/src/components/header/header.tsx` | Visual refresh: complete rewrite with 2-row compact layout, grouped tabs |
| `app/src/components/data-table/data-table.tsx` | Visual refresh: navy header, Totaal column styling with background tint |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Typesense API key exposed | Backend proxy, key stays server-side only |
| XSS risk in CSV download | Filename sanitization |
| TypeScript `any` usage | Proper typing with Column and ColumnMeta |
| Header dropdown UX bugs | Proper event handlers for Escape and click-outside |
| Duplicated API_BASE_URL | Centralized config file |
| Typesense API key rotation | New key deployed, backend proxy working |
| Railway private networking | Added to backlog - public URL works |
| Missing accessibility labels | Added aria-labels to search, filter, table buttons |
| Filter input validation | Added min/max validation for bedrag range filters |
| **UX-002 randomization** | Implemented random sort + min_years filter for default view |
| **Search relevance ranking** | Option C: Exact match first, then everything else by totaal |
| **asyncpg parameter mismatch** | count_params snapshot before adding relevance param |
| **UX-002 performance** | Pre-computed random_order column (~50ms vs 3000ms) |
| **UX-002 true randomization** | WHERE random_order > threshold for different results each time |
| **Two search bars** | Consolidated to one in filter panel with full autocomplete |
| **Autocomplete showing global results** | Redesigned to show module-specific results (industry standard) |
| **"Ook in" showing current module** | Filter out current module from badges |
| **Enter key not closing dropdown** | Added blur and close on Enter without selection |
| **Confusing "/" shortcut tip** | Removed from UI |
| **Supabase timeout** | Split migration into 7 smaller scripts |
| **RLS on materialized views** | Removed - not supported by PostgreSQL |
| **Search not filtering** | Frontend `search` param mapped to backend `q` param |
| **pgbouncer prepared statements** | Disabled statement cache (`statement_cache_size=0`) |
| **Unclear default view** | Show "Random resultaten" instead of count |
| **Search dropdown order** | Ontvangers now shown before Zoektermen |
| **Multi-select filters** | Auto-populated dropdowns for Provincie/Gemeente |
| **TypeScript build error** | Fixed params type in module-page.tsx |
| **Redundant year filter** | Removed "Alle jaren" dropdown - year columns already visible in table |
| **False cognate matches** | V1.1 Dutch word rules: "politie" no longer matches "Politieke" |
| **Big entities buried in search** | Option C ranking: exact first, then by totaal - "Nationale Politie" now near top |
| **Header logo broken on white bg** | Used `logo-icon.png` (color) instead of `logo-white.png` (designed for dark bg) |

### 3. UX-002: Default View Randomization

Implemented the requirement for randomized results when switching modules.

**Backend changes:**
- Added `sort_by=random` option using `ORDER BY RANDOM()`
- Added `min_years` parameter to filter recipients with data in 4+ years
- Updated all module queries (aggregated view, source table, integraal)

**Frontend changes:**
- Default sort is now `random` instead of `total`
- Tracks if user has explicitly sorted (preserves their choice)
- Resets to random when switching modules
- Passes `min_years=4` for default view

**Files modified:**
- `backend/app/services/modules.py` - Added random sort and min_years filter
- `backend/app/api/v1/modules.py` - Added min_years parameter
- `app/src/components/module-page/module-page.tsx` - Default random, module switch reset
- `app/src/types/api.ts` - Added min_years to query params
- `02-requirements/search-requirements.md` - Clarified randomization triggers

### 4. UX-002: Random Sort Performance Optimization

Fixed performance issue where `ORDER BY RANDOM()` took 3+ seconds.

**Problem:** PostgreSQL RANDOM() requires full table scan and sort (O(n log n)).

**Solution:** Pre-computed `random_order` column in all materialized views.
- Added `RANDOM() AS random_order` to all 7 materialized views
- Added indexes on `random_order` for fast sorting
- Backend now uses `ORDER BY random_order` (~50ms vs 3000ms)
- Random values regenerate on each view refresh (fresh selection after data updates)

**Files created:**
- `scripts/sql/011-add-random-order-to-views.sql` - Migration to add random_order column

**Files modified:**
- `scripts/sql/refresh-all-views.sql` - Added note about random_order regeneration
- `backend/app/services/modules.py` - Changed to ORDER BY random_order

### 5. Migration Script Splitting (Supabase Timeout)

Original migration script timed out in Supabase SQL Editor. Split into 7 smaller scripts:

| Script | View |
|--------|------|
| `011a-random-order-instrumenten.sql` | instrumenten_aggregated |
| `011b-random-order-apparaat.sql` | apparaat_aggregated |
| `011c-random-order-inkoop.sql` | inkoop_aggregated |
| `011d-random-order-provincie.sql` | provincie_aggregated |
| `011e-random-order-gemeente.sql` | gemeente_aggregated |
| `011f-random-order-publiek.sql` | publiek_aggregated |
| `011g-random-order-universal-search.sql` | universal_search |

**Fix:** Removed RLS statements (not supported on materialized views).

### 6. Random Offset Fix (True Randomization)

**Problem:** Pre-computed `random_order` column gave same results each time (not truly random per request).

**Solution:** Use `WHERE random_order > threshold` instead of OFFSET.
- Generate random threshold 0-0.9 on each request
- PostgreSQL uses index to jump directly to position
- Fast (~50ms) AND different results each time

**Files modified:**
- `backend/app/services/modules.py` - Random threshold for aggregated views and integraal

### 7. Created /document Skill

Created `.claude/commands/document.md` for comprehensive session documentation:
- Document all work completed
- Audit documentation for accuracy
- Verify against V1/V2 requirements
- Identify open items and ask questions

### 8. Search Bug Fix (Session 2)

**Problem:** Searching for "bloemen" returned 221,362 results (entire table) instead of filtered results.

**Root cause:** Frontend sent `?search=bloemen` but backend expected `?q=bloemen`.

**Fix:** Map `search` to `q` in `api.ts`:
```typescript
const paramKey = key === 'search' ? 'q' : key
```

### 9. pgbouncer Prepared Statement Fix

**Problem:** 500 errors on provincie/gemeente endpoints with error: "prepared statement already exists".

**Root cause:** asyncpg uses prepared statements by default, but pgbouncer transaction mode (port 6543) doesn't support them because each query can be routed to a different backend connection.

**Fix:** Set `statement_cache_size=0` in `database.py`:
```python
_pool = await asyncpg.create_pool(
    settings.database_url,
    statement_cache_size=0,  # Required for pgbouncer transaction mode
    ...
)
```

### 10. "Random resultaten" Display Message

**Requirement:** Make it clear that default view shows random sample, not full dataset.

**Implementation:**
- Default view (no search, no filters) → "Random resultaten"
- When searching → "293 resultaten voor 'bloemen'"
- When filtering → "1.234 resultaten"

### 11. Search Dropdown Reorder

**Requirement:** Show Ontvangers before Zoektermen in search autocomplete dropdown.

**Implementation:**
- Swapped render order: Ontvangers section first, Zoektermen second
- Updated keyboard navigation index calculation to match new order

### 12. Multi-Select Filters for Provincie/Gemeente (Session 3)

**Requirement:** Auto-populated multi-select dropdowns for Provincie and Gemeente filters.

**Backend changes:**
- New endpoint: `GET /api/v1/modules/{module}/filters/{field}` returns distinct values
- Accept array parameters: `?provincie=Drenthe&provincie=Friesland`
- Uses source table aggregation when filter fields provided (aggregated views don't have filter columns)
- Added `get_filter_options()` function in modules.py service

**Frontend changes:**
- New `MultiSelect` component with search, checkboxes, selection count
- Filter panel supports `multiselect` type filters
- Auto-fetches options from backend on component mount
- Updated `FilterValues` type to support `string[]` values
- API handles array parameters in URL

**Data available:**
- Provincie module: 10 provinces (Drenthe, Friesland, Gelderland, etc.)
- Gemeente module: 13 municipalities (Amsterdam, Rotterdam, Utrecht, etc.)

**Files created/modified:**
- `backend/app/api/v1/modules.py` - New filter endpoint + array params
- `backend/app/services/modules.py` - get_filter_options() + filter_fields support
- `app/src/components/filter-panel/filter-panel.tsx` - MultiSelect component
- `app/src/components/module-page/module-page.tsx` - Pass array filters to API
- `app/src/lib/api.ts` - Handle array params in URL
- `app/src/types/api.ts` - Updated types for array values

### 13. Code Review Fixes (Session 4)

Comprehensive code review identified CRITICAL, HIGH, MEDIUM, and LOW severity issues. Fixed all CRITICAL issues:

#### Backend Security Fixes

| Issue | Fix |
|-------|-----|
| SQL injection via identifiers | Added `validate_identifier()` whitelist in modules.py |
| Error messages exposing internals | Changed to generic messages, log details server-side |
| Debug logging in production | Removed config logging from search.py |

**Files modified:**
- `backend/app/services/modules.py` - SQL identifier validation
- `backend/app/api/v1/modules.py` - Safe error messages
- `backend/app/api/v1/search.py` - Removed debug logging, safe errors

#### Frontend Fixes

| Issue | Fix |
|-------|-----|
| Race conditions in useEffect | Added AbortController to expanded-row.tsx, module-page.tsx |
| Silent error handling | Added error logging to search-bar.tsx catch blocks |
| YoY calculation with NaN/Infinity | Added `Number.isFinite()` validation in format.ts |

**Files modified:**
- `app/src/components/data-table/expanded-row.tsx` - AbortController
- `app/src/components/module-page/module-page.tsx` - AbortController
- `app/src/lib/api.ts` - Accept AbortSignal parameter
- `app/src/lib/format.ts` - YoY validation
- `app/src/components/search-bar/search-bar.tsx` - Error logging

### 14. HIGH Priority Fixes (Session 4 continued)

Fixed HIGH priority issues from code review:

#### TypeScript Improvements

| File | Fix |
|------|-----|
| `detail-panel.tsx` | Added `ApiDetailRow` interface, removed `any` types |
| `detail-panel.tsx` | Added AbortController and error logging |

#### React Hooks Optimization

| File | Fix |
|------|-----|
| `search-bar.tsx` | Wrapped `allResults` in useMemo |
| `filter-panel.tsx` | Wrapped `moduleFilters` in useMemo |
| `data-table.tsx` | Added missing `onRowClick` to useMemo deps |
| `cookie-banner.tsx` | Fixed SSR pattern with proper null state |

#### Accessibility Fixes

| File | Fix |
|------|-----|
| `search-bar.tsx` | Added `role="combobox"`, `aria-controls`, `aria-autocomplete` |
| `search-bar.tsx` | Added `role="listbox"` to dropdown |
| `search-bar.tsx` | Escaped quotes with `&ldquo;`/`&rdquo;` |

#### Cleanup

| File | Fix |
|------|-----|
| `column-selector.tsx` | Removed unused `useEffect` import |
| `data-table.tsx` | Removed unused `getPaginationRowModel`, `Row` imports |
| `data-table.tsx` | Removed unused `index` parameter |
| `expanded-row.tsx` | Removed unused `YearAmount` import |
| `module-page.tsx` | Removed unused `DEFAULT_FILTERS` constant |

### 15. MEDIUM Priority Fixes (Session 4 continued)

#### Code Duplication Elimination

Created shared constants file and removed duplicated constants:

| Constant | Duplicated In | Now In |
|----------|---------------|--------|
| `MODULE_LABELS` | search-bar, cross-module-results, detail-panel, expanded-row | `lib/constants.ts` |
| `FIELD_LABELS` | detail-panel | `lib/constants.ts` |
| `ALL_MODULES` | cross-module-results | `lib/constants.ts` |

**Files created:**
- `app/src/lib/constants.ts` - Shared constants for modules, labels

**Files modified:**
- `app/src/components/search-bar/search-bar.tsx` - Import from constants
- `app/src/components/cross-module-results/cross-module-results.tsx` - Import from constants, fix API response field
- `app/src/components/detail-panel/detail-panel.tsx` - Import from constants
- `app/src/components/data-table/expanded-row.tsx` - Import MODULE_LABELS from constants

#### Bug Fixes

| Issue | Fix |
|-------|-----|
| `cross-module-results.tsx` using wrong API field | Changed `data.pagination?.totalRows` to `data.meta?.total` |
| Silent error handling in cross-module fetch | Added error logging with module context |

### 16. LOW Priority Fixes (Session 4 continued)

Fixed LOW priority code quality issues from code review:

#### Magic Numbers → Named Constants

| File | Constants Added |
|------|----------------|
| `lib/format.ts` | `ANOMALY_THRESHOLD_PERCENT = 10`, `LARGE_AMOUNT_CHAR_THRESHOLD = 10` |
| `filter-panel.tsx` | `FILTER_DEBOUNCE_MS = 300` |
| `data-table.tsx` | `STICKY_PRIMARY_OFFSET_PX = 40` |

#### JSDoc Comments Added

Added comprehensive JSDoc comments to all exported functions and components:

| File | Components/Functions Documented |
|------|--------------------------------|
| `data-table.tsx` | `DataTable`, `generateCSV`, `downloadCSV` |
| `expanded-row.tsx` | `ExpandedRow` |
| `filter-panel.tsx` | `FilterPanel` |
| `module-page.tsx` | `ModulePage` |
| `lib/api.ts` | `fetchModules`, `fetchModuleData`, `fetchDetailData` |

#### Code Style Improvements

| Issue | Fix |
|-------|-----|
| Hardcoded `left-10` Tailwind class | Changed to dynamic style with `STICKY_PRIMARY_OFFSET_PX` |
| Inconsistent comment style | Added descriptive comments for constants |

**Files modified:**
- `app/src/lib/format.ts` - Named constants for thresholds
- `app/src/components/filter-panel/filter-panel.tsx` - Debounce constant
- `app/src/components/data-table/data-table.tsx` - Sticky offset constant, JSDoc comments
- `app/src/components/data-table/expanded-row.tsx` - JSDoc comments
- `app/src/components/module-page/module-page.tsx` - JSDoc comments
- `app/src/lib/api.ts` - JSDoc comments with parameter descriptions

**Verification:**
- `npm run lint` - ✅ No errors
- `npm run build` - ✅ Build successful

### 17. Search Bar Consolidation (Session 6)

Merged two search bars into one unified search experience.

**Problem:** Two search bars existed:
1. Header search bar - Global autocomplete with Ontvangers + Zoektermen
2. Filter panel search bar - Simple text input for module filtering

**Solution:** Consolidated to one search bar in the filter panel with full autocomplete functionality.

**Design decisions documented:**
- Location: Filter panel (removed from header)
- Functionality: Global autocomplete (Ontvangers + Zoektermen)
- Behavior: Global search, filter current module
- "Ook in" badges: Clickable - navigate to that module with search
- Clear search: X button (standard pattern)
- Dropdown close: Immediately on selection

**Implementation:**

| Component | Changes |
|-----------|---------|
| `filter-panel.tsx` | +429 lines - Full autocomplete with Typesense integration |
| `header.tsx` | Removed SearchBar import and both desktop/mobile usages |

**Features added to filter panel:**
- Autocomplete dropdown with Ontvangers + Zoektermen sections
- Clickable "Ook in" module badges (navigate to `/module?q=search`)
- Keyboard navigation (arrows, Enter, Escape)
- "/" shortcut to focus search
- URL parameter support (`?q=ProRail`)
- Clear button (X) when text is entered
- 150ms debounce for autocomplete

**Design document:** `docs/plans/2026-01-29-search-bar-consolidation.md`

**Build verified:** ✅ `npm run build` passes

### 18. Autocomplete UX Redesign (Session 7)

Major redesign of autocomplete behavior based on UX review and industry standards.

**Problem identified:**
1. Autocomplete showed global results even when on a specific module page
2. Results in dropdown didn't match what Enter produced (violation of "what you see is what you get" principle)
3. "Ook in" badges showed the current module (redundant)
4. "/" shortcut tip was confusing to users

**Solution (industry standard UX):**
1. Autocomplete now searches the SAME data as the table (module-specific)
2. Two-section dropdown design:
   - "Ontvangers in [Module]" - recipients from current module with amounts
   - "Ook in andere modules" - recipients in other modules with module badges
3. Enter key closes dropdown and shows table results
4. Removed confusing "/" shortcut tip

**Backend changes:**
- New endpoint: `GET /api/v1/modules/{module}/autocomplete`
- Returns `current_module` (list with name + totaal) and `other_modules` (list with name + modules)
- Filters out current module from "other modules" section using module name variants mapping

**Frontend changes:**
- Replaced Typesense global search with module-specific PostgreSQL endpoint
- Two-section dropdown with clear visual separation
- Enter key behavior: closes dropdown, blurs input, shows table results
- Removed "/" keyboard shortcut tip

**Files modified:**
- `backend/app/services/modules.py` - Added `get_module_autocomplete()` and `get_integraal_autocomplete()`
- `backend/app/api/v1/modules.py` - Added `/modules/{module}/autocomplete` endpoint with new response models
- `app/src/components/filter-panel/filter-panel.tsx` - Complete rewrite of autocomplete dropdown logic

**Bug fixes:**
| Bug | Fix |
|-----|-----|
| "Ook in" showing current module | Filter `result.sources?.filter(s => s !== module)` |
| Module name variants not matching | Added `module_display_names` mapping (handles "instrumenten" vs "Financiële instrumenten") |
| Enter not closing dropdown | Added `else` branch to close dropdown and blur input |

### 20. Brand Assets Distribution (Session 8)

Set up brand assets workflow and distributed logo/favicon files to Next.js app.

**Workflow established:**
- Source folder: `assets/brand/` - founder drops design files here
- Claude distributes to correct Next.js locations

**Assets processed:**

| Source File | Destination | Purpose |
|-------------|-------------|---------|
| `Rijksuitgaven-favicon.svg` | `app/src/app/icon.svg` | Browser favicon (auto-detected by Next.js) |
| `Rijksuitgaven-favicon.png` | `app/src/app/apple-icon.png` | Apple touch icon (resized to 180×180) |
| `Rijksuitgaven-logo-color.png` | `app/public/logo.png` | Full logo for light backgrounds |
| `Rijksuitgaven-logo-white.png` | `app/public/logo-white.png` | Icon only for dark backgrounds (header) |

**Header update:**
- Added logo icon (36×36) from `logo-white.png`
- "Rijksuitgaven" text hidden on mobile (shows only icon)
- Used Next.js `Image` component with `priority` for LCP optimization

**Cleanup:**
- Removed default Next.js placeholder assets (file.svg, globe.svg, next.svg, vercel.svg, window.svg)
- Removed old favicon.ico

**Build verified:** ✅ Next.js auto-detected `icon.svg` and `apple-icon.png`

### 22. Search Relevance Ranking (Session 9)

Implemented relevance-based ranking for search results so exact matches appear first.

**Problem:** Searching "politie" showed "Politiehonddresseervereniging..." before "Politie" (€6.5B).

**Solution:** Ranking priority with amount tiebreaker:

| Priority | Match Type | Example for "politie" |
|----------|-----------|----------------------|
| 1 | Exact match | "Politie" |
| 2 | Starts with | "Politieacademie" |
| 3 | Word boundary | "VTS POLITIE NEDERLAND" |
| 4 | Contains | "Het Oude Politiebureau" |

**Implementation:** PostgreSQL CASE expression in ORDER BY:
```sql
CASE
    WHEN UPPER(ontvanger) = UPPER($search) THEN 1
    WHEN UPPER(ontvanger) LIKE UPPER($search) || '%' THEN 2
    WHEN UPPER(ontvanger) LIKE '% ' || UPPER($search) || '%' THEN 3
    ELSE 4
END AS relevance_score
ORDER BY relevance_score ASC, totaal DESC
```

**Bug fixes during implementation:**
1. **Random sort overriding relevance:** Reordered conditions so `if search:` is checked BEFORE `elif sort_by == "random":`
2. **500 error from asyncpg:** `count_params` was including the relevance parameter, but count query only uses WHERE params. Fixed by taking snapshot of params before adding relevance param.

**Files modified:**
- `backend/app/services/modules.py` - Added relevance_score to `_get_from_aggregated_view`, `_get_from_source_table`, `get_integraal_data`, autocomplete functions

**Design document:** `docs/plans/2026-01-29-search-relevance-ranking.md`

**Backlog item added:** "Search on Other Fields" - when search matches Regeling/Omschrijving (not Ontvanger), show why result matched. Deferred to UI/UX sprint.

**Deployed & tested:** ✅ "politie" search now shows exact matches first

### 23. Remove Year Filter Dropdown (Session 9)

Removed the "Alle jaren" dropdown from filter panel.

**Rationale:**
- Year columns are always visible in the table (2016-2024)
- Users can sort by any year column to see top recipients for that year
- The dropdown was redundant with the visual year data

**Files modified:**
- `app/src/components/filter-panel/filter-panel.tsx` - Removed year dropdown, `handleYearChange`, `availableYears` prop
- `app/src/components/module-page/module-page.tsx` - Removed `availableYears` prop from FilterPanel

**Build verified:** ✅

### 21. Module Filter Enhancements (Session 5)

Comprehensive filter configuration for all modules with new fields and reordered layouts.

#### Filter Order Change

Changed expanded filters to show module-specific filters FIRST, Bedrag bereik LAST.

#### Per-Module Filter Configuration

| Module | Filters (in order) |
|--------|-------------------|
| **Instrumenten** | Begrotingsnaam, Artikel, Artikelonderdeel (NEW), Instrument (NEW), Regeling, Bedrag |
| **Apparaat** | Begrotingsnaam, Artikel, Detail (NEW), Bedrag |
| **Inkoop** | Ministerie, Categorie, Staffel (NEW), Bedrag |
| **Provincie** | Provincie (multiselect), Bedrag |
| **Gemeente** | Gemeente (multiselect), Beleidsterrein, Bedrag |
| **Publiek** | Organisatie (NEW multiselect), Regeling, Bedrag |
| **Integraal** | Modules per ontvanger (NEW multiselect), Instanties per ontvanger (NEW dropdown), Bedrag |

#### New Filter Types

| Type | Usage |
|------|-------|
| `text` | Standard text input (default) |
| `multiselect` | Dropdown with checkboxes, fetches options from API |
| `select` | Simple dropdown with predefined options |

#### Backend Changes

**New parameters added to API:**
- `source` - Multi-select for Publiek Organisatie filter
- `modules` - Multi-select for Integraal "Modules per ontvanger" filter
- `min_instanties` - Dropdown for Integraal "Instanties per ontvanger" (2+, 3+, 5+, 10+)

**New filter fields added:**
- Inkoop: `staffel`
- Apparaat: `detail`
- Instrumenten: `artikelonderdeel`, `instrument`

**Bug fix:**
- `get_filter_options()` now casts columns to text for uniform handling of numeric columns (fixed staffel INTEGER issue)

#### Files Modified

| File | Changes |
|------|---------|
| `app/src/components/filter-panel/filter-panel.tsx` | Added `select` filter type, reordered expanded filters, updated all module configs |
| `backend/app/api/v1/modules.py` | Added `source`, `modules`, `min_instanties` parameters, updated integraal filter endpoint |
| `backend/app/services/modules.py` | Added filter_modules and min_instanties to get_integraal_data(), fixed get_filter_options() for numeric columns |

#### Deployment & Testing

All filters deployed and tested:

| Filter | Status | Test Result |
|--------|--------|-------------|
| Integraal modules | ✅ | 6 module options returned |
| Integraal min_instanties=5 | ✅ | 53 recipients with 5+ sources |
| Integraal modules=Instrumenten&Publiek | ✅ | 16,659 recipients in BOTH |
| Publiek source (Organisatie) | ✅ | COA, NWO, RVO, ZonMW options |
| Inkoop staffel | ✅ | Values 1-13 returned |
| Instrumenten artikelonderdeel | ✅ | 585 options |
| Apparaat detail | ✅ | Multiple options |

### 24. Entity Resolution: Module Views (Session 10)

Extended entity resolution to all module aggregated views. Previously only `universal_search` (integraal) was normalized.

**Problem:** Case variations appeared as separate rows:
- "politie", "Politie", "POLITIE" → 3 rows with separate totals
- "Politieke beweging DENK" → 4 rows with different casing

**Solution:** Rebuild all module aggregated views with:
1. `GROUP BY normalize_recipient(primary_field)` - merges case variants
2. `UPPER(LEFT(MIN(name), 1)) || SUBSTRING(MIN(name) FROM 2)` - capitalize first letter for display
3. Include `random_order` column for UX-002

**Views updated:**
| View | Primary Field | Status |
|------|---------------|--------|
| `instrumenten_aggregated` | ontvanger | ✅ Done |
| `inkoop_aggregated` | leverancier | ✅ Done |
| `provincie_aggregated` | ontvanger | ✅ Done |
| `gemeente_aggregated` | ontvanger | ✅ Done |
| `publiek_aggregated` | ontvanger | ✅ Done |
| `apparaat_aggregated` | kostensoort | Not needed (category, not recipient) |

**Migration script:** `scripts/sql/010-normalize-module-aggregated-views.sql`

**Files created/modified:**
- `scripts/sql/010-normalize-module-aggregated-views.sql` - Complete migration script
- `02-requirements/backlog.md` - Updated priority to V1.0

**Result:**
- "politie", "Politie", "POLITIE" → 1 row ("Politie") with combined total
- Display name always starts with capital letter
- All 5 recipient-based modules normalized

---

### 25. Semantic Search Design & V1.1 Implementation (Session 10)

Brainstormed semantic search improvements and implemented V1.1 Dutch word rules.

**Problem:** "politie" (police) matches "Politieke" (political) - different domains, same prefix.

**Solutions Designed:**

| Version | Approach | Status |
|---------|----------|--------|
| V1.1 | Dutch word rules (-ie/-iek exclusion) | ✅ Implemented |
| V2.0 | Embeddings (Cohere embed-multilingual-v3) | Planned |

**V1.1a Implementation (COMPLETE):**
- Dutch word rules: `build_search_condition()` helper excludes -ie/-iek false cognates
- Option C ranking: Exact match first, then everything else sorted by totaal
- Applied to all 6 search locations ✅
- Example: "politie" → Politie (exact, €34.2B), then Nationale Politie (€17.2B), then rest by amount

**V1.1b Roadmap (Embeddings):**
- Vendor: Cohere embed-multilingual-v3 (native Dutch support)
- Cost: ~€0.90 one-time (9M tokens), ~€1/month
- Uses pgvector (already enabled in Supabase)

**Design document:** `docs/plans/2026-01-29-semantic-search-design.md`

---

### 26. Visual Refresh: WordPress Design Alignment (Session 11)

Aligned V1.0 visual design with WordPress production site through comprehensive header redesign, page background, and table styling updates.

**Design Specification Document:** `docs/plans/2026-01-29-visual-refresh-design.md`

#### Header Redesign

Reduced from 3-row layout (~140px) to compact 2-row design (~100px):

**Row 1 - Main Header (56px):**
| Element | Specification |
|---------|---------------|
| Background | White `#FFFFFF` |
| Logo | 32×32px icon + "Rijksuitgaven" text |
| Tagline | "Snel inzicht voor krachtige analyses" in pink |
| Right side | Profiel / Logout links (V1.0) |

**Row 2 - Module Tabs (44px):**
| Element | Specification |
|---------|---------------|
| Background | `#E1EAF2` (Gray Light) |
| Active tab | White with subtle shadow |
| Inactive tab | Gray Light hover |
| Tab grouping | Visual gaps separate module groups |

**Tab Grouping Logic:**
```
[Integraal]  32px  [Instrumenten][Provincie][Gemeente][Inkoop][Publiek]  32px  [Apparaat]
```

- Integraal: Cross-module discovery (entry point)
- 5 main modules: Recipient-based data sources
- Apparaat: Different data type (costs, not recipients)

**Mobile Behavior:** Horizontal scroll with `scrollbar-hide`, touch/swipe navigation

#### Page Background

| Element | Before | After |
|---------|--------|-------|
| Body background | White `#FFFFFF` | `#E1EAF2` (Gray Light) |
| Content cards | - | White for contrast |

#### Table Styling

**Header Row:**
| Property | Value |
|----------|-------|
| Background | `#0E3261` (Navy Dark) |
| Text color | White |
| Font | Semibold, 12px |

**Totaal Column:**
| Property | Value |
|----------|-------|
| Header | Slightly lighter navy (`#436FA3`) |
| Cell background | `#D0DEEA` (subtle blue tint) |
| Cell text | Bold/semibold |

**Files Modified:**

| File | Changes |
|------|---------|
| `app/src/app/globals.css` | Added `--totaal-bg: #D0DEEA`, set `--background: #E1EAF2` |
| `app/src/components/header/header.tsx` | Complete rewrite: 2-row layout, grouped tabs with gaps |
| `app/src/components/data-table/data-table.tsx` | Navy header (`bg-[var(--navy-dark)]`), Totaal column styling |

**Build verified:** ✅ `npm run build` passes

#### Logo Fix

**Issue:** Header showed broken logo on white background - `logo-white.png` designed for dark backgrounds.

**Fix:** Created `logo-icon.png` (color favicon) for header use on white background.

| File | Purpose |
|------|---------|
| `app/public/logo-icon.png` | Color icon for header (white background) |
| `app/public/logo-white.png` | White icon for dark backgrounds |

---

## Next Steps

1. **Week 6 - User Auth** - Continue with Magic Link authentication setup
2. **User migration** - Import 50 existing users from WordPress
3. **Overzicht page** - Module totals overview page
4. **Beta testing** - Prepare for 5-user beta test

---

**Session Status:** Complete
