# Daily Log — 2026-02-19

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 8 — Marketing Pages & Final Polish (Day 3)
**Session Duration:** In progress

---

## Summary

Email campaign system built end-to-end across 2 sessions. Session 1: Resend Audiences API migration to new Contacts API, sync engine, segment management, admin page. Session 2: Self-service campaign sending with branded unsubscribe — replaced Resend Dashboard workflow with own compose UI, batch API sending, opaque unsubscribe tokens, webhook sync. First campaign email sent successfully.

---

## Work Completed

### Session 1: Email Campaign Sync (6 commits)
1. **Resend contact sync engine** — `resend-audience.ts` rewritten: `computeListType()` classifies contacts into 3 segments (leden/churned/prospects), `backfillResendAudience()` does full reconciliation with sequential processing (600ms delay for free plan 2 req/s limit), auto-recovery of stale contacts
2. **`/team/mail` admin page** — 3 count cards (Leden/Prospects/Churned), sync button with inline success/error feedback
3. **BFF endpoint** — `GET /api/v1/team/mail` (list counts from Supabase), `POST /api/v1/team/mail` (trigger backfill, admin-only with CSRF)
4. **Ongoing sync triggers** — member create (→ leden segment), contact create (→ prospects), contact update (→ prospects), member update (→ computed segment), member delete/cancel (→ churned)
5. **TeamNav** — added "E-mail" tab
6. **Branded campaign template** — HTML email template at `assets/email-templates/campaign-template.html`

### Session 2: Self-Service Campaigns + Branded Unsubscribe (1 commit)
1. **Compose UI** — `/team/mail` rewritten: subject, heading, body, optional CTA, segment selector (Leden/Prospects/Churned/Iedereen), recipient count, preview panel, confirm+send flow
2. **Batch send endpoint** — `POST /api/v1/team/mail/send`: queries people by segment, renders per-recipient HTML via `campaign-template.ts`, sends via `resend.batch.send()` (100/call), includes `List-Unsubscribe` + `List-Unsubscribe-Post` headers (RFC 8058)
3. **Branded unsubscribe page** — `/afmelden?token=UUID`: public, no auth, opaque token (no email in URL), branded design matching login/verlopen pages, always returns success (no enumeration)
4. **Unsubscribe API** — `POST /api/v1/unsubscribe`: token lookup, Resend contact removal, `unsubscribed_at` timestamp, rate limited (10/min/IP)
5. **Resend webhook** — `POST /api/v1/webhooks/resend`: Svix signature verification, syncs Gmail header unsubscribes back to DB
6. **GDPR guard** — `backfillResendAudience()` skips unsubscribed people, removes them from Resend if still present
7. **Campaign template function** — `campaign-template.ts`: server-side HTML renderer with per-recipient personalization
8. **SQL migration 058** — `unsubscribe_token` (UUID) + `unsubscribed_at` on `people` table

### Resend API Migration
- Discovered Resend Audiences API is deprecated in SDK v6.9 — migrated to new Contacts API (no `audienceId`, direct `segments` array on create)
- Removed `RESEND_AUDIENCE_ID` env var dependency entirely
- Replaced Resend Dashboard broadcast workflow with own Batch API sending (enables per-recipient tokens)

### Security Review
- Expert adversarial review caught P0 issues: unsigned email in URL, two-path sync divergence, GDPR re-subscribe risk
- Resolved: opaque UUID tokens, webhook for header unsubscribes, `unsubscribed_at` guard in backfill

### Design Document
- Full email campaign design at `docs/plans/2026-02-19-email-campaign-design.md`

---

## Files Created

| File | Description |
|------|-------------|
| `app/src/app/api/v1/team/mail/route.ts` | BFF: GET list counts, POST backfill sync |
| `app/src/app/api/v1/team/mail/send/route.ts` | Campaign batch send via Resend API |
| `app/src/app/api/v1/unsubscribe/route.ts` | Public unsubscribe endpoint (token-based) |
| `app/src/app/api/v1/webhooks/resend/route.ts` | Resend webhook handler (Svix verified) |
| `app/src/app/api/_lib/campaign-template.ts` | Server-side campaign HTML renderer |
| `app/src/app/afmelden/page.tsx` | Branded unsubscribe page (public) |
| `assets/email-templates/campaign-template.html` | Reference HTML template |
| `docs/plans/2026-02-19-email-campaign-design.md` | Full design document |
| `scripts/sql/058-unsubscribe.sql` | unsubscribe_token + unsubscribed_at on people |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/app/api/_lib/resend-audience.ts` | Full rewrite: 3 segments, new Contacts API, sequential sync, stale recovery, unsubscribed_at guard |
| `app/src/app/api/v1/team/leden/route.ts` | POST: pass list type to syncPersonToResend |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | PATCH: Resend sync with computed segment. DELETE: sync as churned |
| `app/src/app/api/v1/team/contacten/route.ts` | POST: pass 'prospects' to syncPersonToResend |
| `app/src/app/api/v1/team/contacten/[id]/route.ts` | PATCH: pass 'prospects' to syncPersonToResend |
| `app/src/components/team-nav/team-nav.tsx` | Added "E-mail" tab |
| `app/src/app/team/mail/page.tsx` | Rewritten: compose UI with segment selector, preview, confirm+send |
| `app/src/lib/supabase/middleware.ts` | Added /afmelden as public path |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Resend API key restricted to send-only | User created full-access API key |
| `audienceId` not found — Audiences deprecated | Migrated to new Contacts API without audienceId |
| `segments` param not supported on `contacts.update` | Removed from update calls (SDK limitation) |
| Rate limiting (2 req/s free plan) | Sequential with 600ms delay |
| Stale `resend_contact_id` after manual Resend cleanup | Auto-detect "Contact not found", clear stale ID, recreate |
| Resend unsubscribe page ugly/off-brand | Built custom /afmelden with opaque tokens |
| Email in unsubscribe URL = security risk | Opaque UUID tokens, no email exposed |
| Gmail header unsubscribe doesn't sync | Resend webhook for contact.updated events |
| Backfill re-adds unsubscribed people (GDPR) | unsubscribed_at guard in backfillResendAudience() |
| useSearchParams needs Suspense boundary | Wrapped in Suspense with loading fallback |

---

## Environment Changes

| Variable | Action | Service |
|----------|--------|---------|
| `RESEND_SEGMENT_LEDEN` | Added | Railway frontend |
| `RESEND_SEGMENT_CHURNED` | Added | Railway frontend |
| `RESEND_SEGMENT_PROSPECTS` | Added | Railway frontend |
| `RESEND_AUDIENCE_ID` | Removed | Railway frontend |
| `RESEND_WEBHOOK_SECRET` | Added | Railway frontend |

---

## SQL Migrations

| Migration | Description | Executed |
|-----------|-------------|----------|
| `058-unsubscribe.sql` | `unsubscribe_token` UUID + `unsubscribed_at` TIMESTAMPTZ on people | Yes |

---

### Session 3: WYSIWYG Editor + Variable Support (1 commit)
1. **Tiptap WYSIWYG editor** — `components/email-editor/email-editor.tsx`: toolbar with Bold, Italic, Bullet list, Ordered list, Link, Image, Voornaam variable, Undo/Redo
2. **`{{voornaam}}` variable** — toolbar button inserts placeholder, backend replaces per-recipient (fallback: "lezer")
3. **Email-safe inline styles** — `addEmailStyles()` in campaign-template.ts converts Tiptap HTML tags to inline styles for email client compatibility
4. **Preview update** — renders formatted HTML with `{{voornaam}}` → sample name
5. **Tiptap editor styles** — globals.css with placeholder text

## Files Created (Session 3)

| File | Description |
|------|-------------|
| `app/src/components/email-editor/email-editor.tsx` | Tiptap WYSIWYG editor with formatting toolbar |

## Files Modified (Session 3)

| File | Changes |
|------|---------|
| `app/src/app/team/mail/page.tsx` | Textarea → EmailEditor, HTML preview with variable substitution |
| `app/src/app/api/_lib/campaign-template.ts` | bodyToHtml → addEmailStyles + replaceVariables for WYSIWYG HTML |
| `app/src/app/globals.css` | Tiptap editor styles + placeholder |
| `app/package.json` | +@tiptap/react, starter-kit, extension-image, extension-link |

---

## Next Steps

- Continue V0.9 beta launch prep

---

**Commits:** 10 (6 session 1 + 2 docs + 1 session 2 + 1 session 3)
**Session Status:** In Progress
