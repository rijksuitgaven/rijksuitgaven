# Daily Log — 2026-02-19

**Project:** Rijksuitgaven.nl SaaS Migration
**Phase:** V1.0 Development
**Sprint:** Week 8 — Marketing Pages & Final Polish (Day 3)
**Session Duration:** In progress

---

## Summary

Email campaign system built end-to-end across 6 sessions. Session 1: Resend Audiences API migration to new Contacts API, sync engine, segment management, admin page. Session 2: Self-service campaign sending with branded unsubscribe — replaced Resend Dashboard workflow with own compose UI, batch API sending, opaque unsubscribe tokens, webhook sync. First campaign email sent successfully. Session 3: Tiptap WYSIWYG editor with {{voornaam}} variable. Session 4: Preheader, full-fidelity preview (server-rendered iframe), image upload/delete via Supabase Storage, campaign history with template reuse. Session 5: Campaign analytics — open/click/bounce tracking via Resend webhooks, per-recipient drill-down, privacy policy update, V1.1 deferred items. Session 6: UX polish — sub-tabs (Nieuw bericht / Campagnes), removed Sync Resend (auto-sync via CRUD), removed afmelden logo, added campaign delete with confirmation.

---

## Work Completed

### Session 1: Email Campaign Sync (6 commits)
1. **Resend contact sync engine** — `resend-audience.ts` rewritten: `computeListType()` classifies contacts into 3 segments (leden/churned/prospects), `backfillResendAudience()` does full reconciliation with sequential processing (600ms delay for free plan 2 req/s limit), auto-recovery of stale contacts
2. **`/team/mail` admin page** — 3 count cards (Leden/Prospects/Churned), sync button with inline success/error feedback
3. **BFF endpoint** — `GET /api/v1/team/mail` (list counts from Supabase), `POST /api/v1/team/mail` (trigger backfill, admin-only with CSRF)
4. **Ongoing sync triggers** — member create (→ leden segment), contact create (→ prospects), contact update (→ prospects), member update (→ computed segment), member delete/cancel (→ churned)
5. **TeamNav** — added "E-mail" tab
6. **Branded campaign template** — HTML email template at `assets/email-templates/campaign-template.html`

### Session 2: Self-Service Campaigns + Branded Unsubscribe (1 commit)
1. **Compose UI** — `/team/mail` rewritten: subject, heading, body, optional CTA, segment selector (Leden/Prospects/Churned/Iedereen), recipient count, preview panel, confirm+send flow
2. **Batch send endpoint** — `POST /api/v1/team/mail/send`: queries people by segment, renders per-recipient HTML via `campaign-template.ts`, sends via `resend.batch.send()` (100/call), includes `List-Unsubscribe` + `List-Unsubscribe-Post` headers (RFC 8058)
3. **Branded unsubscribe page** — `/afmelden?token=UUID`: public, no auth, opaque token (no email in URL), branded design matching login/verlopen pages, always returns success (no enumeration)
4. **Unsubscribe API** — `POST /api/v1/unsubscribe`: token lookup, Resend contact removal, `unsubscribed_at` timestamp, rate limited (10/min/IP)
5. **Resend webhook** — `POST /api/v1/webhooks/resend`: Svix signature verification, syncs Gmail header unsubscribes back to DB
6. **GDPR guard** — `backfillResendAudience()` skips unsubscribed people, removes them from Resend if still present
7. **Campaign template function** — `campaign-template.ts`: server-side HTML renderer with per-recipient personalization
8. **SQL migration 058** — `unsubscribe_token` (UUID) + `unsubscribed_at` on `people` table

### Resend API Migration
- Discovered Resend Audiences API is deprecated in SDK v6.9 — migrated to new Contacts API (no `audienceId`, direct `segments` array on create)
- Removed `RESEND_AUDIENCE_ID` env var dependency entirely
- Replaced Resend Dashboard broadcast workflow with own Batch API sending (enables per-recipient tokens)

### Security Review
- Expert adversarial review caught P0 issues: unsigned email in URL, two-path sync divergence, GDPR re-subscribe risk
- Resolved: opaque UUID tokens, webhook for header unsubscribes, `unsubscribed_at` guard in backfill

### Design Document
- Full email campaign design at `docs/plans/2026-02-19-email-campaign-design.md`

---

## Files Created

| File | Description |
|------|-------------|
| `app/src/app/api/v1/team/mail/route.ts` | BFF: GET list counts, POST backfill sync |
| `app/src/app/api/v1/team/mail/send/route.ts` | Campaign batch send via Resend API |
| `app/src/app/api/v1/unsubscribe/route.ts` | Public unsubscribe endpoint (token-based) |
| `app/src/app/api/v1/webhooks/resend/route.ts` | Resend webhook handler (Svix verified) |
| `app/src/app/api/_lib/campaign-template.ts` | Server-side campaign HTML renderer |
| `app/src/app/afmelden/page.tsx` | Branded unsubscribe page (public) |
| `assets/email-templates/campaign-template.html` | Reference HTML template |
| `docs/plans/2026-02-19-email-campaign-design.md` | Full design document |
| `scripts/sql/058-unsubscribe.sql` | unsubscribe_token + unsubscribed_at on people |

## Files Modified

| File | Changes |
|------|---------|
| `app/src/app/api/_lib/resend-audience.ts` | Full rewrite: 3 segments, new Contacts API, sequential sync, stale recovery, unsubscribed_at guard |
| `app/src/app/api/v1/team/leden/route.ts` | POST: pass list type to syncPersonToResend |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | PATCH: Resend sync with computed segment. DELETE: sync as churned |
| `app/src/app/api/v1/team/contacten/route.ts` | POST: pass 'prospects' to syncPersonToResend |
| `app/src/app/api/v1/team/contacten/[id]/route.ts` | PATCH: pass 'prospects' to syncPersonToResend |
| `app/src/components/team-nav/team-nav.tsx` | Added "E-mail" tab |
| `app/src/app/team/mail/page.tsx` | Rewritten: compose UI with segment selector, preview, confirm+send |
| `app/src/lib/supabase/middleware.ts` | Added /afmelden as public path |

---

## Issues Resolved

| Issue | Solution |
|-------|----------|
| Resend API key restricted to send-only | User created full-access API key |
| `audienceId` not found — Audiences deprecated | Migrated to new Contacts API without audienceId |
| `segments` param not supported on `contacts.update` | Removed from update calls (SDK limitation) |
| Rate limiting (2 req/s free plan) | Sequential with 600ms delay |
| Stale `resend_contact_id` after manual Resend cleanup | Auto-detect "Contact not found", clear stale ID, recreate |
| Resend unsubscribe page ugly/off-brand | Built custom /afmelden with opaque tokens |
| Email in unsubscribe URL = security risk | Opaque UUID tokens, no email exposed |
| Gmail header unsubscribe doesn't sync | Resend webhook for contact.updated events |
| Backfill re-adds unsubscribed people (GDPR) | unsubscribed_at guard in backfillResendAudience() |
| useSearchParams needs Suspense boundary | Wrapped in Suspense with loading fallback |

---

## Environment Changes

| Variable | Action | Service |
|----------|--------|---------|
| `RESEND_SEGMENT_LEDEN` | Added | Railway frontend |
| `RESEND_SEGMENT_CHURNED` | Added | Railway frontend |
| `RESEND_SEGMENT_PROSPECTS` | Added | Railway frontend |
| `RESEND_AUDIENCE_ID` | Removed | Railway frontend |
| `RESEND_WEBHOOK_SECRET` | Added | Railway frontend |

---

## SQL Migrations

| Migration | Description | Executed |
|-----------|-------------|----------|
| `058-unsubscribe.sql` | `unsubscribe_token` UUID + `unsubscribed_at` TIMESTAMPTZ on people | Yes |

---

### Session 3: WYSIWYG Editor + Variable Support (1 commit)
1. **Tiptap WYSIWYG editor** — `components/email-editor/email-editor.tsx`: toolbar with Bold, Italic, Bullet list, Ordered list, Link, Image, Voornaam variable, Undo/Redo
2. **`{{voornaam}}` variable** — toolbar button inserts placeholder, backend replaces per-recipient (fallback: "lezer")
3. **Email-safe inline styles** — `addEmailStyles()` in campaign-template.ts converts Tiptap HTML tags to inline styles for email client compatibility
4. **Preview update** — renders formatted HTML with `{{voornaam}}` → sample name
5. **Tiptap editor styles** — globals.css with placeholder text

## Files Created (Session 3)

| File | Description |
|------|-------------|
| `app/src/components/email-editor/email-editor.tsx` | Tiptap WYSIWYG editor with formatting toolbar |

## Files Modified (Session 3)

| File | Changes |
|------|---------|
| `app/src/app/team/mail/page.tsx` | Textarea → EmailEditor, HTML preview with variable substitution |
| `app/src/app/api/_lib/campaign-template.ts` | bodyToHtml → addEmailStyles + replaceVariables for WYSIWYG HTML |
| `app/src/app/globals.css` | Tiptap editor styles + placeholder |
| `app/package.json` | +@tiptap/react, starter-kit, extension-image, extension-link |

---

### Session 4: Preheader + Preview + Image Upload + Campaign History (1 commit)
1. **Preheader field** — optional field in compose form, hidden `display:none` div in email HTML (compatible with Gmail, Outlook, Apple Mail), max 150 chars, `&zwnj;&nbsp;` spacer to prevent body text leaking into preview
2. **Full-fidelity preview** — `POST /api/v1/team/mail/preview` renders exact HTML via `campaign-template.ts` with sample data (firstName: "Michiel"), displayed in sandboxed `<iframe>` with `srcDoc` — shows logo, full template, pink CTA, footer
3. **Image upload/delete** — `POST /api/v1/team/mail/upload` uploads to Supabase Storage `email-images` bucket (public, 2MB max, JPEG/PNG/GIF/WebP), `DELETE /api/v1/team/mail/upload?filename=xxx` removes images. Editor toolbar: file picker replaces URL prompt, uploaded images shown as 64px thumbnails with hover-to-delete
4. **Campaign history** — migration 059 (`campaigns` table), `GET /api/v1/team/mail/campaigns` endpoint (last 50), "Verzonden" section on mail page with date/segment/sent count, "Sjabloon" button loads all fields into compose form
5. **Send endpoint updated** — passes preheader to renderer, saves campaign to DB after send (non-fatal if save fails), gets user ID from session for `sent_by`

## Files Created (Session 4)

| File | Description |
|------|-------------|
| `app/src/app/api/v1/team/mail/campaigns/route.ts` | Campaign history GET endpoint |
| `app/src/app/api/v1/team/mail/preview/route.ts` | Server-rendered email preview |
| `app/src/app/api/v1/team/mail/upload/route.ts` | Image upload + delete (Supabase Storage) |
| `scripts/sql/059-campaigns.sql` | Campaigns table for send history |

## Files Modified (Session 4)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/mail/send/route.ts` | +preheader param, save campaign to DB after send |
| `app/src/app/api/_lib/campaign-template.ts` | Preheader support (hidden div + zwnj spacer) |
| `app/src/components/email-editor/email-editor.tsx` | File picker upload, uploaded images thumbnails with delete |
| `app/src/app/team/mail/page.tsx` | Preheader field, iframe preview, campaign history with template reuse |

## SQL Migrations (Session 4)

| Migration | Description | Executed |
|-----------|-------------|----------|
| `059-campaigns.sql` | campaigns table (subject, heading, preheader, body, cta, segment, counts, sent_by) | **Not yet** |

---

### Session 5: Campaign Analytics — Open/Click/Bounce Tracking (1 commit)
1. **Campaign events table** — migration 060: `campaign_events` table (campaign_id FK, person_id FK, email, event_type, link_url, resend_email_id, occurred_at). Dedup via unique index `(resend_email_id, event_type)`. Indexes on campaign_id+event_type and person_id.
2. **Send endpoint refactor** — save campaign BEFORE sending (was after) to get UUID for Resend tags. Each batch email tagged with `campaign_id` via `tags: [{ name: 'campaign_id', value: campaignId }]`. Post-send updates actual sent/failed counts.
3. **Resend webhook expansion** — 5 new email event types: `email.delivered`, `email.opened`, `email.clicked`, `email.bounced`, `email.complained`. Looks up `campaign_id` from `data.tags`, `person_id` from email lookup. Dedup via 23505 constraint catch.
4. **Campaign detail endpoint** — `GET /api/v1/team/mail/campaigns/[id]`: aggregated stats (delivered/opened/clicked/bounced/complained unique counts) + per-recipient breakdown with first-occurrence timestamps, person name enrichment, unsubscribe status.
5. **Campaign list enrichment** — campaigns route now fetches all events for returned campaigns, builds unique-recipient counts per type using Sets, returns delivered/opened/clicked/bounced counts inline.
6. **Frontend campaign analytics** — expandable campaign rows with inline engagement stats (open %, click %, bounce count). Per-recipient detail table showing delivered/opened/clicked times with status indicators. Apple MPP footnote about unreliable open rates.
7. **Privacy policy update** — added email analytics under legitimate interest (Art. 6(1)(f)): "het meten van bezorg-, open- en klikpercentages van e-mailcampagnes ter verbetering van onze communicatie"
8. **V1.1 backlog items** — 3 deferred items: bounce auto-suppress after 3 consecutive bounces, complaint auto-unsubscribe (webhook → unsubscribed_at), event retention cleanup (90-day DELETE cron)

### Expert Panel
- 5-member team: Email Deliverability Specialist (Elena), Webhook Systems Architect (Daan), Privacy/GDPR Engineer (Yuki), Frontend Analytics Designer (Marco), Adversarial Strategist (Sofia)
- Resend API research: 11 event types confirmed, NO `email.unsubscribed` (use `contact.updated`), tags flow through to webhooks, open tracking via 1x1 pixel (unreliable due to Apple MPP ~50%), click tracking via link rewriting (reliable)
- Key decisions: open rates as "indicatief" not KPI, click rate as primary engagement metric, unique recipients not raw events

## Files Created (Session 5)

| File | Description |
|------|-------------|
| `scripts/sql/060-campaign-events.sql` | Campaign event tracking table with dedup index |
| `app/src/app/api/v1/team/mail/campaigns/[id]/route.ts` | Campaign detail with per-recipient events |

## Files Modified (Session 5)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/mail/send/route.ts` | Save-first + campaign_id tags on each batch email |
| `app/src/app/api/v1/webhooks/resend/route.ts` | 5 new email event types → campaign_events insert |
| `app/src/app/api/v1/team/mail/campaigns/route.ts` | Enriched with aggregated open/click/bounce counts |
| `app/src/app/team/mail/page.tsx` | Expandable campaign rows, per-recipient detail table |
| `app/src/app/privacybeleid/page.tsx` | Email analytics added to legitimate interest |
| `02-requirements/backlog.md` | 3 V1.1 deferred items (bounce suppress, complaint unsub, retention) |

## SQL Migrations (Session 5)

| Migration | Description | Executed |
|-----------|-------------|----------|
| `060-campaign-events.sql` | campaign_events table with dedup index + FK indexes | **Not yet** |

---

### Session 6: UX Polish — Sub-tabs + Cleanup (3 commits)
1. **Sub-tab navigation** — `/team/mail` split into "Nieuw bericht" (compose) and "Campagnes" (history + analytics) tabs. Pill-style toggle below shared count cards. "Sjabloon" button switches to compose tab automatically.
2. **Removed Sync Resend** — button, state, handler, and `resend_contacts` field removed. Sync is automatic via CRUD triggers (leden/contacten endpoints).
3. **Removed afmelden logo** — logo removed from both Suspense fallback and main content on `/afmelden` page.
4. **Campaign delete** — `DELETE /api/v1/team/mail/campaigns/[id]` endpoint (admin-only, cascade deletes events). Trash icon button with inline "Verwijder / Annuleer" confirmation in campaign row.

## Files Modified (Session 6)

| File | Changes |
|------|---------|
| `app/src/app/team/mail/page.tsx` | Sub-tabs, removed sync section, added delete button with confirmation |
| `app/src/app/afmelden/page.tsx` | Removed logo from Suspense fallback + main content |
| `app/src/app/api/v1/team/mail/campaigns/[id]/route.ts` | Added DELETE handler (cascade to campaign_events) |

---

### Session 7: CRM Pipeline Stages (1 commit)
1. **Expert panel brainstorm** — 5-person team (CRM Architect, Product Strategist, Data Model Engineer, Solo Founder Advocate, Adversarial Strategist). 10 rounds of discussion: evolved from 4 stages to 6 stages based on exit type distinctions.
2. **6 pipeline stages on `people.pipeline_stage`** — `nieuw`, `in_gesprek`, `gewonnen`, `afgesloten`, `verloren`, `ex_klant`. Replaces computed type system (prospect/churned/gearchiveerd).
3. **Migration 061** — `pipeline_stage` column (NOT NULL DEFAULT 'nieuw'), `lost_reason` text, index. Data migration: `archived_at` → afgesloten, active subs → gewonnen, cancelled/deleted subs → ex_klant.
4. **Automatic transitions** — Convert to member → `gewonnen`, Soft-delete member → `ex_klant`.
5. **Contacten page redesign** — Color-coded stage badges (blue/purple/green/stone/amber/gray), edit modal with clickable stage selector pills, conditional `lost_reason` field, stats bar per stage.
6. **Dashboard pipeline card** — Pipeline summary on `/team` with per-stage counts and colored dots, link to /team/contacten.
7. **Key design decision** — Pipeline (sales state) and email (unsubscribed_at) are independent axes. Pipeline stage NEVER affects email eligibility.

## Files Created (Session 7)

| File | Description |
|------|-------------|
| `scripts/sql/061-pipeline-stage.sql` | pipeline_stage + lost_reason columns with data migration |

## Files Modified (Session 7)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/contacten/route.ts` | GET returns pipeline_stage directly, removed computed type |
| `app/src/app/api/v1/team/contacten/[id]/route.ts` | PATCH accepts pipeline_stage + lost_reason |
| `app/src/app/api/v1/team/contacten/[id]/convert/route.ts` | Sets pipeline_stage = 'gewonnen' on convert |
| `app/src/app/api/v1/team/leden/[id]/route.ts` | DELETE sets pipeline_stage = 'ex_klant' |
| `app/src/app/team/contacten/page.tsx` | Full redesign with stage badges, edit modal, stats bar |
| `app/src/app/team/page.tsx` | Added pipeline card with per-stage counts |

## SQL Migrations (Session 7)

| Migration | Description | Executed |
|-----------|-------------|----------|
| `061-pipeline-stage.sql` | pipeline_stage + lost_reason on people, data migration | Yes |

---

### Session 8: Email Multi-Select Pipeline Targeting (1 commit)
1. **Expert panel** — same 5-person team. Key discovery: Resend Broadcasts not used — we send via `resend.batch.send()`, so all targeting logic is ours (no Resend API limitation).
2. **Replaced subscription-based segments** — old: Leden/Prospects/Churned/Iedereen. New: Nieuw, In gesprek, Leden (maandelijks), Leden (jaarlijks), Verloren, Ex-klant.
3. **Multi-select checkboxes** — replaces single dropdown. Multiple segments selectable per campaign. Counts shown inline per checkbox.
4. **Leden split** — "Leden (maandelijks)" / "Leden (jaarlijks)" based on active subscription plan, enables upsell targeting.
5. **Afgesloten excluded** — didn't qualify, not worth emailing. No "Iedereen" option.
6. **Campaign storage** — segments stored as comma-separated string. Campaign history shows pills per segment.
7. **`archived_at` + `unsubscribed_at`** — still hard-exclude from all sends regardless of pipeline stage.

## Files Modified (Session 8)

| File | Changes |
|------|---------|
| `app/src/app/api/v1/team/mail/route.ts` | GET returns pipeline-based counts (6 segments) |
| `app/src/app/api/v1/team/mail/send/route.ts` | Accepts segments[] array, filters by pipeline_stage + plan |
| `app/src/app/team/mail/page.tsx` | Multi-select checkboxes, removed count cards, segment pills on campaigns |

---

## Next Steps

- Continue V0.9 beta launch prep
- Enable open+click tracking in Resend Dashboard (if not already done)

---

**Commits:** 19 (6 session 1 + 2 docs + 1 session 2 + 1 session 3 + 1 docs + 1 session 4 + 1 docs + 1 session 5 + 1 docs + 3 session 6 + 1 session 7 + 1 session 8)
**Session Status:** Complete
